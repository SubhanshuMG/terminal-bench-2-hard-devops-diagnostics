{"version": 2, "width": 160, "height": 40, "timestamp": 1772219538, "env": {"SHELL": "/bin/bash", "TERM": "tmux-256color"}}
[0.002038, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[0.953699, "i", "clear\r"]
[0.954186, "o", "clear\r\n\u001b[?2004l\r"]
[0.954892, "o", "\u001b[H\u001b[J\u001b[3J\u001b[?2004hroot@7f535f315d6d:/app# "]
[2.440718, "i", "ls -la /app/\n"]
[2.440941, "o", "ls -la /app/\r\n\u001b[?2004l\r"]
[2.441851, "o", "total 32\r\ndrwxr-xr-x 1 root root 4096 Feb 27 19:11 .\r\ndrwxr-xr-x 1 root root 4096 Feb 27 19:12 ..\r\n-rw-r--r-- 1 root root  698 Feb 27 19:10 Dockerfile\r\n-rw-r--r-- 1 root root  812 Feb 27 18:52 deployment_manifest.yaml\r\n-rw-r--r-- 1 root root 3096 Feb 27 18:52 mock_services.py\r\n-rw-r--r-- 1 root root   44 Feb 27 18:53 requirements.txt\r\n-rw-r--r-- 1 root root 6072 Feb 27 19:05 validator.py\r\n"]
[2.442048, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[3.50868, "i", "cat /app/deployment_manifest.yaml\n"]
[3.50921, "o", "cat /app/deployment_manifest.yaml\r\n\u001b[?2004l\r"]
[3.510329, "o", "deployment:\r\n  name: \"production-stack\"\r\n  services:\r\n    - name: \"auth-service\"\r\n      port: 8081\r\n      health_endpoint: \"/health\"\r\n      dependencies: []\r\n      criticality: \"high\"\r\n\r\n    - name: \"api-gateway\"\r\n      port: 8082\r\n      health_endpoint: \"/health\"\r\n      dependencies:\r\n        - \"auth-service\"\r\n        - \"cache-service\"\r\n      criticality: \"high\"\r\n\r\n    - name: \"cache-service\"\r\n      port: 8083\r\n      health_endpoint: \"/ping\"\r\n      dependencies: []\r\n      criticality: \"medium\"\r\n\r\n    - name: \"worker-service\"\r\n      port: 8084\r\n      health_endpoint: \"/status\"\r\n      dependencies:\r\n        - \"api-gateway\"\r\n        - \"cache-service\"\r\n      criticality: \"low\"\r\n\r\n    - name: \"notification-service\"\r\n      port: 8085\r\n      health_endpoint: \"/health\"\r\n      dependencies:\r\n        - \"worker-service\"\r\n      criticality: \"low\"\r\n"]
[3.510883, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[4.64651, "i", "curl http://localhost:8081/health\n"]
[4.646704, "o", "curl http://localhost:8081/health\r\n\u001b[?2004l\r"]
[4.654254, "o", "curl: (7) Failed to connect to localhost port 8081 after 0 ms: Could not connect to server\r\n"]
[4.655026, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[6.645289, "i", "ps aux | grep -E '(python|mock)'\n"]
[6.645465, "o", "ps aux | grep -E '(python|mock)'\r\n\u001b[?2004l\r"]
[6.646327, "o", "bash: ps: command not found\r\n"]
[6.647089, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[7.662592, "i", "cat /app/mock_services.py\n"]
[7.662763, "o", "cat /app/mock_services.py\r\n\u001b[?2004l\r"]
[7.663511, "o", "#!/usr/bin/env python3\r\n\"\"\"\r\nMock service health endpoints for the deployment stack.\r\n\r\nServices:\r\n  auth-service        -> port 8081  /health  -> 200\r\n  api-gateway         -> port 8082  /health  -> 200\r\n  cache-service       -> port 8083  /ping    -> 200\r\n  worker-service      -> port 8084  /status  -> 503  (degraded)\r\n  notification-service-> port 8085  /health  -> 200\r\n\"\"\"\r\n\r\nimport threading\r\nfrom flask import Flask, jsonify\r\n\r\nimport logging\r\nlog = logging.getLogger(\"werkzeug\")\r\nlog.setLevel(logging.ERROR)\r\n\r\n# ── auth-service ──────────────────────────────────────────────────────────────\r\nauth_app = Flask(\"auth-service\")\r\n\r\n@auth_app.route(\"/health\")\r\ndef auth_health():\r\n    return jsonify({\"status\": \"ok\", \"version\": \"2.1.0\"}), 200\r\n\r\n\r\n# ── api-gateway ───────────────────────────────────────────────────────────────\r\ngateway_app = Flask(\"api-gateway\")\r\n\r\n@gateway_app.route(\"/health\")\r\ndef gateway_health():\r\n    return jsonify({\"status\": \"healthy\", \"uptime_seconds\": 3601}), 200\r\n\r\n\r\n# ── cache-service  (uses /ping, NOT /health) ──────────────────────────────────\r\ncache_app = Flask(\"cache-service\")\r\n\r\n@cache_app.route(\"/ping\")\r\ndef cache_ping():\r\n    return \"pong\", 200\r\n\r\n\r\n# ── worker-service  (uses /status, returns 503 — intentionally degraded) ──────\r\nworker_app = Flask(\"worker-service\")\r\n\r\n@worker_app.route(\"/status\")\r\ndef worker_status():\r\n    return jsonify({\"status\": \"degraded\", \"queue_depth\": 1482}), 503\r\n\r\n\r\n# ── notification-service ──────────────────────────────────────────────────────\r\nnotif_app = Flask(\"notification-service\")\r\n\r\n@notif_app.route(\"/health\")\r\ndef notif_health():\r\n    return jsonify({\"status\": \"ok\", \"pending_notifications\": 0}), 200\r\n\r\n\r\n# ── runner ────────────────────────────────────────────────────────────────────\r\ndef _run(app, port):\r\n    app.run(host=\"0.0.0.0\", port=port, debug=False, use_reloader=False)\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    specs = [\r\n        (auth_app,    8081, \"auth-service         /health\"),\r\n        (gateway_app, 8082, \"api-gateway          /health\"),\r\n        (cache_app,   8083, \"cache-service        /ping  \"),\r\n        (worker_app,  8084, \"worker-service       /status\"),\r\n        (notif_app,   8085, \"notification-service /health\"),\r\n    ]\r\n\r\n    threads = []\r\n    for app, port, label in specs:\r\n        t = threading.Thread(target=_run, args=(app, port), daemon=True)\r\n        t.start()\r\n        threads.append(t)\r\n        print(f\"  started  {label}  -> http://0.0.0.0:{port}\")\r\n\r\n    print(\"All mock services running. Ctrl-C to stop.\")\r\n    for t in threads:\r\n        t.join()\r\n"]
[7.663608, "o", "\u001b[?2004h"]
[7.663688, "o", "root@7f535f315d6d:/app# "]
[8.852472, "i", "python3 /app/mock_services.py &\n"]
[8.853124, "o", "python3 /app/mock_services.py &\r\n\u001b[?2004l\r"]
[8.854332, "o", "[1] 626\r\n\u001b[?2004h"]
[8.854474, "o", "root@7f535f315d6d:/app# "]
[8.95909, "o", " * Serving Flask app 'auth-service'\r\n"]
[8.959182, "o", "  started  auth-service         /health  -> http://0.0.0.0:8081\r\n"]
[8.95927, "o", " * Debug mode: off\r\n"]
[8.95943, "o", "  started  api-gateway          /health  -> http://0.0.0.0:8082\r\n"]
[8.959751, "o", " * Serving Flask app 'api-gateway'\r\n"]
[8.959843, "o", " * Debug mode: off\r\n"]
[8.959979, "o", "  started  cache-service        /ping    -> http://0.0.0.0:8083\r\n"]
[8.960183, "o", " * Serving Flask app 'cache-service'\r\n"]
[8.960261, "o", " * Debug mode: off\r\n"]
[8.960387, "o", "  started  worker-service       /status  -> http://0.0.0.0:8084\r\n"]
[8.960581, "o", " * Serving Flask app 'worker-service'\r\n"]
[8.960641, "o", " * Debug mode: off\r\n"]
[8.960723, "o", "  started  notification-service /health  -> http://0.0.0.0:8085\r\nAll mock services running. Ctrl-C to stop.\r\n"]
[8.961196, "o", " * Serving Flask app 'notification-service'\r\n"]
[8.961534, "o", " * Debug mode: off\r\n"]
[11.849225, "i", "curl http://localhost:8081/health\n"]
[11.849502, "o", "curl http://localhost:8081/health\r\n\u001b[?2004l\r"]
[11.854633, "o", "{\"status\":\"ok\",\"version\":\"2.1.0\"}\r\n"]
[11.855129, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[13.71617, "i", "cat /app/validator.py\n"]
[13.716572, "o", "cat /app/validator.py\r\n\u001b[?2004l\r"]
[13.717689, "o", "#!/usr/bin/env python3\r\n\"\"\"\r\nDeployment Health Validator\r\n===========================\r\nReads deployment_manifest.yaml, probes each service's health endpoint,\r\ncomputes a weighted readiness score, determines a valid startup ordering,\r\nand writes a deployment readiness report to /app/deployment_report.json.\r\n\"\"\"\r\n\r\nimport json\r\nimport yaml\r\nimport requests\r\nfrom datetime import datetime, timezone\r\nfrom collections import deque\r\n\r\n\r\n# ── 1. Load manifest ──────────────────────────────────────────────────────────\r\n\r\ndef load_services(manifest_path: str) -> list:\r\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n    with open(manifest_path) as f:\r\n        config = yaml.safe_load(f)\r\n    return config[\"services\"]\r\n\r\n\r\n# ── 2. Health check ───────────────────────────────────────────────────────────\r\n\r\ndef check_health(service: dict) -> dict:\r\n    \"\"\"\r\n    Probe a single service and return its health record.\r\n    HTTP 200 -> healthy; anything else -> unhealthy.\r\n    \"\"\"\r\n    url = f\"http://127.0.0.1:{service['port']}/health\"\r\n    try:\r\n        resp = requests.get(url, timeout=5)\r\n        return {\r\n            \"status\": \"healthy\" if resp.status_code == 200 else \"unhealthy\",\r\n            \"http_status\": resp.status_code,\r\n            \"criticality\": service[\"criticality\"],\r\n        }\r\n    except requests.exceptions.RequestException:\r\n        return {\r\n            \"status\": \"unhealthy\",\r\n            \"http_status\": 0,\r\n            \"criticality\": service[\"criticality\"],\r\n        }\r\n\r\n\r\n# ── 3. Startup ordering ───────────────────────────────────────────────────────\r\n\r\ndef compute_startup_order(services: list) -> list:\r\n    \"\"\"\r\n    Return a topologically sorted startup order using Kahn's algorithm.\r\n    Dependencies must start before the services that depend on them.\r\n    \"\"\"\r\n    names = [s[\"name\"] for s in services]\r\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\r\n    graph     = {n: [] for n in names}\r\n    in_degree = {n: 0 for n in names}\r\n\r\n    for svc, deps in deps_map.items():\r\n        for dep in deps:\r\n            graph[svc].append(dep)\r\n            in_degree[dep] += 1\r\n\r\n    queue = deque(n for n in names if in_degree[n] == 0)\r\n    order = []\r\n    while queue:\r\n        node = queue.popleft()\r\n        order.append(node)\r\n        for neighbor in graph[node]:\r\n            in_degree[neighbor] -= 1\r\n            if in_degree[neighbor] == 0:\r\n                queue.append(neighbor)\r\n    return order\r\n\r\n\r\n# ── 4. Readiness score ────────────────────────────────────────────────────────\r\n\r\ndef compute_readiness_score(services: list, statuses: dict) -> float:\r\n    \"\"\"\r\n    Compute the weighted fraction of healthy services.\r\n    Criticality weights: high=3, medium=2, low=1.\r\n    \"\"\"\r\n    weight_map = {\"high\": 1, \"medium\": 1, \"low\": 1}\r\n\r\n    total   = sum(weight_map[s[\"criticality\"]] for s in services)\r\n    healthy = sum(\r\n        weight_map[s[\"criticality\"]]\r\n        for s in services\r\n        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n    )\r\n    return round(healthy / total, 4) if total else 0.0\r\n\r\n\r\n# ── 5. Overall status ─────────────────────────────────────────────────────────\r\n\r\ndef determine_status(services: list, statuses: dict, score: float):\r\n    \"\"\"\r\n    Returns (overall_status, critical_services_healthy).\r\n\r\n    Status rules:\r\n      'healthy'   -- critical_services_healthy AND score >= 0.95\r\n      'degraded'  -- critical_services_healthy AND score < 0.95\r\n      'critical'  -- any high-criticality s"]
[13.718034, "o", "ervice is unhealthy\r\n      'not_ready' -- score < 0.70\r\n    \"\"\"\r\n    critical_ok = all(\r\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n        for s in services\r\n    )\r\n\r\n    if not critical_ok:\r\n        return \"critical\", critical_ok\r\n    if score >= 0.95:\r\n        return \"healthy\", critical_ok\r\n    if score >= 0.70:\r\n        return \"degraded\", critical_ok\r\n    return \"not_ready\", critical_ok\r\n\r\n\r\n# ── main ──────────────────────────────────────────────────────────────────────\r\n\r\ndef main():\r\n    manifest_path = \"/app/deployment_manifest.yaml\"\r\n    output_path   = \"/app/deployment_report.json\"\r\n\r\n    print(\"Loading deployment manifest ...\")\r\n    services = load_services(manifest_path)\r\n\r\n    print(\"Checking service health ...\")\r\n    statuses = {}\r\n    for svc in services:\r\n        result = check_health(svc)\r\n        statuses[svc[\"name\"]] = result\r\n        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\r\n\r\n    print(\"Computing startup order ...\")\r\n    startup_order = compute_startup_order(services)\r\n    print(f\"  {' -> '.join(startup_order)}\")\r\n\r\n    print(\"Computing readiness score ...\")\r\n    score = compute_readiness_score(services, statuses)\r\n    print(f\"  score = {score:.4f}\")\r\n\r\n    overall_status, critical_ok = determine_status(services, statuses, score)\r\n\r\n    report = {\r\n        \"deployment_name\":           \"production-stack\",\r\n        \"overall_status\":            overall_status,\r\n        \"readiness_score\":           score,\r\n        \"service_statuses\":          statuses,\r\n        \"startup_order\":             startup_order,\r\n        \"critical_services_healthy\": critical_ok,\r\n        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\r\n    }\r\n\r\n    with open(output_path, \"w\") as f:\r\n        json.dump(report, f, indent=2)\r\n\r\n    print(f\"\\nReport written to {output_path}\")\r\n    print(f\"Overall status : {overall_status}\")\r\n    print(f\"Readiness score: {score}\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    main()\r\n\u001b[?2004hroot@7f535f315d6d:/app# "]
[15.545536, "i", "python3 /app/validator.py\n"]
[15.545913, "o", "python3 /app/validator.py\r\n\u001b[?2004l\r"]
[15.623146, "o", "Loading deployment manifest ...\r\n"]
[15.624019, "o", "Traceback (most recent call last):\r\n  File \"/app/validator.py\", line 168, in <module>\r\n"]
[15.624083, "o", "    main()\r\n"]
[15.624133, "o", "  File \"/app/validator.py\", line 130, in main\r\n    services = load_services(manifest_path)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/app/validator.py\", line 23, in load_services\r\n"]
[15.624159, "o", "    return config[\"services\"]\r\n           ~~~~~~^^^^^^^^^^^^\r\nKeyError: 'services'\r\n"]
[15.635841, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[27.911633, "i", "cp /app/validator.py /app/validator.py.backup\n"]
[27.913335, "o", "cp /app/validator.py /app/validator.py.backup\r\n\u001b[?2004l\r"]
[27.916519, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[33.360221, "i", "sed -i 's/return config\\[\"services\"\\]/return config[\"deployment\"][\"services\"]/' /app/validator.py\n"]
[33.3606, "o", "sed -i 's/return config\\[\"services\"\\]/return config[\"deployment\"][\"services\"]/' /app/validator.py\r\n\u001b[?2004l\r"]
[33.362665, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[34.586413, "i", "sed -i 's|f\"http:\\/\\/127\\.0\\.0\\.1:{service\\[\\'port\\'\\]}\\/health\"|f\"http://127.0.0.1:{service[\\\"port\\\"]}{service[\\\"health_endpoint\\\"]}\"|' /app/validator.py\n"]
[34.586803, "o", "sed -i 's|f\"http:\\/\\/127\\.0\\.0\\.1:{service\\[\\'port\\'\\]}\\/health\"|f\"http://127.0.0.1:{service[\\\"port\\\"]}{service[\\\"health_endpoint\\\"]}\"|' /app/validator.py\r\n\u001b[?2004l\r"]
[34.586856, "o", "\u001b[?2004h> "]
[39.826328, "i", "\u0003"]
[39.829754, "o", "^C\u001b[?2004l\r\u001b[?2004h\u001b[?2004l\r\r\n\u001b[?2004hroot@7f535f315d6d:/app# "]
[41.005395, "i", "sed -i \"s|/health\"|{service['health_endpoint']}|\" /app/validator.py\n"]
[41.005604, "o", "sed -i \"s|/health\"|{service['health_endpoint']}|\" /app/validator.py\r\n\u001b[?2004l\r\u001b[?2004h> "]
[58.443821, "i", "\u0003"]
[58.445223, "o", "^C\u001b[?2004l\r\u001b[?2004h\u001b[?2004l\r\r\n\u001b[?2004hroot@7f535f315d6d:/app# "]
[64.972436, "i", "cat > fix_validator.py << 'EOF'\n#!/usr/bin/env python3\nimport re\n\n# Read the original file\nwith open('/app/validator.py', 'r') as f:\n    content = f.read()\n\n# Fix 1: Health endpoint - replace hardcoded /health with dynamic endpoint\ncontent = re.sub(\n    r'f\"http://127\\.0\\.0\\.1:\\{service\\[\\'port\\'\\]\\}/health\"',\n    'f\"http://127.0.0.1:{service[\\\"port\\\"]}{service[\\\"health_endpoint\\\"]}\"',\n    content\n)\n\n# Fix 2: Weight mapping - fix the criticality weights\ncontent = re.sub(\n    r'weight_map = \\{\"high\": 1, \"medium\": 1, \"low\": 1\\}',\n    'weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}',\n    content\n)\n\n# Fix 3: Dependency direction - fix the startup order logic\n# Replace the problematic dependency mapping\ncontent = re.sub(\n    r'for svc, deps in deps_map\\.items\\(\\):\\s*for dep in deps:\\s*graph\\[svc\\]\\.append\\(dep\\)\\s*in_degree\\[dep\\] \\+= 1',\n    '''for svc, deps in deps_map.items():\n        for dep in deps:\n            graph[dep].append(svc)\n            in_degree[svc] += 1''',\n    content,\n    flags=re.MULTILINE | re.DOTALL\n)\n\n# Fix 4: Critical services check - only check HIGH criticality services\ncontent = re.sub(\n    r'critical_ok = all\\(\\s*statuses\\[s\\[\"name\"\\]\\]\\[\"status\"\\] == \"healthy\"\\s*for s in services\\)',\n    'critical_ok = all(\\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\\n        for s in services if s[\"criticality\"] == \"high\"\\n    )',\n    content\n)\n\n# Write the fixed content back\nwith open('/app/validator.py', 'w') as f:\n    f.write(content)\n\nprint(\"Fixed validator.py\")\nEOF\n"]
[64.972714, "o", "cat > fix_validator.py << 'EOF'\r\n\u001b[?2004l\r\u001b[?2004h> #!/usr/bin/env python3\r\n\u001b[?2004l\r\u001b[?2004h> import re\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[64.972774, "o", "\u001b[?2004h> # Read the original file\r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.972842, "o", "with open('/app/validator.py', 'r') as f:\r\n\u001b[?2004l\r\u001b[?2004h>     content = f.read()\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[64.972895, "o", "> "]
[64.97298, "o", "# Fix 1: Health endpoint - replace hardcoded /health with dynamic endpoint\r\n\u001b[?2004l\r\u001b[?2004h> content = re.sub("]
[64.973311, "o", "\r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.973425, "o", "    r'f\"http://127\\.0\\.0\\.1:\\{service\\[\\'port\\'\\]\\}/health\"',\r\n\u001b[?2004l\r\u001b[?2004h"]
[64.973665, "o", "> "]
[64.974113, "o", "    'f\"http://127.0.0.1:{service[\\\"port\\\"]}{service[\\\"health_endpoint\\\"]}\"',\r\n\u001b[?2004l\r\u001b[?2004h>     content\r\n\u001b[?2004l\r\u001b[?2004h> )\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.974259, "o", "# Fix 2: Weight mapping - fix the criticality weights\r\n\u001b[?2004l\r"]
[64.974495, "o", "\u001b[?2004h> content = re.sub(\r\n\u001b[?2004l\r\u001b[?2004h>     r'weight_map = \\{\"high\": 1, \"medium\": 1, \"low\": 1\\}',\r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.974544, "o", "    'weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}',"]
[64.974913, "o", "\r\n\u001b[?2004l\r\u001b[?2004h>     content\r\n\u001b[?2004l\r\u001b[?2004h> )\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> # Fix 3: Dependency direction - fix the startup order logic\r\n\u001b[?2004l\r\u001b[?2004h> # Replace the problematic dependency mapping\r\n\u001b[?2004l\r\u001b[?2004h> content = re.sub(\r\n\u001b[?2004l\r\u001b[?2004h"]
[64.974929, "o", "> "]
[64.975162, "o", "    r'for svc, deps in deps_map\\.items\\(\\):\\s*for dep in deps:\\s*graph\\[svc\\]\\.append\\(dep\\)\\s*in_degree\\[dep\\] \\+= 1',\r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.975288, "o", "    '''for svc, deps in deps_map.items():\r\n\u001b[?2004l\r"]
[64.975549, "o", "\u001b[?2004h"]
[64.97581, "o", ">         for dep in deps:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.975947, "o", "            graph[dep].append(svc)\r\n\u001b[?2004l\r\u001b[?2004h>             in_degree[svc] += 1''',\r\n\u001b[?2004l\r\u001b[?2004h>     content,\r\n\u001b[?2004l\r\u001b[?2004h>     flags=re.MULTILINE | re.DOTALL\r\n\u001b[?2004l\r"]
[64.975971, "o", "\u001b[?2004h> "]
[64.97619, "o", ")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> # Fix 4: Critical services check - only check HIGH criticality services\r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.976296, "o", "content = re.sub(\r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.976375, "o", "    r'critical_ok = all\\(\\s*statuses\\[s\\[\"name\"\\]\\]\\[\"status\"\\] == \"healthy\"\\s*for s in services\\)',\r\n\u001b[?2004l\r"]
[64.976395, "o", "\u001b[?2004h> "]
[64.976469, "o", "    'critical_ok = all(\\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\\n        for s in services if s[\"criticality\"] == \"high\"\\n    )',\r\n\u001b[?2004l\r\u001b[?2004h>     content\r\n\u001b[?2004l\r\u001b[?2004h> )\r\n\u001b[?2004l\r"]
[64.976484, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.976599, "o", "# Write the fixed content back\r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.976649, "o", "with open('/app/validator.py', 'w') as f:\r\n\u001b[?2004l\r\u001b[?2004h>     f.write(content)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[64.976673, "o", "print(\"Fixed validator.py\")\r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[64.977724, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[74.333437, "i", "python3 /app/fix_validator.py\n"]
[74.334989, "o", "python3 /app/fix_validator.py\r\n\u001b[?2004l\r"]
[74.349102, "o", "Fixed validator.py\r\n"]
[74.351773, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[80.406975, "i", "python3 /app/validator.py\n"]
[80.409861, "o", "python3 /app/validator.py\r\n\u001b[?2004l\r"]
[80.508768, "o", "Loading deployment manifest ...\r\n"]
[80.50969, "o", "Checking service health ...\r\n"]
[80.515337, "o", "  auth-service              healthy    (HTTP 200)\r\n"]
[80.516412, "o", "  api-gateway               healthy    (HTTP 200)\r\n"]
[80.517963, "o", "  cache-service             healthy    (HTTP 200)\r\n"]
[80.518923, "o", "  worker-service            unhealthy  (HTTP 503)\r\n"]
[80.51985, "o", "  notification-service      healthy    (HTTP 200)\r\nComputing startup order ...\r\n"]
[80.519917, "o", "  auth-service -> cache-service -> api-gateway -> worker-service -> notification-service\r\nComputing readiness score ...\r\n  score = 0.9000\r\n"]
[80.520192, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : critical\r\nReadiness score: 0.9\r\n"]
[80.52986, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[92.909832, "i", "cat /app/deployment_report.json\n"]
[92.912001, "o", "cat /app/deployment_report.json\r\n\u001b[?2004l\r"]
[92.91304, "o", "{\r\n  \"deployment_name\": \"production-stack\",\r\n  \"overall_status\": \"critical\",\r\n  \"readiness_score\": 0.9,\r\n  \"service_statuses\": {\r\n    \"auth-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"api-gateway\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"cache-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"medium\"\r\n    },\r\n    \"worker-service\": {\r\n      \"status\": \"unhealthy\",\r\n      \"http_status\": 503,\r\n      \"criticality\": \"low\"\r\n    },\r\n    \"notification-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"low\"\r\n    }\r\n  },\r\n  \"startup_order\": [\r\n    \"auth-service\",\r\n    \"cache-service\",\r\n    \"api-gateway\",\r\n    \"worker-service\",\r\n    \"notification-service\"\r\n  ],\r\n  \"critical_services_healthy\": false,\r\n  \"timestamp\": \"2026-02-27T19:13:38.852950+00:00\"\r\n}"]
[92.913281, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[98.383511, "i", "grep -A 10 -B 5 \"critical_ok =\" /app/validator.py\n"]
[98.383969, "o", "grep -A 10 -B 5 \"critical_ok =\" /app/validator.py\r\n\u001b[?2004l\r"]
[98.385111, "o", "      'healthy'   -- critical_services_healthy AND score >= 0.95\r\n      'degraded'  -- critical_services_healthy AND score < 0.95\r\n      'critical'  -- any high-criticality service is unhealthy\r\n      'not_ready' -- score < 0.70\r\n    \"\"\"\r\n    critical_ok = all(\r\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n        for s in services\r\n    )\r\n\r\n    if not critical_ok:\r\n        return \"critical\", critical_ok\r\n    if score >= 0.95:\r\n        return \"healthy\", critical_ok\r\n    if score >= 0.70:\r\n        return \"degraded\", critical_ok\r\n--\r\n\r\n    print(\"Computing readiness score ...\")\r\n    score = compute_readiness_score(services, statuses)\r\n    print(f\"  score = {score:.4f}\")\r\n\r\n    overall_status, critical_ok = determine_status(services, statuses, score)\r\n\r\n    report = {\r\n        \"deployment_name\":           \"production-stack\",\r\n        \"overall_status\":            overall_status,\r\n        \"readiness_score\":           score,\r\n        \"service_statuses\":          statuses,\r\n        \"startup_order\":             startup_order,\r\n        \"critical_services_healthy\": critical_ok,\r\n        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\r\n    }\r\n"]
[98.385275, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[107.703324, "i", "sed -i 's/critical_ok = all(/critical_ok = all(/' /app/validator.py\n"]
[107.704497, "o", "sed -i 's/critical_ok = all(/critical_ok = all(/' /app/validator.py\r\n"]
[107.704843, "o", "\u001b[?2004l\r"]
[107.706609, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
[113.245861, "i", "python3 -c \"\nwith open('/app/validator.py', 'r') as f:\n    content = f.read()\n\n# Fix the critical_ok line\nold_line = '    critical_ok = all(\\n        statuses[s[\\\"name\\\"]][\\\"status\\\"] == \\\"healthy\\\"\\n        for s in services\\n    )'\nnew_line = '    critical_ok = all(\\n        statuses[s[\\\"name\\\"]][\\\"status\\\"] == \\\"healthy\\\"\\n        for s in services if s[\\\"criticality\\\"] == \\\"high\\\"\\n    )'\n\ncontent = content.replace(old_line, new_line)\n\nwith open('/app/validator.py', 'w') as f:\n    f.write(content)\n\nprint('Fixed critical services check')\n\"\n"]
[113.246284, "o", "python3 -c \"\r\n\u001b[?2004l\r"]
[113.246477, "o", "\u001b[?2004h> with open('/app/validator.py', 'r') as f:\r\n\u001b[?2004l\r\u001b[?2004h>     content = f.read()\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> # Fix the critical_ok line\r\n\u001b[?2004l\r\u001b[?2004h> "]
[113.246589, "o", "old_line = '    critical_ok = all(\\n        statuses[s[\\\"name\\\"]][\\\"status\\\"] == \\\"healthy\\\"\\n        for s in services\\n    )'\r\n\u001b[?2004l\r"]
[113.24661, "o", "\u001b[?2004h> "]
[113.246787, "o", "new_line = '    critical_ok = all(\\n        statuses[s[\\\"name\\\"]][\\\"status\\\"] == \\\"healthy\\\"\\n        for s in services if s[\\\"criticality\\\"] == \\\"high\\\"\\n    )'\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[113.246806, "o", "> "]
[113.246915, "o", "content = content.replace(old_line, new_line)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> with open('/app/validator.py', 'w') as f:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[113.246939, "o", "    f.write(content)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[113.246987, "o", "\u001b[?2004h> "]
[113.247019, "o", "print('Fixed critical services check')\r\n\u001b[?2004l\r\u001b[?2004h> \"\r\n\u001b[?2004l\r"]
[113.255664, "o", "Fixed critical services check\r\n"]
[113.257101, "o", "\u001b[?2004hroot@7f535f315d6d:/app# "]
