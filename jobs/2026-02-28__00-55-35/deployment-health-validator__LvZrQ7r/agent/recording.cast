{"version": 2, "width": 160, "height": 40, "timestamp": 1772220354, "env": {"SHELL": "/bin/bash", "TERM": "tmux-256color"}}
[0.001807, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[0.973124, "i", "clear\r"]
[0.973393, "o", "clear\r\n\u001b[?2004l\r"]
[0.97417, "o", "\u001b[H\u001b[J\u001b[3J"]
[0.974331, "o", "\u001b[?2004h"]
[0.974669, "o", "root@b3729034f076:/app# "]
[2.445141, "i", "ls -la\n"]
[2.445549, "o", "ls -la\r\n\u001b[?2004l\r"]
[2.446293, "o", "total 32\r\ndrwxr-xr-x 1 root root 4096 Feb 27 19:22 .\r\ndrwxr-xr-x 1 root root 4096 Feb 27 19:25 ..\r\n-rw-r--r-- 1 root root  698 Feb 27 19:10 Dockerfile\r\n-rw-r--r-- 1 root root 2068 Feb 27 19:22 deployment_manifest.yaml\r\n-rw-r--r-- 1 root root 3096 Feb 27 18:52 mock_services.py\r\n-rw-r--r-- 1 root root   44 Feb 27 18:53 requirements.txt\r\n-rw-r--r-- 1 root root 6135 Feb 27 19:22 validator.py\r\n"]
[2.446715, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[3.508828, "i", "cat deployment_manifest.yaml\n"]
[3.509087, "o", "cat deployment_manifest.yaml\r\n\u001b[?2004l\r"]
[3.510115, "o", "# ─────────────────────────────────────────────────────────────────────────────\r\n# deployment_manifest.yaml\r\n#\r\n# Deployment descriptor for the production stack.\r\n#\r\n# Schema notes:\r\n#   • The top-level 'services' block is a legacy v1 monitoring registry read\r\n#     by the external health-dashboard and alert-manager sidecar.  It is NOT\r\n#     the authoritative list for deployment ordering or health validation.\r\n#   • The authoritative service definitions live under 'deployment.services'.\r\n# ─────────────────────────────────────────────────────────────────────────────\r\n\r\n# Legacy monitoring-registry endpoint  (consumed by alert-manager, not by the validator)\r\nservices:\r\n  - name: \"metrics-collector\"\r\n    port: 9091\r\n    health_endpoint: \"/metrics\"\r\n    dependencies: []\r\n    criticality: \"low\"\r\n\r\n# ── Authoritative deployment configuration ────────────────────────────────────\r\ndeployment:\r\n  name: \"production-stack\"\r\n\r\n  services:\r\n    - name: \"auth-service\"\r\n      port: 8081\r\n      health_endpoint: \"/health\"\r\n      dependencies: []\r\n      criticality: \"high\"\r\n\r\n    - name: \"api-gateway\"\r\n      port: 8082\r\n      health_endpoint: \"/health\"\r\n      dependencies:\r\n        - \"auth-service\"\r\n        - \"cache-service\"\r\n      criticality: \"high\"\r\n\r\n    - name: \"cache-service\"\r\n      port: 8083\r\n      health_endpoint: \"/ping\"\r\n      dependencies: []\r\n      criticality: \"medium\"\r\n\r\n    - name: \"worker-service\"\r\n      port: 8084\r\n      health_endpoint: \"/status\"\r\n      dependencies:\r\n        - \"api-gateway\"\r\n        - \"cache-service\"\r\n      criticality: \"low\"\r\n\r\n    - name: \"notification-service\"\r\n      port: 8085\r\n      health_endpoint: \"/health\"\r\n      dependencies:\r\n        - \"worker-service\"\r\n      criticality: \"low\"\r\n"]
[3.510263, "o", "\u001b[?2004h"]
[3.51047, "o", "root@b3729034f076:/app# "]
[4.602654, "i", "cat validator.py\n"]
[4.602822, "o", "cat validator.py\r\n\u001b[?2004l\r"]
[4.603473, "o", "#!/usr/bin/env python3\r\n\"\"\"\r\nDeployment Health Validator\r\n===========================\r\nReads deployment_manifest.yaml, probes each service's health endpoint,\r\ncomputes a weighted readiness score, determines a valid startup ordering,\r\nand writes a deployment readiness report to /app/deployment_report.json.\r\n\"\"\"\r\n\r\nimport json\r\nimport yaml\r\nimport requests\r\nfrom datetime import datetime, timezone\r\nfrom collections import deque\r\n\r\n\r\n# ── 1. Load manifest ──────────────────────────────────────────────────────────\r\n\r\ndef load_services(manifest_path: str) -> list:\r\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n    with open(manifest_path) as f:\r\n        config = yaml.safe_load(f)\r\n    # Returns the top-level 'services' list from the manifest.\r\n    return config[\"services\"]\r\n\r\n\r\n# ── 2. Health check ───────────────────────────────────────────────────────────\r\n\r\ndef check_health(service: dict) -> dict:\r\n    \"\"\"\r\n    Probe a single service and return its health record.\r\n    HTTP 200 -> healthy; anything else -> unhealthy.\r\n    \"\"\"\r\n    url = f\"http://127.0.0.1:{service['port']}/health\"\r\n    try:\r\n        resp = requests.get(url, timeout=5)\r\n        return {\r\n            \"status\": \"healthy\" if resp.status_code == 200 else \"unhealthy\",\r\n            \"http_status\": resp.status_code,\r\n            \"criticality\": service[\"criticality\"],\r\n        }\r\n    except requests.exceptions.RequestException:\r\n        return {\r\n            \"status\": \"unhealthy\",\r\n            \"http_status\": 0,\r\n            \"criticality\": service[\"criticality\"],\r\n        }\r\n\r\n\r\n# ── 3. Startup ordering ───────────────────────────────────────────────────────\r\n\r\ndef compute_startup_order(services: list) -> list:\r\n    \"\"\"\r\n    Return a topologically sorted startup order using Kahn's algorithm.\r\n    Dependencies must start before the services that depend on them.\r\n    \"\"\"\r\n    names = [s[\"name\"] for s in services]\r\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\r\n    graph     = {n: [] for n in names}\r\n    in_degree = {n: 0 for n in names}\r\n\r\n    for svc, deps in deps_map.items():\r\n        for dep in deps:\r\n            graph[svc].append(dep)\r\n            in_degree[dep] += 1\r\n\r\n    queue = deque(n for n in names if in_degree[n] == 0)\r\n    order = []\r\n    while queue:\r\n        node = queue.popleft()\r\n        order.append(node)\r\n        for neighbor in graph[node]:\r\n            in_degree[neighbor] -= 1\r\n            if in_degree[neighbor] == 0:\r\n                queue.append(neighbor)\r\n    return order\r\n\r\n\r\n# ── 4. Readiness score ────────────────────────────────────────────────────────\r\n\r\ndef compute_readiness_score(services: list, statuses: dict) -> float:\r\n    \"\"\"\r\n    Compute the weighted fraction of healthy services.\r\n    Criticality weights: high=3, medium=2, low=1.\r\n    \"\"\"\r\n    weight_map = {\"high\": 1, \"medium\": 1, \"low\": 1}\r\n\r\n    total   = sum(weight_map[s[\"criticality\"]] for s in services)\r\n    healthy = sum(\r\n        weight_map[s[\"criticality\"]]\r\n        for s in services\r\n        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n    )\r\n    return round(healthy / total, 4) if total else 0.0\r\n\r\n\r\n# ── 5. Overall status ─────────────────────────────────────────────────────────\r\n\r\ndef determine_status(services: list, statuses: dict, score: float):\r\n    \"\"\"\r\n    Returns (overall_status, critical_services_healthy).\r\n\r\n    Status rules:\r\n      'healthy'   -- critical_services_healthy AND score >= 0.95\r\n      'degraded'  -- critical_services_healt"]
[4.603522, "o", "hy AND score < 0.95\r\n      'critical'  -- any high-criticality service is unhealthy\r\n      'not_ready' -- score < 0.70\r\n    \"\"\"\r\n    critical_ok = all(\r\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n        for s in services\r\n    )\r\n\r\n    if not critical_ok:\r\n        return \"critical\", critical_ok\r\n    if score >= 0.95:\r\n        return \"healthy\", critical_ok\r\n    if score >= 0.70:\r\n        return \"degraded\", critical_ok\r\n    return \"not_ready\", critical_ok\r\n\r\n\r\n# ── main ──────────────────────────────────────────────────────────────────────\r\n\r\ndef main():\r\n    manifest_path = \"/app/deployment_manifest.yaml\"\r\n    output_path   = \"/app/deployment_report.json\"\r\n\r\n    print(\"Loading deployment manifest ...\")\r\n    services = load_services(manifest_path)\r\n\r\n    print(\"Checking service health ...\")\r\n    statuses = {}\r\n    for svc in services:\r\n        result = check_health(svc)\r\n        statuses[svc[\"name\"]] = result\r\n        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\r\n\r\n    print(\"Computing startup order ...\")\r\n    startup_order = compute_startup_order(services)\r\n    print(f\"  {' -> '.join(startup_order)}\")\r\n\r\n    print(\"Computing readiness score ...\")\r\n    score = compute_readiness_score(services, statuses)\r\n    print(f\"  score = {score:.4f}\")\r\n\r\n    overall_status, critical_ok = determine_status(services, statuses, score)\r\n\r\n    report = {\r\n        \"deployment_name\":           \"production-stack\",\r\n        \"overall_status\":            overall_status,\r\n        \"readiness_score\":           score,\r\n        \"service_statuses\":          statuses,\r\n        \"startup_order\":             startup_order,\r\n        \"critical_services_healthy\": critical_ok,\r\n        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\r\n    }\r\n\r\n    with open(output_path, \"w\") as f:\r\n        json.dump(report, f, indent=2)\r\n\r\n    print(f\"\\nReport written to {output_path}\")\r\n    print(f\"Overall status : {overall_status}\")\r\n    print(f\"Readiness score: {score}\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    main()\r\n"]
[4.60364, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[6.468841, "i", "python /app/validator.py\n"]
[6.469218, "o", "python /app/validator.py\r\n\u001b[?2004l\r"]
[6.545492, "o", "Loading deployment manifest ...\r\n"]
[6.54693, "o", "Checking service health ...\r\n"]
[6.547762, "o", "  metrics-collector         unhealthy  (HTTP 0)\r\nComputing startup order ...\r\n  metrics-collector\r\nComputing readiness score ...\r\n  score = 0.0000\r\n"]
[6.548726, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : critical\r\nReadiness score: 0.0\r\n"]
[6.559398, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[10.028752, "i", "cp /app/validator.py /app/validator.py.backup\n"]
[10.030301, "o", "cp /app/validator.py /app/validator.py.backup\r\n\u001b[?2004l\r"]
[10.031826, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[14.334095, "i", "cat > /tmp/fixes.py << 'EOF'\n#!/usr/bin/env python3\n\"\"\"\nDeployment Health Validator\n===========================\nReads deployment_manifest.yaml, probes each service's health endpoint,\ncomputes a weighted readiness score, determines a valid startup ordering,\nand writes a deployment readiness report to /app/deployment_report.json.\n\"\"\"\n\nimport json\nimport yaml\nimport requests\nfrom datetime import datetime, timezone\nfrom collections import deque\n\n\n# ── 1. Load manifest ──────────────────────────────────────────────────────────\n\ndef load_services(manifest_path: str) -> list:\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\n    with open(manifest_path) as f:\n        config = yaml.safe_load(f)\n    # Returns the deployment services list from the manifest.\n    return config[\"deployment\"][\"services\"]\n\n\n# ── 2. Health check ───────────────────────────────────────────────────────────\n\ndef check_health(service: dict) -> dict:\n    \"\"\"\n    Probe a single service and return its health record.\n    HTTP 200 -> healthy; anything else -> unhealthy.\n    \"\"\"\n    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\n    try:\n        resp = requests.get(url, timeout=5)\n        return {\n            \"status\": \"healthy\" if resp.status_code == 200 else \"unhealthy\",\n            \"http_status\": resp.status_code,\n            \"criticality\": service[\"criticality\"],\n        }\n    except requests.exceptions.RequestException:\n        return {\n            \"status\": \"unhealthy\",\n            \"http_status\": 0,\n            \"criticality\": service[\"criticality\"],\n        }\n\n\n# ── 3. Startup ordering ───────────────────────────────────────────────────────\n\ndef compute_startup_order(services: list) -> list:\n    \"\"\"\n    Return a topologically sorted startup order using Kahn's algorithm.\n    Dependencies must start before the services that depend on them.\n    \"\"\"\n    names = [s[\"name\"] for s in services]\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\n\n    graph     = {n: [] for n in names}\n    in_degree = {n: 0 for n in names}\n\n    for svc, deps in deps_map.items():\n        for dep in deps:\n            graph[dep].append(svc)  # dep must come before svc\n            in_degree[svc] += 1\n\n    queue = deque(n for n in names if in_degree[n] == 0)\n    order = []\n    while queue:\n        node = queue.popleft()\n        order.append(node)\n        for neighbor in graph[node]:\n            in_degree[neighbor] -= 1\n            if in_degree[neighbor] == 0:\n                queue.append(neighbor)\n    return order\n\n\n# ── 4. Readiness score ────────────────────────────────────────────────────────\n\ndef compute_readiness_score(services: list, statuses: dict) -> float:\n    \"\"\"\n    Compute the weighted fraction of healthy services.\n    Criticality weights: high=3, medium=2, low=1.\n    \"\"\"\n    weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\n\n    total   = sum(weight_map[s[\"criticality\"]] for s in services)\n    healthy = sum(\n        weight_map[s[\"criticality\"]]\n        for s in services\n        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\n    )\n    return round(healthy / total, 4) if total else 0.0\n\n\n# ── 5. Overall status ─────────────────────────────────────────────────────────\n\ndef determine_status(services: list, statuses: dict, score: float):\n    \"\"\"\n    Returns (overall_status, critical_services_healthy).\n\n    Status rules:\n      'healthy'   -- critical_services_healthy AND score >= 0.95\n      'degraded'  -- critical_services_healthy AND score <"]
[14.334404, "i", " 0.95\n      'critical'  -- any high-criticality service is unhealthy\n      'not_ready' -- score < 0.70\n    \"\"\"\n    critical_ok = all(\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\n        for s in services\n        if s[\"criticality\"] == \"high\"\n    )\n\n    if not critical_ok:\n        return \"critical\", critical_ok\n    if score >= 0.95:\n        return \"healthy\", critical_ok\n    if score >= 0.70:\n        return \"degraded\", critical_ok\n    return \"not_ready\", critical_ok\n\n\n# ── main ──────────────────────────────────────────────────────────────────────\n\ndef main():\n    manifest_path = \"/app/deployment_manifest.yaml\"\n    output_path   = \"/app/deployment_report.json\"\n\n    print(\"Loading deployment manifest ...\")\n    services = load_services(manifest_path)\n\n    print(\"Checking service health ...\")\n    statuses = {}\n    for svc in services:\n        result = check_health(svc)\n        statuses[svc[\"name\"]] = result\n        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\n\n    print(\"Computing startup order ...\")\n    startup_order = compute_startup_order(services)\n    print(f\"  {' -> '.join(startup_order)}\")\n\n    print(\"Computing readiness score ...\")\n    score = compute_readiness_score(services, statuses)\n    print(f\"  score = {score:.4f}\")\n\n    overall_status, critical_ok = determine_status(services, statuses, score)\n\n    report = {\n        \"deployment_name\":           \"production-stack\",\n        \"overall_status\":            overall_status,\n        \"readiness_score\":           score,\n        \"service_statuses\":          statuses,\n        \"startup_order\":             startup_order,\n        \"critical_services_healthy\": critical_ok,\n        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\n    }\n\n    with open(output_path, \"w\") as f:\n        json.dump(report, f, indent=2)\n\n    print(f\"\\nReport written to {output_path}\")\n    print(f\"Overall status : {overall_status}\")\n    print(f\"Readiness score: {score}\")\n\n\nif __name__ == \"__main__\":\n    main()\nEOF\n"]
[14.334676, "o", "cat > /tmp/fixes.py << 'EOF'\r\n\u001b[?2004l\r"]
[14.335002, "o", "\u001b[?2004h> #!/usr/bin/env python3\r\n\u001b[?2004l\r\u001b[?2004h> \"\"\"\r\n\u001b[?2004l\rrvice \u001b[?2004h> Deployment Health Validator\r\n\u001b[?2004l\r\u001b[?2004h> ===========================\r\n\u001b[?2004l\r\u001b[?2004h> Reads deployment_manifest.yaml, probes each service's health endpoint,\r\n\u001b[?2004l\ry' -- score < 0.70\r\n    \"\"\"\r\n    critical_ok = all(\r\n        statuses[s[\"name\"]][\"status\"] == \"healthy\u001b[?2004h> computes a weighted readiness score, determines a valid startup ordering,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.335354, "o", "and writes a deployment readiness report to /app/deployment_report.json.\r\n\u001b[?2004l\r\u001b[?2004h> \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> import json\r\n\u001b[?2004l\r\u001b[?2004h> import yaml\r\n\u001b[?2004l\r\u001b[?2004h> import requests\r\n\u001b[?2004l\r\u001b[?2004h> from datetime import datetime, timezone\r\n\u001b[?2004l\r\u001b[?2004h> from collections import deque\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r, critical_ok\r\n    if score >= 0.95:\r\n        return \"healthy\", critical_ok\r\n    if score >= 0.70:\r\n        return \"degraded\", critical_ok\r\n    re\u001b[?2004h> \r\n\u001b[?2004l\r"]
[14.335389, "o", "\u001b[?2004h> "]
[14.335743, "o", "# ── 1. Load manifest ──────────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def load_services(manifest_path: str) -> list:\r\n\u001b[?2004l\r"]
[14.335833, "o", "\u001b[?2004h>     \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n"]
[14.335877, "o", "\u001b[?2004l\r\u001b[?2004h> "]
[14.335959, "o", "    with open(manifest_path) as f:\r\n\u001b[?2004l\r\u001b[?2004h>         config = yaml.safe_load(f)\r\n\u001b[?2004l\r"]
[14.335985, "o", "\u001b[?2004h> "]
[14.336143, "o", "    # Returns the deployment services list from the manifest.\r\n\u001b[?2004l\r\u001b[?2004h>     return config[\"deployment\"][\"services\"]\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.336399, "o", "# ── 2. Health check ───────────────────────────────────────────────────────────\r\n\u001b[?2004l\r"]
[14.336411, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.336507, "o", "def check_health(service: dict) -> dict:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.33656, "o", "    \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.33665, "o", "    Probe a single service and return its health record.\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.336733, "o", "    HTTP 200 -> healthy; anything else -> unhealthy.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.336853, "o", "    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\r\n\u001b[?2004l\rore(services, s\u001b[?2004h>     try:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.336974, "o", "        resp = requests.get(url, timeout=5)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.337069, "o", "        return {\r\n\u001b[?2004l\rt\u001b[?2004h> "]
[14.337132, "o", "            \"status\": \"healthy\" if resp.status_code == 200 else \"unhealthy\",\r\n\u001b[?2004l\r"]
[14.337148, "o", "\u001b[?2004h> "]
[14.337219, "o", "            \"http_status\": resp.status_code,\r\n\u001b[?2004l\ron-sta\u001b[?2004h> "]
[14.337282, "o", "            \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.33735, "o", "        }\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.337381, "o", "    except requests.exceptions.RequestException:\r\n\u001b[?2004l\r"]
[14.337465, "o", "\u001b[?2004h>         return {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.337525, "o", "            \"status\": \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h>             \"http_status\": 0,\r\n\u001b[?2004l\r\u001b[?2004h"]
[14.337624, "o", "> "]
[14.337643, "o", "            \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h>         }\r\n\u001b[?2004l\ral_ok,\r\n  \u001b[?2004h> \r\n\u001b[?2004l\r \u001b[?2004h> \r\n\u001b[?2004l\r"]
[14.337699, "o", "\u001b[?2004h> "]
[14.337911, "o", "# ── 3. Startup ordering ───────────────────────────────────────────────────────\r\n\u001b[?2004l\rtp\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.338012, "o", "def compute_startup_order(services: list) -> list:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r}\")\r\n \u001b[?2004h> "]
[14.33816, "o", "    Return a topologically sorted startup order using Kahn's algorithm.\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.338276, "o", "    Dependencies must start before the services that depend on them.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.338295, "o", "    names = [s[\"name\"] for s in services]\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.338393, "o", "    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.338471, "o", "    graph     = {n: [] for n in names}\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.338539, "o", "    in_degree = {n: 0 for n in names}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.33859, "o", "    for svc, deps in deps_map.items():\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.33863, "o", "        for dep in deps:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.338688, "o", "            graph[dep].append(svc)  # dep must come before svc\r\n\u001b[?2004l\r\u001b[?2004h>             in_degree[svc] += 1\r\n\u001b[?2004l\r"]
[14.338744, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.338814, "o", "    queue = deque(n for n in names if in_degree[n] == 0)\r\n\u001b[?2004l\r\u001b[?2004h>     order = []"]
[14.338954, "o", "\r\n\u001b[?2004l\r\u001b[?2004h>     while queue:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.339183, "o", "        node = queue.popleft()\r\n\u001b[?2004l\r\u001b[?2004h>         order.append(node)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.339422, "o", "        for neighbor in graph[node]:\r\n\u001b[?2004l\r\u001b[?2004h>             in_degree[neighbor] -= 1\r\n\u001b[?2004l\r\u001b[?2004h>             if in_degree[neighbor] == 0:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.339524, "o", "                queue.append(neighbor)\r\n\u001b[?2004l\r\u001b[?2004h>     return order\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.339779, "o", "# ── 4. Readiness score ────────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def compute_readiness_score(services: list, statuses: dict) -> float:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.33994, "o", "    Compute the weighted fraction of healthy services.\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.340001, "o", "    Criticality weights: high=3, medium=2, low=1.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.340169, "o", "    weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     total   = sum(weight_map[s[\"criticality\"]] for s in services)\r\n\u001b[?2004l\r\u001b[?2004h>     healthy = sum(\r\n\u001b[?2004l\r\u001b[?2004h"]
[14.340213, "o", ">         weight_map[s[\"criticality\"]]\r\n\u001b[?2004l\r\u001b[?2004h"]
[14.340317, "o", ">         for s in services\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.340392, "o", "        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>     )\r\n\u001b[?2004l\r\u001b[?2004h"]
[14.340468, "o", "> "]
[14.340613, "o", "    return round(healthy / total, 4) if total else 0.0\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[14.340671, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.340807, "o", "# ── 5. Overall status ─────────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34089, "o", "def determine_status(services: list, statuses: dict, score: float):\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34099, "o", "    Returns (overall_status, critical_services_healthy).\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34109, "o", "    Status rules:\r\n\u001b[?2004l\r\u001b[?2004h>       'healthy'   -- critical_services_healthy AND score >= 0.95\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.341177, "o", "      'degraded'  -- critical_services_healthy AND score < 0.95\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.341254, "o", "      'critical'  -- any high-criticality service is unhealthy\r\n\u001b[?2004l\r\u001b[?2004h>       'not_ready' -- score < 0.70\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.341273, "o", "    critical_ok = all("]
[14.341281, "o", "\r\n\u001b[?2004l\r"]
[14.341414, "o", "\u001b[?2004h> "]
[14.341434, "o", "        statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>         for s in services\r\n\u001b[?2004l\r\u001b[?2004h>         if s[\"criticality\"] == \"high\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34148, "o", "    )\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[14.341497, "o", "\u001b[?2004h>     if not critical_ok:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34155, "o", "        return \"critical\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.341566, "o", "    if score >= 0.95:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.341639, "o", "        return \"healthy\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     if score >= 0.70:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.341699, "o", "        return \"degraded\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     return \"not_ready\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[14.341714, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[14.341725, "o", "> "]
[14.341907, "o", "# ── main ──────────────────────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.341929, "o", "def main():\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34198, "o", "    manifest_path = \"/app/deployment_manifest.yaml\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34206, "o", "    output_path   = \"/app/deployment_report.json\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342141, "o", "    print(\"Loading deployment manifest ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342199, "o", "    services = load_services(manifest_path)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342241, "o", "    print(\"Checking service health ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342265, "o", "    statuses = {}\r\n\u001b[?2004l\r\u001b[?2004h>     for svc in services:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342319, "o", "        result = check_health(svc)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342377, "o", "        statuses[svc[\"name\"]] = result\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34247, "o", "        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[14.342537, "o", "> "]
[14.342592, "o", "    print(\"Computing startup order ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342654, "o", "    startup_order = compute_startup_order(services)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342675, "o", "    print(f\"  {' -> '.join(startup_order)}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342722, "o", "    print(\"Computing readiness score ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342775, "o", "    score = compute_readiness_score(services, statuses)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342885, "o", "    print(f\"  score = {score:.4f}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34293, "o", "    overall_status, critical_ok = determine_status(services, statuses, score)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.342987, "o", "    report = {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.343038, "o", "        \"deployment_name\":           \"production-stack\",\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.343055, "o", "        \"overall_status\":            overall_status,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34316, "o", "        \"readiness_score\":           score,\r\n\u001b[?2004l\r\u001b[?2004h"]
[14.343174, "o", "> "]
[14.343257, "o", "        \"service_statuses\":          statuses,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.343316, "o", "        \"startup_order\":             startup_order,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.343367, "o", "        \"critical_services_healthy\": critical_ok,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.343467, "o", "        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\r\n\u001b[?2004l\r\u001b[?2004h>     }\r\n\u001b[?2004l\r"]
[14.343538, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.343586, "o", "    with open(output_path, \"w\") as f:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.34363, "o", "        json.dump(report, f, indent=2)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.343659, "o", "    print(f\"\\nReport written to {output_path}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.343711, "o", "    print(f\"Overall status : {overall_status}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.343828, "o", "    print(f\"Readiness score: {score}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[14.343912, "o", "if __name__ == \"__main__\":\r\n\u001b[?2004l\r\u001b[?2004h>     main()\r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[14.344651, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[18.237602, "i", "cat > /app/validator_fixed.py << 'EOF'\n#!/usr/bin/env python3\n\"\"\"\nDeployment Health Validator\n===========================\nReads deployment_manifest.yaml, probes each service's health endpoint,\ncomputes a weighted readiness score, determines a valid startup ordering,\nand writes a deployment readiness report to /app/deployment_report.json.\n\"\"\"\n\nimport json\nimport yaml\nimport requests\nfrom datetime import datetime, timezone\nfrom collections import deque\n\n\ndef load_services(manifest_path: str) -> list:\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\n    with open(manifest_path) as f:\n        config = yaml.safe_load(f)\n    return config[\"deployment\"][\"services\"]\n\n\ndef check_health(service: dict) -> dict:\n    \"\"\"\n    Probe a single service and return its health record.\n    HTTP 200 -> healthy; anything else -> unhealthy.\n    \"\"\"\n    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\n    try:\n        resp = requests.get(url, timeout=5)\n        return {\n            \"status\": \"healthy\" if resp.status_code == 200 else \"unhealthy\",\n            \"http_status\": resp.status_code,\n            \"criticality\": service[\"criticality\"],\n        }\n    except requests.exceptions.RequestException:\n        return {\n            \"status\": \"unhealthy\",\n            \"http_status\": 0,\n            \"criticality\": service[\"criticality\"],\n        }\n\n\ndef compute_startup_order(services: list) -> list:\n    \"\"\"\n    Return a topologically sorted startup order using Kahn's algorithm.\n    Dependencies must start before the services that depend on them.\n    \"\"\"\n    names = [s[\"name\"] for s in services]\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\n\n    graph     = {n: [] for n in names}\n    in_degree = {n: 0 for n in names}\n\n    for svc, deps in deps_map.items():\n        for dep in deps:\n            graph[dep].append(svc)  # dep must come before svc\n            in_degree[svc] += 1\n\n    queue = deque(n for n in names if in_degree[n] == 0)\n    order = []\n    while queue:\n        node = queue.popleft()\n        order.append(node)\n        for neighbor in graph[node]:\n            in_degree[neighbor] -= 1\n            if in_degree[neighbor] == 0:\n                queue.append(neighbor)\n    return order\n\n\ndef compute_readiness_score(services: list, statuses: dict) -> float:\n    \"\"\"\n    Compute the weighted fraction of healthy services.\n    Criticality weights: high=3, medium=2, low=1.\n    \"\"\"\n    weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\n\n    total   = sum(weight_map[s[\"criticality\"]] for s in services)\n    healthy = sum(\n        weight_map[s[\"criticality\"]]\n        for s in services\n        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\n    )\n    return round(healthy / total, 4) if total else 0.0\n\n\ndef determine_status(services: list, statuses: dict, score: float):\n    \"\"\"\n    Returns (overall_status, critical_services_healthy).\n    \"\"\"\n    critical_ok = all(\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\n        for s in services\n        if s[\"criticality\"] == \"high\"\n    )\n\n    if not critical_ok:\n        return \"critical\", critical_ok\n    if score >= 0.95:\n        return \"healthy\", critical_ok\n    if score >= 0.70:\n        return \"degraded\", critical_ok\n    return \"not_ready\", critical_ok\n\n\ndef main():\n    manifest_path = \"/app/deployment_manifest.yaml\"\n    output_path   = \"/app/deployment_report.json\"\n\n    print(\"Loading deployment manifest ...\")\n    services = load_services(manifest_path)\n\n    print(\"Checking service health ...\")\n    statuses = {}\n    for svc in services:\n        result = check_health(svc)\n        statuses[svc[\"name\"]] = result\n        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\n\n    print(\"Computing startup order ...\")\n    startup_order = compute_startup_order(services)\n    print(f\"  {' -> '.join(startup_order)}\")\n\n    print(\"Computing readiness score ...\")\n    score = compute_readiness_score(services, statuses)\n    print(f\"  score = {score:.4f}\")\n\n    overall_status, critical_ok = determine_status(services, statuses, score)\n\n    repor"]
[18.237897, "i", "t = {\n        \"deployment_name\":           \"production-stack\",\n        \"overall_status\":            overall_status,\n        \"readiness_score\":           score,\n        \"service_statuses\":          statuses,\n        \"startup_order\":             startup_order,\n        \"critical_services_healthy\": critical_ok,\n        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\n    }\n\n    with open(output_path, \"w\") as f:\n        json.dump(report, f, indent=2)\n\n    print(f\"\\nReport written to {output_path}\")\n    print(f\"Overall status : {overall_status}\")\n    print(f\"Readiness score: {score}\")\n\n\nif __name__ == \"__main__\":\n    main()\nEOF\n"]
[18.238128, "o", "cat > /app/validator_fixed.py << 'EOF'\r\n\u001b[?2004l\r"]
[18.238342, "o", "\u001b[?2004h> #!/usr/bin/env python3\r\n\u001b[?2004l\r,\u001b[?2004h> \"\"\"\r\n\u001b[?2004l\r\r\n   "]
[18.238376, "o", "\u001b[?2004h> "]
[18.238826, "o", "Deployment Health Validator\r\n\u001b[?2004l\r\u001b[?2004h> ===========================\r\n\u001b[?2004l\r\u001b[?2004h> Reads deployment_manifest.yaml, probes each service's health endpoint,\r\n\u001b[?2004l\r\u001b[?2004h> computes a weighted readiness score, determines a valid startup ordering,\r\n\u001b[?2004l\rer\":             startup_order,\r\n        \u001b[?2004h> "]
[18.239188, "o", "and writes a deployment readiness report to /app/deployment_report.json.\r\n\u001b[?2004l\r\u001b[?2004h> \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n"]
[18.239204, "o", "\u001b[?2004l\r\u001b[?2004h> import json\r\n\u001b[?2004l\r\u001b[?2004h> import yaml\r\n\u001b[?2004l\rezone.u\u001b[?2004h> "]
[18.241133, "o", "import requests\r\n\u001b[?2004l\r\u001b[?2004h> from datetime import datetime, timezone\r\n\u001b[?2004l\r\u001b[?2004h> from collections import deque\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def load_services(manifest_path: str) -> list:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     with open(manifest_path) as f:\r\n\u001b[?2004l\r\u001b[?2004h>         config = yaml.safe_load(f)\r\n\u001b[?2004l\r\u001b[?2004h>     return config[\"deployment\"][\"services\"]\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def check_health(service: dict) -> dict:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     Probe a single service and return its health record.\r\n\u001b[?2004l\r\u001b[?2004h>     HTTP 200 -> healthy; anything else -> unhealthy.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\r\n\u001b[?2004l\r\u001b[?2004h>     try:\r\n\u001b[?2004l\r\u001b[?2004h>         resp = requests.get(url, timeout=5)\r\n\u001b[?2004l\r\u001b[?2004h>         return {\r\n\u001b[?2004l\r\u001b[?2004h>             \"status\": \"healthy\" if resp.status_code == 200 else \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h>             \"http_status\": resp.status_code,\r\n\u001b[?2004l\r\u001b[?2004h>             \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h>         }\r\n\u001b[?2004l\r\u001b[?2004h>     except requests.exceptions.RequestException:\r\n\u001b[?2004l\r\u001b[?2004h>         return {\r\n\u001b[?2004l\r\u001b[?2004h>             \"status\": \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h>             \"http_status\": 0,\r\n\u001b[?2004l\r\u001b[?2004h>             \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h>         }\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def compute_startup_order(services: list) -> list:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     Return a topologically sorted startup order using Kahn's algorithm.\r\n\u001b[?2004l\r\u001b[?2004h>     Dependencies must start before the services that depend on them.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.24122, "o", "    names = [s[\"name\"] for s in services]\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.241246, "o", "    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.241331, "o", "    graph     = {n: [] for n in names}\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.241366, "o", "    in_degree = {n: 0 for n in names}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.241462, "o", "    for svc, deps in deps_map.items():\r\n\u001b[?2004l\r\u001b[?2004h>         for dep in deps:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.241542, "o", "            graph[dep].append(svc)  # dep must come before svc\r\n\u001b[?2004l\r"]
[18.241631, "o", "\u001b[?2004h>             in_degree[svc] += 1\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.241718, "o", "    queue = deque(n for n in names if in_degree[n] == 0)\r\n\u001b[?2004l\r\u001b[?2004h>     order = []\r\n\u001b[?2004l\r\u001b[?2004h>     while queue:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.241758, "o", "        node = queue.popleft()\r\n\u001b[?2004l\r\u001b[?2004h>         order.append(node)\r\n"]
[18.241854, "o", "\u001b[?2004l\r\u001b[?2004h>         for neighbor in graph[node]:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.24194, "o", "            in_degree[neighbor] -= 1\r\n\u001b[?2004l\r\u001b[?2004h>             if in_degree[neighbor] == 0:\r\n\u001b[?2004l\r"]
[18.242005, "o", "\u001b[?2004h> "]
[18.242086, "o", "                queue.append(neighbor)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.242167, "o", "    return order\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.242248, "o", "\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.242269, "o", "def compute_readiness_score(services: list, statuses: dict) -> float:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h"]
[18.242298, "o", "> "]
[18.242378, "o", "    Compute the weighted fraction of healthy services.\r\n\u001b[?2004l\r\u001b[?2004h>     Criticality weights: high=3, medium=2, low=1.\r\n"]
[18.242394, "o", "\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r"]
[18.242475, "o", "\u001b[?2004h> "]
[18.242548, "o", "    weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.24257, "o", "    total   = sum(weight_map[s[\"criticality\"]] for s in services)\r\n\u001b[?2004l\r\u001b[?2004h>     healthy = sum(\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.242626, "o", "        weight_map[s[\"criticality\"]]\r\n\u001b[?2004l\r\u001b[?2004h>         for s in services\r\n\u001b[?2004l\r\u001b[?2004h"]
[18.242638, "o", "> "]
[18.242714, "o", "        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>     )\r\n\u001b[?2004l\r\u001b[?2004h"]
[18.242734, "o", "> "]
[18.242805, "o", "    return round(healthy / total, 4) if total else 0.0\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[18.242829, "o", "> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.242901, "o", "def determine_status(services: list, statuses: dict, score: float):\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r"]
[18.242922, "o", "\u001b[?2004h> "]
[18.243014, "o", "    Returns (overall_status, critical_services_healthy).\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.243114, "o", "    critical_ok = all(\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.243206, "o", "        statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>         for s in services\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.243222, "o", "        if s[\"criticality\"] == \"high\"\r\n\u001b[?2004l\r\u001b[?2004h"]
[18.243257, "o", ">     )\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[18.243304, "o", "\u001b[?2004h>     if not critical_ok:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.243371, "o", "        return \"critical\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     if score >= 0.95:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.24344, "o", "        return \"healthy\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     if score >= 0.70:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.243517, "o", "        return \"degraded\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     return \"not_ready\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[18.243624, "o", "> \r\n\u001b[?2004l\r\u001b[?2004h> def main():\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.24364, "o", "    manifest_path = \"/app/deployment_manifest.yaml\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.243705, "o", "    output_path   = \"/app/deployment_report.json\"\r\n\u001b[?2004l\r"]
[18.243822, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     print(\"Loading deployment manifest ...\")\r\n\u001b[?2004l\r\u001b[?2004h>     services = load_services(manifest_path)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.243901, "o", "    print(\"Checking service health ...\")\r\n\u001b[?2004l\r\u001b[?2004h>     statuses = {}\r\n\u001b[?2004l\r\u001b[?2004h>     for svc in services:\r\n\u001b[?2004l\r\u001b[?2004h"]
[18.243946, "o", "> "]
[18.244142, "o", "        result = check_health(svc)\r\n\u001b[?2004l\r\u001b[?2004h>         statuses[svc[\"name\"]] = result\r\n\u001b[?2004l\r\u001b[?2004h>         print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.244288, "o", "    print(\"Computing startup order ...\")\r\n\u001b[?2004l\r\u001b[?2004h>     startup_order = compute_startup_order(services)\r\n\u001b[?2004l\r\u001b[?2004h>     print(f\"  {' -> '.join(startup_order)}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[18.244339, "o", "> "]
[18.244436, "o", "    print(\"Computing readiness score ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.24461, "o", "    score = compute_readiness_score(services, statuses)\r\n\u001b[?2004l\r\u001b[?2004h>     print(f\"  score = {score:.4f}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     overall_status, critical_ok = determine_status(services, statuses, score)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     report = {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.244759, "o", "        \"deployment_name\":           \"production-stack\",\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.244844, "o", "        \"overall_status\":            overall_status,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.244941, "o", "        \"readiness_score\":           score,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.245073, "o", "        \"service_statuses\":          statuses,\r\n\u001b[?2004l\r\u001b[?2004h>         \"startup_order\":             startup_order,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.245225, "o", "        \"critical_services_healthy\": critical_ok,\r\n\u001b[?2004l\r\u001b[?2004h>         \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.245268, "o", "    }\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.245317, "o", "    with open(output_path, \"w\") as f:\r\n\u001b[?2004l\r\u001b[?2004h>         json.dump(report, f, indent=2)\r\n"]
[18.245449, "o", "\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     print(f\"\\nReport written to {output_path}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.245561, "o", "    print(f\"Overall status : {overall_status}\")\r\n\u001b[?2004l\r\u001b[?2004h>     print(f\"Readiness score: {score}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.245585, "o", "\r\n\u001b[?2004l\r\u001b[?2004h> "]
[18.245705, "o", "if __name__ == \"__main__\":\r\n\u001b[?2004l\r\u001b[?2004h>     main()\r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[18.24671, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[23.906983, "i", "python3 << 'EOF'\nimport os\nwith open('/app/validator.py', 'w') as f:\n    f.write('''#!/usr/bin/env python3\n\"\"\"\nDeployment Health Validator\n===========================\nReads deployment_manifest.yaml, probes each service's health endpoint,\ncomputes a weighted readiness score, determines a valid startup ordering,\nand writes a deployment readiness report to /app/deployment_report.json.\n\"\"\"\n\nimport json\nimport yaml\nimport requests\nfrom datetime import datetime, timezone\nfrom collections import deque\n\n\ndef load_services(manifest_path: str) -> list:\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\n    with open(manifest_path) as f:\n        config = yaml.safe_load(f)\n    return config[\"deployment\"][\"services\"]\n\n\ndef check_health(service: dict) -> dict:\n    \"\"\"\n    Probe a single service and return its health record.\n    HTTP 200 -> healthy; anything else -> unhealthy.\n    \"\"\"\n    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\n    try:\n        resp = requests.get(url, timeout=5)\n        return {\n            \"status\": \"healthy\" if resp.status_code == 200 else \"unhealthy\",\n            \"http_status\": resp.status_code,\n            \"criticality\": service[\"criticality\"],\n        }\n    except requests.exceptions.RequestException:\n        return {\n            \"status\": \"unhealthy\",\n            \"http_status\": 0,\n            \"criticality\": service[\"criticality\"],\n        }\n\n\ndef compute_startup_order(services: list) -> list:\n    \"\"\"\n    Return a topologically sorted startup order using Kahn's algorithm.\n    Dependencies must start before the services that depend on them.\n    \"\"\"\n    names = [s[\"name\"] for s in services]\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\n\n    graph     = {n: [] for n in names}\n    in_degree = {n: 0 for n in names}\n\n    for svc, deps in deps_map.items():\n        for dep in deps:\n            graph[dep].append(svc)  # dep must come before svc\n            in_degree[svc] += 1\n\n    queue = deque(n for n in names if in_degree[n] == 0)\n    order = []\n    while queue:\n        node = queue.popleft()\n        order.append(node)\n        for neighbor in graph[node]:\n            in_degree[neighbor] -= 1\n            if in_degree[neighbor] == 0:\n                queue.append(neighbor)\n    return order\n\n\ndef compute_readiness_score(services: list, statuses: dict) -> float:\n    \"\"\"\n    Compute the weighted fraction of healthy services.\n    Criticality weights: high=3, medium=2, low=1.\n    \"\"\"\n    weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\n\n    total   = sum(weight_map[s[\"criticality\"]] for s in services)\n    healthy = sum(\n        weight_map[s[\"criticality\"]]\n        for s in services\n        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\n    )\n    return round(healthy / total, 4) if total else 0.0\n\n\ndef determine_status(services: list, statuses: dict, score: float):\n    \"\"\"\n    Returns (overall_status, critical_services_healthy).\n    \"\"\"\n    critical_ok = all(\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\n        for s in services\n        if s[\"criticality\"] == \"high\"\n    )\n\n    if not critical_ok:\n        return \"critical\", critical_ok\n    if score >= 0.95:\n        return \"healthy\", critical_ok\n    if score >= 0.70:\n        return \"degraded\", critical_ok\n    return \"not_ready\", critical_ok\n\n\ndef main():\n    manifest_path = \"/app/deployment_manifest.yaml\"\n    output_path   = \"/app/deployment_report.json\"\n\n    print(\"Loading deployment manifest ...\")\n    services = load_services(manifest_path)\n\n    print(\"Checking service health ...\")\n    statuses = {}\n    for svc in services:\n        result = check_health(svc)\n        statuses[svc[\"name\"]] = result\n        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\n\n    print(\"Computing startup order ...\")\n    startup_order = compute_startup_order(services)\n    print(f\"  {' -> '.join(startup_order)}\")\n\n    print(\"Computing readiness score ...\")\n    score = compute_readiness_score(services, statuses)\n    print(f\"  score = {score:.4f}\")\n\n    overall_status, critical_ok = determine"]
[23.907349, "i", "_status(services, statuses, score)\n\n    report = {\n        \"deployment_name\":           \"production-stack\",\n        \"overall_status\":            overall_status,\n        \"readiness_score\":           score,\n        \"service_statuses\":          statuses,\n        \"startup_order\":             startup_order,\n        \"critical_services_healthy\": critical_ok,\n        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\n    }\n\n    with open(output_path, \"w\") as f:\n        json.dump(report, f, indent=2)\n\n    print(f\"\\\\nReport written to {output_path}\")\n    print(f\"Overall status : {overall_status}\")\n    print(f\"Readiness score: {score}\")\n\n\nif __name__ == \"__main__\":\n    main()\n''')\nprint(\"Fixed validator.py created successfully\")\nEOF\n"]
[23.908161, "o", "python3 << 'EOF'\r\n\u001b[?2004l\r_status(services,\u001b[?2004h> import os\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.909088, "o", "with open('/app/validator.py', 'w') as f:\r\n\u001b[?2004l\r"]
[23.909435, "o", "\u001b[?2004h> "]
[23.90963, "o", "    f.write('''#!/usr/bin/env python3\r\n\u001b[?2004l\r,"]
[23.909687, "o", "\u001b[?2004h> \"\"\"\r\n\u001b[?2004l\r\r\n   \u001b[?2004h> "]
[23.909941, "o", "Deployment Health Validator\r\n\u001b[?2004l\r    \u001b[?2004h"]
[23.910108, "o", "> ===========================\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.910166, "o", "Reads deployment_manifest.yaml, probes each service's health endpoint,\r\n\u001b[?2004l\r"]
[23.910182, "o", "\u001b[?2004h> "]
[23.910459, "o", "computes a weighted readiness score, determines a valid startup ordering,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.910569, "o", "and writes a deployment readiness report to /app/deployment_report.json.\r\n\u001b[?2004l\r          "]
[23.910589, "o", "\u001b[?2004h> \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.910684, "o", "import json\r\n\u001b[?2004l\rno\u001b[?2004h> import yaml\r\n\u001b[?2004l\r\u001b[?2004h> import requests\r\n\u001b[?2004l\r(),"]
[23.910854, "o", "\u001b[?2004h> "]
[23.910892, "o", "from datetime import datetime, timezone\r\n\u001b[?2004l\r\u001b[?2004h> from collections import deque\r\n\u001b[?2004l\r_path, \"w\") as f:\r\n        json.dump(report\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def load_services(manifest_path: str) -> list:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.911188, "o", "    \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     with open(manifest_path) as f:\r\n\u001b[?2004l\r\u001b[?2004h>         config = yaml.safe_load(f)\r\n\u001b[?2004l\ra\u001b[?2004h>     return config[\"deployment\"][\"services\"]\r\n\u001b[?2004l\rd \u001b[?2004h> \r\n\u001b[?2004l\r"]
[23.911492, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.911577, "o", "def check_health(service: dict) -> dict:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.911638, "o", "    Probe a single service and return its health record.\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.911718, "o", "    HTTP 200 -> healthy; anything else -> unhealthy.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.912155, "o", "    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\r\n\u001b[?2004l\r"]
[23.912208, "o", "\u001b[?2004h> "]
[23.912231, "o", "    try:\r\n\u001b[?2004l\r"]
[23.912303, "o", "\u001b[?2004h> "]
[23.91241, "o", "        resp = requests.get(url, timeout=5)"]
[23.912461, "o", "\r\n\u001b[?2004l\r"]
[23.912526, "o", "\u001b[?2004h> "]
[23.912582, "o", "        return {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.912976, "o", "            \"status\": \"healthy\" if resp.status_code == 200 else \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.913055, "o", "            \"http_status\": resp.status_code,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.91311, "o", "            \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r"]
[23.91316, "o", "\u001b[?2004h>         }"]
[23.913228, "o", "\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.913424, "o", "    except requests.exceptions.RequestException:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.913442, "o", "        return {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.913503, "o", "            \"status\": \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.913562, "o", "> "]
[23.913695, "o", "            \"http_status\": 0,\r\n\u001b[?2004l\r"]
[23.913739, "o", "\u001b[?2004h> "]
[23.913785, "o", "            \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r"]
[23.913855, "o", "\u001b[?2004h> "]
[23.913912, "o", "        }\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[23.913943, "o", "\u001b[?2004h"]
[23.914004, "o", "> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.914174, "o", "def compute_startup_order(services: list) -> list:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r"]
[23.914225, "o", "\u001b[?2004h> "]
[23.914283, "o", "    Return a topologically sorted startup order using Kahn's algorithm.\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.914349, "o", "> "]
[23.91459, "o", "    Dependencies must start before the services that depend on them.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r"]
[23.914656, "o", "\u001b[?2004h> "]
[23.91485, "o", "    names = [s[\"name\"] for s in services]\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.914947, "o", "    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.915055, "o", "    graph     = {n: [] for n in names}\r\n\u001b[?2004l\r"]
[23.915112, "o", "\u001b[?2004h> "]
[23.915195, "o", "    in_degree = {n: 0 for n in names}\r\n\u001b[?2004l\r"]
[23.915273, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     for svc, deps in deps_map.items():"]
[23.915346, "o", "\r\n\u001b[?2004l\r"]
[23.91539, "o", "\u001b[?2004h> "]
[23.915445, "o", "        for dep in deps:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.915575, "o", "            graph[dep].append(svc)  # dep must come before svc\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.915619, "o", "            in_degree[svc] += 1\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.915774, "o", "    queue = deque(n for n in names if in_degree[n] == 0)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.915808, "o", "    order = []\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.915816, "o", "    while queue:\r\n\u001b[?2004l\r"]
[23.915905, "o", "\u001b[?2004h> "]
[23.915983, "o", "        node = queue.popleft()\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.916024, "o", "        order.append(node)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.916142, "o", "        for neighbor in graph[node]:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.9162, "o", "            in_degree[neighbor] -= 1\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.916279, "o", "            if in_degree[neighbor] == 0:\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.916323, "o", "> "]
[23.916431, "o", "                queue.append(neighbor)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.916461, "o", "    return order\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[23.916475, "o", "> \r\n\u001b[?2004l\r\u001b[?2004h"]
[23.916546, "o", "> "]
[23.916685, "o", "def compute_readiness_score(services: list, statuses: dict) -> float:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.916722, "o", "    \"\"\"\r\n\u001b[?2004l\r"]
[23.916743, "o", "\u001b[?2004h> "]
[23.916835, "o", "    Compute the weighted fraction of healthy services.\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.916921, "o", "    Criticality weights: high=3, medium=2, low=1.\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.916941, "o", "    \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.91697, "o", "> "]
[23.917091, "o", "    weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[23.917141, "o", "\u001b[?2004h> "]
[23.917227, "o", "    total   = sum(weight_map[s[\"criticality\"]] for s in services)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.917283, "o", "    healthy = sum(\r\n\u001b[?2004l\r"]
[23.917338, "o", "\u001b[?2004h> "]
[23.917431, "o", "        weight_map[s[\"criticality\"]]\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.917479, "o", "        for s in services\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.917534, "o", "        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>     )\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.917585, "o", "    return round(healthy / total, 4) if total else 0.0\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[23.917624, "o", "\u001b[?2004h> "]
[23.917686, "o", "def determine_status(services: list, statuses: dict, score: float):\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.917736, "o", ">     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.91779, "o", "    Returns (overall_status, critical_services_healthy).\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.917823, "o", "    critical_ok = all(\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.917855, "o", "        statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.917897, "o", "        for s in services\r\n\u001b[?2004l\r"]
[23.917923, "o", "\u001b[?2004h> "]
[23.917941, "o", "        if s[\"criticality\"] == \"high\"\r\n\u001b[?2004l\r\u001b[?2004h>     )\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[23.917982, "o", "\u001b[?2004h> "]
[23.917994, "o", "    if not critical_ok:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.91805, "o", "        return \"critical\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     if score >= 0.95:\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.918108, "o", "> "]
[23.918137, "o", "        return \"healthy\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     if score >= 0.70:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918183, "o", "        return \"degraded\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918237, "o", "    return \"not_ready\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[23.918267, "o", "> \r\n\u001b[?2004l\r\u001b[?2004h> def main():\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918318, "o", "    manifest_path = \"/app/deployment_manifest.yaml\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918366, "o", "    output_path   = \"/app/deployment_report.json\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918409, "o", "    print(\"Loading deployment manifest ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918471, "o", "    services = load_services(manifest_path)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918525, "o", "    print(\"Checking service health ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918564, "o", "    statuses = {}\r\n\u001b[?2004l\r\u001b[?2004h>     for svc in services:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918606, "o", "        result = check_health(svc)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918657, "o", "        statuses[svc[\"name\"]] = result\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918733, "o", "        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[23.918781, "o", "\u001b[?2004h> "]
[23.918838, "o", "    print(\"Computing startup order ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918896, "o", "    startup_order = compute_startup_order(services)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918947, "o", "    print(f\"  {' -> '.join(startup_order)}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.918993, "o", "    print(\"Computing readiness score ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.919036, "o", "    score = compute_readiness_score(services, statuses)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.919059, "o", "    print(f\"  score = {score:.4f}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.919404, "o", "    overall_status, critical_ok = determine_status(services, statuses, score)\r\n\u001b[?2004l\r"]
[23.919468, "o", "\u001b[?2004h"]
[23.919535, "o", "> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.919623, "o", "    report = {"]
[23.919696, "o", "\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.919755, "o", "> "]
[23.91993, "o", "        \"deployment_name\":           \"production-stack\","]
[23.919971, "o", "\r\n\u001b[?2004l\r"]
[23.919996, "o", "\u001b[?2004h"]
[23.920038, "o", "> "]
[23.920356, "o", "        \"overall_status\":            overall_status,\r\n"]
[23.920405, "o", "\u001b[?2004l\r"]
[23.920452, "o", "\u001b[?2004h> "]
[23.920573, "o", "        \"readiness_score\":           score,\r\n\u001b[?2004l\r"]
[23.920679, "o", "\u001b[?2004h>         \"service_statuses\":          statuses,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.920923, "o", "        \"startup_order\":             startup_order,"]
[23.92098, "o", "\r\n"]
[23.921048, "o", "\u001b[?2004l\r\u001b[?2004h> "]
[23.921217, "o", "        \"critical_services_healthy\": critical_ok,\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.921235, "o", "> "]
[23.921344, "o", "        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\r\n\u001b[?2004l\r"]
[23.921412, "o", "\u001b[?2004h>     }\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[23.921528, "o", "\u001b[?2004h"]
[23.921557, "o", "> "]
[23.921636, "o", "    with open(output_path, \"w\") as f:\r\n\u001b[?2004l\r"]
[23.921672, "o", "\u001b[?2004h> "]
[23.921723, "o", "        json.dump(report, f, indent=2)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.921782, "o", "\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.921837, "o", "> "]
[23.921944, "o", "    print(f\"\\\\nReport written to {output_path}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.921987, "o", "    print(f\"Overall status : {overall_status}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[23.922058, "o", "    print(f\"Readiness score: {score}\")\r\n\u001b[?2004l\r"]
[23.922112, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[23.922158, "o", "\u001b[?2004h> "]
[23.922201, "o", "if __name__ == \"__main__\":"]
[23.922265, "o", "\r\n"]
[23.922298, "o", "\u001b[?2004l\r\u001b[?2004h"]
[23.922332, "o", "> "]
[23.922393, "o", "    main()\r\n\u001b[?2004l\r\u001b[?2004h> ''')\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.922424, "o", "> "]
[23.922546, "o", "print(\"Fixed validator.py created successfully\")\r\n\u001b[?2004l\r\u001b[?2004h"]
[23.922564, "o", "> EOF\r\n"]
[23.922626, "o", "\u001b[?2004l\r"]
[23.931568, "o", "Fixed validator.py created successfully\r\n"]
[23.933005, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[27.361872, "i", "python /app/validator.py\n"]
[27.362258, "o", "python /app/validator.py\r\n\u001b[?2004l\r"]
[27.441134, "o", "Loading deployment manifest ...\r\n"]
[27.442458, "o", "Checking service health ...\r\n"]
[27.443219, "o", "  auth-service              unhealthy  (HTTP 0)\r\n"]
[27.443547, "o", "  api-gateway               unhealthy  (HTTP 0)\r\n"]
[27.443781, "o", "  cache-service             unhealthy  (HTTP 0)\r\n"]
[27.444088, "o", "  worker-service            unhealthy  (HTTP 0)\r\n"]
[27.444308, "o", "  notification-service      unhealthy  (HTTP 0)\r\nComputing startup order ...\r\n  auth-service -> cache-service -> api-gateway -> worker-service -> notification-service\r\nComputing readiness score ...\r\n"]
[27.444323, "o", "  score = 0.0000\r\n"]
[27.444532, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : critical\r\nReadiness score: 0.0\r\n"]
[27.458493, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[31.265283, "i", "curl http://localhost:8081/health\n"]
[31.266379, "o", "curl http://localhost:8081/health\r\n\u001b[?2004l\r"]
[31.275528, "o", "curl: (7) Failed to connect to localhost port 8081 after 0 ms: Could not connect to server\r\n"]
[31.276135, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[34.751491, "i", "ps aux | grep python\n"]
[34.752086, "o", "ps aux | grep python\r\n\u001b[?2004l\r"]
[34.752333, "o", "bash: ps: command not found\r\n"]
[34.752939, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[36.124577, "i", "python /app/mock_services.py &\n"]
[36.124991, "o", "python /app/mock_services.py &\r\n\u001b[?2004l\r[1] 743\r\n\u001b[?2004hroot@b3729034f076:/app# "]
[36.257996, "o", "  started  auth-service         /health  -> http://0.0.0.0:8081\r\n"]
[36.258421, "o", " * Serving Flask app 'auth-service'\r\n"]
[36.258535, "o", "  started  api-gateway          /health  -> http://0.0.0.0:8082\r\n"]
[36.258677, "o", " * Serving Flask app 'api-gateway'\r\n"]
[36.258873, "o", "  started  cache-service        /ping    -> http://0.0.0.0:8083\r\n"]
[36.259073, "o", " * Debug mode: off\r\n"]
[36.259324, "o", " * Serving Flask app 'cache-service'\r\n"]
[36.25938, "o", " * Debug mode: off\r\n"]
[36.259484, "o", " * Serving Flask app 'worker-service'\r\n * Debug mode: off\r\n * Debug mode: off\r\n  started  worker-service       /status  -> http://0.0.0.0:8084\r\n"]
[36.259733, "o", " * Serving Flask app 'notification-service'\r\n"]
[36.259874, "o", " * Debug mode: off\r\n"]
[36.26001, "o", "  started  notification-service /health  -> http://0.0.0.0:8085\r\nAll mock services running. Ctrl-C to stop.\r\n"]
[39.778142, "i", "curl http://localhost:8081/health\n"]
[39.779772, "o", "curl http://localhost:8081/health\r\n\u001b[?2004l\r"]
[39.81149, "o", "{\"status\":\"ok\",\"version\":\"2.1.0\"}\r\n"]
[39.81217, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[42.429558, "i", "curl http://localhost:8083/ping\n"]
[42.438363, "o", "curl http://localhost:8083/ping\r\n\u001b[?2004l\r"]
[42.484301, "o", "pong"]
[42.484493, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[44.686884, "i", "python /app/validator.py\n"]
[44.687442, "o", "python /app/validator.py\r\n\u001b[?2004l\r"]
[44.771905, "o", "Loading deployment manifest ...\r\n"]
[44.773328, "o", "Checking service health ...\r\n"]
[44.775762, "o", "  auth-service              healthy    (HTTP 200)\r\n"]
[44.776883, "o", "  api-gateway               healthy    (HTTP 200)\r\n"]
[44.777953, "o", "  cache-service             healthy    (HTTP 200)\r\n"]
[44.778855, "o", "  worker-service            unhealthy  (HTTP 503)\r\n"]
[44.779572, "o", "  notification-service      healthy    (HTTP 200)\r\nComputing startup order ...\r\n  auth-service -> cache-service -> api-gateway -> worker-service -> notification-service\r\nComputing readiness score ...\r\n"]
[44.779593, "o", "  score = 0.9000\r\n"]
[44.779888, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : degraded\r\nReadiness score: 0.9\r\n"]
[44.789347, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[48.429015, "i", "cat /app/deployment_report.json\n"]
[48.431429, "o", "cat /app/deployment_report.json\r\n\u001b[?2004l\r"]
[48.431545, "o", "{\r\n  \"deployment_name\": \"production-stack\",\r\n  \"overall_status\": \"degraded\",\r\n  \"readiness_score\": 0.9,\r\n  \"service_statuses\": {\r\n    \"auth-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"api-gateway\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"cache-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"medium\"\r\n    },\r\n    \"worker-service\": {\r\n      \"status\": \"unhealthy\",\r\n      \"http_status\": 503,\r\n      \"criticality\": \"low\"\r\n    },\r\n    \"notification-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"low\"\r\n    }\r\n  },\r\n  \"startup_order\": [\r\n    \"auth-service\",\r\n    \"cache-service\",\r\n    \"api-gateway\",\r\n    \"worker-service\",\r\n    \"notification-service\"\r\n  ],\r\n  \"critical_services_healthy\": true,\r\n  \"timestamp\": \"2026-02-27T19:26:39.707959+00:00\"\r\n}\u001b[?2004hroot@b3729034f076:/app# "]
[52.093742, "i", "echo \"Manual calculation:\"\necho \"Healthy weights: 3+3+2+1 = 9\"\necho \"Total weights: 3+3+2+1+1 = 10\"\necho \"Score: 9/10 = 0.9 ✓\"\n"]
[52.110829, "o", "echo \"Manual calculation:\"\r\n\u001b[?2004l\rManual calculation:\r\n\u001b[?2004hroot@b3729034f076:/app# echo \"Healthy weights: 3+3+2+1 = 9\"\r\n\u001b[?2004l\rHealthy weights: 3+3+2+1 = 9\r\n\u001b[?2004hroot@b3729034f076:/app# echo \"Total weights: 3+3+2+1+1 = 10\"\r\n\u001b[?2004l\rTotal weights: 3+3+2+1+1 = 10\r\n\u001b[?2004hroot@b3729034f076:/app# echo \"Score: 9/10 = 0.9 ✓\""]
[52.122019, "o", "\r\n\u001b[?2004l\rScore: 9/10 = 0.9 ✓\r\n\u001b[?2004hroot@b3729034f076:/app# "]
[54.693695, "i", "python /app/validator.py\n"]
[54.694064, "o", "python /app/validator.py\r\n\u001b[?2004l\r"]
[54.786132, "o", "Loading deployment manifest ...\r\n"]
[54.787508, "o", "Checking service health ...\r\n"]
[54.792691, "o", "  auth-service              healthy    (HTTP 200)\r\n"]
[54.793804, "o", "  api-gateway               healthy    (HTTP 200)\r\n"]
[54.794816, "o", "  cache-service             healthy    (HTTP 200)\r\n"]
[54.795641, "o", "  worker-service            unhealthy  (HTTP 503)\r\n"]
[54.796579, "o", "  notification-service      healthy    (HTTP 200)\r\nComputing startup order ...\r\n  auth-service -> cache-service -> api-gateway -> worker-service -> notification-service\r\nComputing readiness score ...\r\n"]
[54.796604, "o", "  score = 0.9000\r\n"]
[54.796906, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : degraded\r\nReadiness score: 0.9\r\n"]
[54.807849, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[61.397386, "i", "echo \"Checking JSON schema validation...\"\npython3 -c \"import json; report = json.load(open('/app/deployment_report.json')); print('✓ JSON is valid'); print('deployment_name:', report['deployment_name']); print('overall_status:', report['overall_status']); print('readiness_score:', report['readiness_score']); print('startup_order:', report['startup_order']); print('critical_services_healthy:', report['critical_services_healthy'])\"\n"]
[61.398741, "o", "echo \"Checking JSON schema validation...\"\r\n\u001b[?2004l\rChecking JSON schema validation...\r\n\u001b[?2004hroot@b3729034f076:/app# python3 -c \"import json; report = json.load(open('/app/deployment_report.json')); print('✓ JSON is valid'); print('deployment_name:', report['deployment_name']); print('overall_status:', report['overall_status']); print('readiness_score:', report['readiness_score']); print('startup_order:', report['startup_order']); print('critical_services_healthy:', report['critical_services_healthy'])\"\r\n\u001b[?2004l\r"]
[61.41025, "o", "✓ JSON is valid\r\ndeployment_name: production-stack\r\noverall_status: degraded\r\nreadiness_score: 0.9\r\nstartup_order: ['auth-service', 'cache-service', 'api-gateway', 'worker-service', 'notification-service']\r\ncritical_services_healthy: True\r\n"]
[61.412567, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
[64.676675, "i", "echo \"Verifying topological sort correctness...\"\necho \"From manifest: api-gateway depends on auth-service and cache-service\"\necho \"Startup order shows: auth-service -> cache-service -> api-gateway ✓\"\necho \"This is correct - dependencies start before dependents\"\necho \"\"\necho \"Checking service_statuses structure:\"\npython3 -c \"import json; report = json.load(open('/app/deployment_report.json')); [print(f'{k}: {v}') for k,v in report['service_statuses'].items()]\"\n"]
[64.677207, "o", "echo \"Verifying topological sort correctness...\"\r\n\u001b[?2004l\r"]
[64.677373, "o", "Verifying topological sort correctness...\r\n\u001b[?2004hroot@b3729034f076:/app# "]
[64.677418, "o", "echo \"From manifest: api-gateway depends on auth-service and cache-service\"\r\n\u001b[?2004l\r"]
[64.678221, "o", "From manifest: api-gateway depends on auth-service and cache-service\r\n\u001b[?2004hroot@b3729034f076:/app# echo \"Startup order shows: auth-service -> cache-service -> api-gateway ✓\"\r\n\u001b[?2004l\rStartup order shows: auth-service -> cache-service -> api-gateway ✓\r\n\u001b[?2004hroot@b3729034f076:/app# echo \"This is correct - dependencies start before dependents\"\r\n\u001b[?2004l\rThis is correct - dependencies start before dependents\r\n\u001b[?2004hroot@b3729034f076:/app# echo \"\"\r\n\u001b[?2004l\r\r\n\u001b[?2004hroot@b3729034f076:/app# echo \"Checking service_statuses structure:\"\r\n\u001b[?2004l\rChecking service_statuses structure:\r\n\u001b[?2004hroot@b3729034f076:/app# python3 -c \"import json; report = json.load(open('/app/deployment_report.json')); [print(f'{k}: {v}') for k,v in report['service_statuses'].items()]\"\r\n\u001b[?2004l\r"]
[64.690922, "o", "auth-service: {'status': 'healthy', 'http_status': 200, 'criticality': 'high'}\r\napi-gateway: {'status': 'healthy', 'http_status': 200, 'criticality': 'high'}\r\ncache-service: {'status': 'healthy', 'http_status': 200, 'criticality': 'medium'}\r\nworker-service: {'status': 'unhealthy', 'http_status': 503, 'criticality': 'low'}\r\nnotification-service: {'status': 'healthy', 'http_status': 200, 'criticality': 'low'}\r\n"]
[64.692721, "o", "\u001b[?2004hroot@b3729034f076:/app# "]
