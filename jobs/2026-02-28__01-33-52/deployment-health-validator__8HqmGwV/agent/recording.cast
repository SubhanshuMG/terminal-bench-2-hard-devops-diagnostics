{"version": 2, "width": 160, "height": 40, "timestamp": 1772222651, "env": {"SHELL": "/bin/bash", "TERM": "tmux-256color"}}
[0.001702, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[0.984157, "i", "clear\r"]
[0.98429, "o", "clear\r\n\u001b[?2004l\r"]
[0.985039, "o", "\u001b[H\u001b[J\u001b[3J"]
[0.98539, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[2.255229, "i", "ls -la\n"]
[2.255543, "o", "ls -la\r\n\u001b[?2004l\r"]
[2.256256, "o", "total 32\r\ndrwxr-xr-x 1 root root 4096 Feb 27 19:44 .\r\ndrwxr-xr-x 1 root root 4096 Feb 27 20:04 ..\r\n-rw-r--r-- 1 root root  698 Feb 27 19:10 Dockerfile\r\n-rw-r--r-- 1 root root 2068 Feb 27 19:22 deployment_manifest.yaml\r\n-rw-r--r-- 1 root root 3096 Feb 27 18:52 mock_services.py\r\n-rw-r--r-- 1 root root   44 Feb 27 18:53 requirements.txt\r\n-rw-r--r-- 1 root root 6818 Feb 27 19:41 validator.py\r\n"]
[2.256462, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[3.258739, "i", "cat deployment_manifest.yaml\n"]
[3.25892, "o", "cat deployment_manifest.yaml\r\n\u001b[?2004l\r"]
[3.259754, "o", "# ─────────────────────────────────────────────────────────────────────────────\r\n# deployment_manifest.yaml\r\n#\r\n# Deployment descriptor for the production stack.\r\n#\r\n# Schema notes:\r\n#   • The top-level 'services' block is a legacy v1 monitoring registry read\r\n#     by the external health-dashboard and alert-manager sidecar.  It is NOT\r\n#     the authoritative list for deployment ordering or health validation.\r\n#   • The authoritative service definitions live under 'deployment.services'.\r\n# ─────────────────────────────────────────────────────────────────────────────\r\n\r\n# Legacy monitoring-registry endpoint  (consumed by alert-manager, not by the validator)\r\nservices:\r\n  - name: \"metrics-collector\"\r\n    port: 9091\r\n    health_endpoint: \"/metrics\"\r\n    dependencies: []\r\n    criticality: \"low\"\r\n\r\n# ── Authoritative deployment configuration ────────────────────────────────────\r\ndeployment:\r\n  name: \"production-stack\"\r\n\r\n  services:\r\n    - name: \"auth-service\"\r\n      port: 8081\r\n      health_endpoint: \"/health\"\r\n      dependencies: []\r\n      criticality: \"high\"\r\n\r\n    - name: \"api-gateway\"\r\n      port: 8082\r\n      health_endpoint: \"/health\"\r\n      dependencies:\r\n        - \"auth-service\"\r\n        - \"cache-service\"\r\n      criticality: \"high\"\r\n\r\n    - name: \"cache-service\"\r\n      port: 8083\r\n      health_endpoint: \"/ping\"\r\n      dependencies: []\r\n      criticality: \"medium\"\r\n\r\n    - name: \"worker-service\"\r\n      port: 8084\r\n      health_endpoint: \"/status\"\r\n      dependencies:\r\n        - \"api-gateway\"\r\n        - \"cache-service\"\r\n      criticality: \"low\"\r\n\r\n    - name: \"notification-service\"\r\n      port: 8085\r\n      health_endpoint: \"/health\"\r\n      dependencies:\r\n        - \"worker-service\"\r\n      criticality: \"low\"\r\n"]
[3.260003, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[4.476242, "i", "curl http://localhost:8081/health\n"]
[4.476582, "o", "curl http://localhost:8081/health\r\n"]
[4.477013, "o", "\u001b[?2004l\r"]
[4.483223, "o", "curl: (7) Failed to connect to localhost port 8081 after 0 ms: Could not connect to server\r\n"]
[4.48377, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[5.537376, "i", "ps aux\n"]
[5.537574, "o", "ps aux\r\n\u001b[?2004l\r"]
[5.537783, "o", "bash: ps: command not found\r\n"]
[5.537972, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[6.576384, "i", "cat mock_services.py\n"]
[6.577095, "o", "cat mock_services.py\r\n\u001b[?2004l\r"]
[6.577222, "o", "#!/usr/bin/env python3\r\n\"\"\"\r\nMock service health endpoints for the deployment stack.\r\n\r\nServices:\r\n  auth-service        -> port 8081  /health  -> 200\r\n  api-gateway         -> port 8082  /health  -> 200\r\n  cache-service       -> port 8083  /ping    -> 200\r\n  worker-service      -> port 8084  /status  -> 503  (degraded)\r\n  notification-service-> port 8085  /health  -> 200\r\n\"\"\"\r\n\r\nimport threading\r\nfrom flask import Flask, jsonify\r\n\r\nimport logging\r\nlog = logging.getLogger(\"werkzeug\")\r\nlog.setLevel(logging.ERROR)\r\n\r\n# ── auth-service ──────────────────────────────────────────────────────────────\r\nauth_app = Flask(\"auth-service\")\r\n\r\n@auth_app.route(\"/health\")\r\ndef auth_health():\r\n    return jsonify({\"status\": \"ok\", \"version\": \"2.1.0\"}), 200\r\n\r\n\r\n# ── api-gateway ───────────────────────────────────────────────────────────────\r\ngateway_app = Flask(\"api-gateway\")\r\n\r\n@gateway_app.route(\"/health\")\r\ndef gateway_health():\r\n    return jsonify({\"status\": \"healthy\", \"uptime_seconds\": 3601}), 200\r\n\r\n\r\n# ── cache-service  (uses /ping, NOT /health) ──────────────────────────────────\r\ncache_app = Flask(\"cache-service\")\r\n\r\n@cache_app.route(\"/ping\")\r\ndef cache_ping():\r\n    return \"pong\", 200\r\n\r\n\r\n# ── worker-service  (uses /status, returns 503 — intentionally degraded) ──────\r\nworker_app = Flask(\"worker-service\")\r\n\r\n@worker_app.route(\"/status\")\r\ndef worker_status():\r\n    return jsonify({\"status\": \"degraded\", \"queue_depth\": 1482}), 503\r\n\r\n\r\n# ── notification-service ──────────────────────────────────────────────────────\r\nnotif_app = Flask(\"notification-service\")\r\n\r\n@notif_app.route(\"/health\")\r\ndef notif_health():\r\n    return jsonify({\"status\": \"ok\", \"pending_notifications\": 0}), 200\r\n\r\n\r\n# ── runner ────────────────────────────────────────────────────────────────────\r\ndef _run(app, port):\r\n    app.run(host=\"0.0.0.0\", port=port, debug=False, use_reloader=False)\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    specs = [\r\n        (auth_app,    8081, \"auth-service         /health\"),\r\n        (gateway_app, 8082, \"api-gateway          /health\"),\r\n        (cache_app,   8083, \"cache-service        /ping  \"),\r\n        (worker_app,  8084, \"worker-service       /status\"),\r\n        (notif_app,   8085, \"notification-service /health\"),\r\n    ]\r\n\r\n    threads = []\r\n    for app, port, label in specs:\r\n        t = threading.Thread(target=_run, args=(app, port), daemon=True)\r\n        t.start()\r\n        threads.append(t)\r\n        print(f\"  started  {label}  -> http://0.0.0.0:{port}\")\r\n\r\n    print(\"All mock services running. Ctrl-C to stop.\")\r\n    for t in threads:\r\n        t.join()\r\n\u001b[?2004hroot@f07828e7747d:/app# "]
[7.670017, "i", "python3 mock_services.py &\n"]
[7.670205, "o", "python3 mock_services.py &\r\n\u001b[?2004l\r"]
[7.670348, "o", "[1] 627\r\n"]
[7.670454, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[7.770459, "o", "  started  auth-service         /health  -> http://0.0.0.0:8081\r\n"]
[7.770632, "o", " * Serving Flask app 'auth-service'\r\n * Debug mode: off"]
[7.770655, "o", "\r\n"]
[7.770981, "o", " * Serving Flask app 'api-gateway'\r\n"]
[7.771059, "o", "  started  api-gateway          /health  -> http://0.0.0.0:8082\r\n"]
[7.771139, "o", " * Debug mode: off\r\n"]
[7.771371, "o", " * Serving Flask app 'cache-service'\r\n * Debug mode: off\r\n"]
[7.771392, "o", "  started  cache-service        /ping    -> http://0.0.0.0:8083\r\n"]
[7.771567, "o", "  started  worker-service       /status  -> http://0.0.0.0:8084\r\n"]
[7.771796, "o", "  started  notification-service /health  -> http://0.0.0.0:8085\r\nAll mock services running. Ctrl-C to stop.\r\n"]
[7.772016, "o", " * Serving Flask app 'notification-service'\r\n * Debug mode: off\r\n"]
[7.772142, "o", " * Serving Flask app 'worker-service'\r\n * Debug mode: off\r\n"]
[10.869478, "i", "curl http://localhost:8081/health\n"]
[10.870348, "o", "curl http://localhost:8081/health\r\n\u001b[?2004l\r"]
[10.87724, "o", "{\"status\":\"ok\",\"version\":\"2.1.0\"}\r\n"]
[10.877825, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[11.884958, "i", "curl http://localhost:8083/ping\n"]
[11.885164, "o", "curl http://localhost:8083/ping\r\n\u001b[?2004l\r"]
[11.89093, "o", "pong"]
[11.891466, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[12.885369, "i", "cat validator.py\n"]
[12.886115, "o", "cat validator.py\r\n\u001b[?2004l\r"]
[12.886836, "o", "#!/usr/bin/env python3\r\n\"\"\"\r\nDeployment Health Validator\r\n===========================\r\nReads deployment_manifest.yaml, probes each service's health endpoint,\r\ncomputes a weighted readiness score, determines a valid startup ordering,\r\nand writes a deployment readiness report to /app/deployment_report.json.\r\n\"\"\"\r\n\r\nimport json\r\nimport yaml\r\nimport requests\r\nfrom datetime import datetime, timezone\r\nfrom collections import deque\r\n\r\n\r\n# ── 1. Load manifest ──────────────────────────────────────────────────────────\r\n\r\ndef load_services(manifest_path: str) -> list:\r\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n    with open(manifest_path) as f:\r\n        config = yaml.safe_load(f)\r\n    # Returns the top-level 'services' list from the manifest.\r\n    return config[\"services\"]\r\n\r\n\r\n# ── 2. Health check ───────────────────────────────────────────────────────────\r\n\r\ndef check_health(service: dict) -> dict:\r\n    \"\"\"\r\n    Probe a single service and return its health record.\r\n\r\n    A service is healthy when:\r\n    - HTTP response status is 200, AND\r\n    - For JSON responses: the body's 'status' field is an accepted value.\r\n    - For non-JSON responses (e.g. plain text): HTTP 200 alone is sufficient.\r\n    \"\"\"\r\n    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\r\n    try:\r\n        resp = requests.get(url, timeout=5)\r\n        if resp.status_code != 200:\r\n            return {\r\n                \"status\": \"unhealthy\",\r\n                \"http_status\": resp.status_code,\r\n                \"criticality\": service[\"criticality\"],\r\n            }\r\n        # For JSON responses, also verify the status field in the body.\r\n        try:\r\n            body = resp.json()\r\n            status_ok = body.get(\"status\", \"ok\") in (\"ok\", \"up\")\r\n        except ValueError:\r\n            status_ok = True  # Non-JSON body (e.g. \"pong\") — HTTP 200 is enough.\r\n        return {\r\n            \"status\": \"healthy\" if status_ok else \"unhealthy\",\r\n            \"http_status\": resp.status_code,\r\n            \"criticality\": service[\"criticality\"],\r\n        }\r\n    except requests.exceptions.RequestException:\r\n        return {\r\n            \"status\": \"unhealthy\",\r\n            \"http_status\": 0,\r\n            \"criticality\": service[\"criticality\"],\r\n        }\r\n\r\n\r\n# ── 3. Startup ordering ───────────────────────────────────────────────────────\r\n\r\ndef compute_startup_order(services: list) -> list:\r\n    \"\"\"\r\n    Return a topologically sorted startup order using Kahn's algorithm.\r\n    Dependencies must start before the services that depend on them.\r\n    \"\"\"\r\n    names = [s[\"name\"] for s in services]\r\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\r\n    graph     = {n: [] for n in names}\r\n    in_degree = {n: 0 for n in names}\r\n\r\n    for svc, deps in deps_map.items():\r\n        for dep in deps:\r\n            graph[svc].append(dep)\r\n            in_degree[dep] += 1\r\n\r\n    queue = deque(n for n in names if in_degree[n] == 0)\r\n    order = []\r\n    while queue:\r\n        node = queue.popleft()\r\n        order.append(node)\r\n        for neighbor in graph[node]:\r\n            in_degree[neighbor] -= 1\r\n            if in_degree[neighbor] == 0:\r\n                queue.append(neighbor)\r\n    return order\r\n\r\n\r\n# ── 4. Readiness score ────────────────────────────────────────────────────────\r\n\r\ndef compute_readiness_score(services: list, statuses: dict) -> float:\r\n    \"\"\"\r\n    Compute the weighted fraction of healthy services.\r\n    Criticality weights: high=3, medium=2, low=1.\r\n    \"\"\"\r\n    weight_map = {\"high\": 1, \"medium\": 1, \"low\": 1}\r\n\r\n    total   = sum(weight_map[s[\"criticality\""]
[12.886849, "o", "]] for s in services)\r\n    healthy = sum(\r\n        weight_map[s[\"criticality\"]]\r\n        for s in services\r\n        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n    )\r\n    return round(healthy / total, 4) if total else 0.0\r\n\r\n\r\n# ── 5. Overall status ─────────────────────────────────────────────────────────\r\n\r\ndef determine_status(services: list, statuses: dict, score: float):\r\n    \"\"\"\r\n    Returns (overall_status, critical_services_healthy).\r\n\r\n    Status rules:\r\n      'healthy'   -- critical_services_healthy AND score >= 0.95\r\n      'degraded'  -- critical_services_healthy AND score < 0.95\r\n      'critical'  -- any high-criticality service is unhealthy\r\n      'not_ready' -- score < 0.70\r\n    \"\"\"\r\n    critical_ok = all(\r\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n        for s in services\r\n    )\r\n\r\n    if not critical_ok:\r\n        return \"critical\", critical_ok\r\n    if score >= 0.95:\r\n        return \"healthy\", critical_ok\r\n    if score >= 0.70:\r\n        return \"degraded\", critical_ok\r\n    return \"not_ready\", critical_ok\r\n\r\n\r\n# ── main ──────────────────────────────────────────────────────────────────────\r\n\r\ndef main():\r\n    manifest_path = \"/app/deployment_manifest.yaml\"\r\n    output_path   = \"/app/deployment_report.json\"\r\n\r\n    print(\"Loading deployment manifest ...\")\r\n    services = load_services(manifest_path)\r\n\r\n    print(\"Checking service health ...\")\r\n    statuses = {}\r\n    for svc in services:\r\n        result = check_health(svc)\r\n        statuses[svc[\"name\"]] = result\r\n        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\r\n\r\n    print(\"Computing startup order ...\")\r\n    startup_order = compute_startup_order(services)\r\n    print(f\"  {' -> '.join(startup_order)}\")\r\n\r\n    print(\"Computing readiness score ...\")\r\n    score = compute_readiness_score(services, statuses)\r\n    print(f\"  score = {score:.4f}\")\r\n\r\n    overall_status, critical_ok = determine_status(services, statuses, score)\r\n\r\n    report = {\r\n        \"deployment_name\":           \"production-stack\",\r\n        \"overall_status\":            overall_status,\r\n        \"readiness_score\":           score,\r\n        \"service_statuses\":          statuses,\r\n        \"startup_order\":             startup_order,\r\n        \"critical_services_healthy\": critical_ok,\r\n        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\r\n    }\r\n\r\n    with open(output_path, \"w\") as f:\r\n        json.dump(report, f, indent=2)\r\n\r\n    print(f\"\\nReport written to {output_path}\")\r\n    print(f\"Overall status : {overall_status}\")\r\n    print(f\"Readiness score: {score}\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    main()\r\n\u001b[?2004hroot@f07828e7747d:/app# "]
[15.477983, "i", "python3 validator.py\n"]
[15.478322, "o", "python3 validator.py\r\n\u001b[?2004l\r"]
[15.544009, "o", "Loading deployment manifest ...\r\n"]
[15.545252, "o", "Checking service health ...\r\n"]
[15.545921, "o", "  metrics-collector         unhealthy  (HTTP 0)\r\nComputing startup order ...\r\n  metrics-collector\r\nComputing readiness score ...\r\n  score = 0.0000\r\n"]
[15.547132, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : critical\r\nReadiness score: 0.0\r\n"]
[15.555806, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[18.784062, "i", "cp validator.py validator.py.backup\n"]
[18.784777, "o", "cp validator.py validator.py.backup\r\n\u001b[?2004l\r"]
[18.786054, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[19.96912, "i", "sed -i 's/return config\\[\"services\"\\]/return config[\"deployment\"][\"services\"]/' validator.py\n"]
[19.969382, "o", "sed -i 's/return config\\[\"services\"\\]/return config[\"deployment\"][\"services\"]/' validator.py\r\n\u001b[?2004l\r"]
[19.970529, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[20.987457, "i", "grep -A 5 'def load_services' validator.py\n"]
[20.987688, "o", "grep -A 5 'def load_services' validator.py\r\n\u001b[?2004l\r"]
[20.988332, "o", "def load_services(manifest_path: str) -> list:\r\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n    with open(manifest_path) as f:\r\n        config = yaml.safe_load(f)\r\n    # Returns the top-level 'services' list from the manifest.\r\n    return config[\"deployment\"][\"services\"]\r\n"]
[20.988947, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[22.01775, "i", "python3 validator.py\n"]
[22.018018, "o", "python3 validator.py\r\n\u001b[?2004l\r"]
[22.079363, "o", "Loading deployment manifest ...\r\n"]
[22.080586, "o", "Checking service health ...\r\n"]
[22.082582, "o", "  auth-service              healthy    (HTTP 200)\r\n"]
[22.083387, "o", "  api-gateway               unhealthy  (HTTP 200)\r\n"]
[22.084083, "o", "  cache-service             healthy    (HTTP 200)\r\n"]
[22.084818, "o", "  worker-service            unhealthy  (HTTP 503)\r\n"]
[22.085461, "o", "  notification-service      healthy    (HTTP 200)\r\nComputing startup order ...\r\n  notification-service -> worker-service -> api-gateway -> auth-service -> cache-service\r\n"]
[22.085487, "o", "Computing readiness score ...\r\n  score = 0.6000\r\n"]
[22.085657, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : critical\r\nReadiness score: 0.6\r\n"]
[22.094846, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[25.440564, "i", "cat /app/deployment_report.json\n"]
[25.44094, "o", "cat /app/deployment_report.json\r\n\u001b[?2004l\r"]
[25.44179, "o", "{\r\n  \"deployment_name\": \"production-stack\",\r\n  \"overall_status\": \"critical\",\r\n  \"readiness_score\": 0.6,\r\n  \"service_statuses\": {\r\n    \"auth-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"api-gateway\": {\r\n      \"status\": \"unhealthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"cache-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"medium\"\r\n    },\r\n    \"worker-service\": {\r\n      \"status\": \"unhealthy\",\r\n      \"http_status\": 503,\r\n      \"criticality\": \"low\"\r\n    },\r\n    \"notification-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"low\"\r\n    }\r\n  },\r\n  \"startup_order\": [\r\n    \"notification-service\",\r\n    \"worker-service\",\r\n    \"api-gateway\",\r\n    \"auth-service\",\r\n    \"cache-service\"\r\n  ],\r\n  \"critical_services_healthy\": false,\r\n  \"timestamp\": \"2026-02-27T20:04:33.453932+00:00\"\r\n}\u001b[?2004hroot@f07828e7747d:/app# "]
[26.815758, "i", "curl http://localhost:8082/health\n"]
[26.81619, "o", "curl http://localhost:8082/health\r\n\u001b[?2004l\r"]
[26.824749, "o", "{\"status\":\"healthy\",\"uptime_seconds\":3601}\r\n"]
[26.825244, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[28.209593, "i", "sed -i 's/status_ok = body.get(\"status\", \"ok\") in (\"ok\", \"up\")/status_ok = body.get(\"status\", \"ok\") in (\"ok\", \"up\", \"healthy\")/' validator.py\n"]
[28.209935, "o", "sed -i 's/status_ok = body.get(\"status\", \"ok\") in (\"ok\", \"up\")/status_ok = body.get(\"status\", \"ok\") in (\"ok\", \"up\", \"healthy\")/' validator.py\r\n\u001b[?2004l\r"]
[28.211355, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[29.34767, "i", "sed -i 's/weight_map = {\"high\": 1, \"medium\": 1, \"low\": 1}/weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}/' validator.py\n"]
[29.347969, "o", "sed -i 's/weight_map = {\"high\": 1, \"medium\": 1, \"low\": 1}/weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}/' validator.py\r\n\u001b[?2004l\r"]
[29.349661, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[30.661468, "i", "sed -i 's/graph\\[svc\\].append(dep)/graph[dep].append(svc)/' validator.py\n"]
[30.661813, "o", "sed -i 's/graph\\[svc\\].append(dep)/graph[dep].append(svc)/' validator.py\r\n\u001b[?2004l\r"]
[30.66301, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[31.736115, "i", "sed -i 's/for s in services:/for s in services:\\n        if s[\"criticality\"] != \"high\":\\n            continue/' validator.py\n"]
[31.73685, "o", "sed -i 's/for s in services:/for s in services:\\n        if s[\"criticality\"] != \"high\":\\n            continue/' validator.py\r\n\u001b[?2004l\r"]
[31.738295, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[32.784264, "i", "python3 validator.py\n"]
[32.784754, "o", "python3 validator.py\r\n\u001b[?2004l\r"]
[32.857077, "o", "Loading deployment manifest ...\r\n"]
[32.858321, "o", "Checking service health ...\r\n"]
[32.860834, "o", "  auth-service              healthy    (HTTP 200)\r\n"]
[32.861708, "o", "  api-gateway               healthy    (HTTP 200)\r\n"]
[32.862438, "o", "  cache-service             healthy    (HTTP 200)\r\n"]
[32.863082, "o", "  worker-service            unhealthy  (HTTP 503)\r\n"]
[32.863914, "o", "  notification-service      healthy    (HTTP 200)\r\nComputing startup order ...\r\n  notification-service\r\nComputing readiness score ...\r\n"]
[32.863989, "o", "  score = 0.9000\r\n"]
[32.864142, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : critical\r\nReadiness score: 0.9\r\n"]
[32.874209, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[35.909798, "i", "cat /app/deployment_report.json\n"]
[35.910062, "o", "cat /app/deployment_report.json\r\n"]
[35.910266, "o", "\u001b[?2004l\r"]
[35.911128, "o", "{\r\n  \"deployment_name\": \"production-stack\",\r\n  \"overall_status\": \"critical\",\r\n  \"readiness_score\": 0.9,\r\n  \"service_statuses\": {\r\n    \"auth-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"api-gateway\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"cache-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"medium\"\r\n    },\r\n    \"worker-service\": {\r\n      \"status\": \"unhealthy\",\r\n      \"http_status\": 503,\r\n      \"criticality\": \"low\"\r\n    },\r\n    \"notification-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"low\"\r\n    }\r\n  },\r\n  \"startup_order\": [\r\n    \"notification-service\"\r\n  ],\r\n  \"critical_services_healthy\": false,\r\n  \"timestamp\": \"2026-02-27T20:04:44.232819+00:00\"\r\n}"]
[35.911395, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[37.158809, "i", "grep -A 10 'def determine_status' validator.py\n"]
[37.159998, "o", "grep -A 10 'def determine_status' validator.py\r\n\u001b[?2004l\r"]
[37.161133, "o", "def determine_status(services: list, statuses: dict, score: float):\r\n    \"\"\"\r\n    Returns (overall_status, critical_services_healthy).\r\n\r\n    Status rules:\r\n      'healthy'   -- critical_services_healthy AND score >= 0.95\r\n      'degraded'  -- critical_services_healthy AND score < 0.95\r\n      'critical'  -- any high-criticality service is unhealthy\r\n      'not_ready' -- score < 0.70\r\n    \"\"\"\r\n    critical_ok = all(\r\n"]
[37.162015, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[38.188215, "i", "grep -A 20 'def determine_status' validator.py\n"]
[38.188426, "o", "grep -A 20 'def determine_status' validator.py\r\n\u001b[?2004l\r"]
[38.189354, "o", "def determine_status(services: list, statuses: dict, score: float):\r\n    \"\"\"\r\n    Returns (overall_status, critical_services_healthy).\r\n\r\n    Status rules:\r\n      'healthy'   -- critical_services_healthy AND score >= 0.95\r\n      'degraded'  -- critical_services_healthy AND score < 0.95\r\n      'critical'  -- any high-criticality service is unhealthy\r\n      'not_ready' -- score < 0.70\r\n    \"\"\"\r\n    critical_ok = all(\r\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n        for s in services\r\n    )\r\n\r\n    if not critical_ok:\r\n        return \"critical\", critical_ok\r\n    if score >= 0.95:\r\n        return \"healthy\", critical_ok\r\n    if score >= 0.70:\r\n        return \"degraded\", critical_ok\r\n"]
[38.189605, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[39.579348, "i", "sed -i '/critical_ok = all(/,/for s in services/{\ns/for s in services:/for s in services:\\n        if s[\"criticality\"] != \"high\":\\n            continue/\n}' validator.py\n"]
[39.579669, "o", "sed -i '/critical_ok = all(/,/for s in services/{\r\n\u001b[?2004l\r\u001b[?2004h> "]
[39.580363, "o", "s/for s in services:/for s in services:\\n        if s[\"criticality\"] != \"high\":\\n            continue/\r\n\u001b[?2004l\r\u001b[?2004h> }' validator.py\r\n\u001b[?2004l\r"]
[39.581102, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[40.624589, "i", "cp validator.py.backup temp.py\n"]
[40.624928, "o", "cp validator.py.backup temp.py\r\n\u001b[?2004l\r"]
[40.625885, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[52.574138, "i", "cat > validator_fix.py << 'EOF'\n#!/usr/bin/env python3\n\"\"\"\nDeployment Health Validator\n===========================\nReads deployment_manifest.yaml, probes each service's health endpoint,\ncomputes a weighted readiness score, determines a valid startup ordering,\nand writes a deployment readiness report to /app/deployment_report.json.\n\"\"\"\n\nimport json\nimport yaml\nimport requests\nfrom datetime import datetime, timezone\nfrom collections import deque\n\n\n# ┌─ 1. Load manifest ────────────────────────────────────────────────────────\n\ndef load_services(manifest_path: str) -> list:\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\n    with open(manifest_path) as f:\n        config = yaml.safe_load(f)\n    return config[\"deployment\"][\"services\"]\n\n\n# ┌─ 2. Health check ────────────────────────────────────────────────────\n\ndef check_health(service: dict) -> dict:\n    \"\"\"\n    Probe a single service and return its health record.\n\n    A service is healthy when:\n    - HTTP response status is 200, AND\n    - For JSON responses: the body's 'status' field is an accepted value.\n    - For non-JSON responses (e.g. plain text): HTTP 200 alone is sufficient.\n    \"\"\"\n    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\n    try:\n        resp = requests.get(url, timeout=5)\n        if resp.status_code != 200:\n            return {\n                \"status\": \"unhealthy\",\n                \"http_status\": resp.status_code,\n                \"criticality\": service[\"criticality\"],\n            }\n        # For JSON responses, also verify the status field in the body.\n        try:\n            body = resp.json()\n            status_ok = body.get(\"status\", \"ok\") in (\"ok\", \"up\", \"healthy\")\n        except ValueError:\n            status_ok = True  # Non-JSON body (e.g. \"pong\") — HTTP 200 is enough.\n        return {\n            \"status\": \"healthy\" if status_ok else \"unhealthy\",\n            \"http_status\": resp.status_code,\n            \"criticality\": service[\"criticality\"],\n        }\n    except requests.exceptions.RequestException:\n        return {\n            \"status\": \"unhealthy\",\n            \"http_status\": 0,\n            \"criticality\": service[\"criticality\"],\n        }\n\n\n# ┌─ 3. Startup ordering ────────────────────────────────────────\n\ndef compute_startup_order(services: list) -> list:\n    \"\"\"\n    Return a topologically sorted startup order using Kahn's algorithm.\n    Dependencies must start before the services that depend on them.\n    \"\"\"\n    names = [s[\"name\"] for s in services]\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\n\n    graph = {n: [] for n in names}\n    in_degree = {n: 0 for n in names}\n\n    # Build the graph: if A depends on B, then B must come before A\n    for svc_name, deps in deps_map.items():\n        for dep in deps:\n            graph[dep].append(svc_name)  # dep -> svc_name (dep must come before svc_name)\n            in_degree[svc_name] += 1\n\n    queue = deque(n for n in names if in_degree[n] == 0)\n    order = []\n    while queue:\n        node = queue.popleft()\n        order.append(node)\n        for neighbor in graph[node]:\n            in_degree[neighbor] -= 1\n            if in_degree[neighbor] == 0:\n                queue.append(neighbor)\n    return order\n\n\n# ┌─ 4. Readiness score ──────────────────────────────────────────\n\ndef compute_readiness_score(services: list, statuses: dict) -> float:\n    \"\"\"\n    Compute the weighted fraction of healthy services.\n    Criticality weights: high=3, medium=2, low=1.\n    \"\"\"\n    weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\n\n    total = sum(weight_map[s[\"criticality\"]] for s in services)\n    healthy = sum(\n        weight_map[s[\"criticality\"]]\n        for s in s"]
[52.574231, "i", "ervices\n        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\n    )\n    return round(healthy / total, 4) if total else 0.0\n\n\n# ┌─ 5. Overall status ──────────────────────────────────────────\n\ndef determine_status(services: list, statuses: dict, score: float):\n    \"\"\"\n    Returns (overall_status, critical_services_healthy).\n\n    Status rules:\n      'healthy'   -- critical_services_healthy AND score >= 0.95\n      'degraded'  -- critical_services_healthy AND score < 0.95\n      'critical'  -- any high-criticality service is unhealthy\n      'not_ready' -- score < 0.70\n    \"\"\"\n    critical_ok = all(\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\n        for s in services\n        if s[\"criticality\"] == \"high\"\n    )\n\n    if not critical_ok:\n        return \"critical\", critical_ok\n    if score >= 0.95:\n        return \"healthy\", critical_ok\n    if score >= 0.70:\n        return \"degraded\", critical_ok\n    return \"not_ready\", critical_ok\n\n\n# ┌─ main ─────────────────────────────────────────────────────────────\n\ndef main():\n    manifest_path = \"/app/deployment_manifest.yaml\"\n    output_path = \"/app/deployment_report.json\"\n\n    print(\"Loading deployment manifest ...\")\n    services = load_services(manifest_path)\n\n    print(\"Checking service health ...\")\n    statuses = {}\n    for svc in services:\n        result = check_health(svc)\n        statuses[svc[\"name\"]] = result\n        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\n\n    print(\"Computing startup order ...\")\n    startup_order = compute_startup_order(services)\n    print(f\"  {' -> '.join(startup_order)}\")\n\n    print(\"Computing readiness score ...\")\n    score = compute_readiness_score(services, statuses)\n    print(f\"  score = {score:.4f}\")\n\n    overall_status, critical_ok = determine_status(services, statuses, score)\n\n    report = {\n        \"deployment_name\": \"production-stack\",\n        \"overall_status\": overall_status,\n        \"readiness_score\": score,\n        \"service_statuses\": statuses,\n        \"startup_order\": startup_order,\n        \"critical_services_healthy\": critical_ok,\n        \"timestamp\": datetime.now(timezone.utc).isoformat(),\n    }\n\n    with open(output_path, \"w\") as f:\n        json.dump(report, f, indent=2)\n\n    print(f\"\\nReport written to {output_path}\")\n    print(f\"Overall status : {overall_status}\")\n    print(f\"Readiness score: {score}\")\n\n\nif __name__ == \"__main__\":\n    main()\nEOF\n"]
[52.574616, "o", "cat > validator_fix.py << 'EOF'"]
[52.575175, "o", "\r\n\u001b[?2004l\r\u001b[?2004h> #!/usr/bin/env python3\r\n\u001b[?2004l\r= \"he\u001b[?2004h> \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> Deployment Health Validator\r\n\u001b[?2004l\rhe\u001b[?2004h> ===========================\r\n\u001b[?2004l\r\u001b[?2004h> Reads deployment_manifest.yaml, probes each service's health endpoint,\r\n\u001b[?2004l\r\u001b[?2004h> computes a weighted readiness score, determines a valid startup ordering,\r\n\u001b[?2004l\relse 0.0\r\n\r\n\r\n# ┌─ 5. Overall status ────────────────────────────────────"]
[52.575312, "o", "\u001b[?2004h> "]
[52.575452, "o", "and writes a deployment readiness report to /app/deployment_report.json.\r\n\u001b[?2004l\rict, \u001b[?2004h> \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.575475, "o", "import json\r\n\u001b[?2004l\r\u001b[?2004h> import yaml\r\n"]
[52.575487, "o", "\u001b[?2004l\r"]
[52.575745, "o", "\u001b[?2004h> import requests\r\n\u001b[?2004l\r\u001b[?2004h> from datetime import datetime, timezone\r\n\u001b[?2004l\r\u001b[?2004h> from collections import deque\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.575964, "o", "# ┌─ 1. Load manifest ────────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[52.575988, "o", "\u001b[?2004h> "]
[52.576154, "o", "def load_services(manifest_path: str) -> list:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.576246, "o", "    \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n\u001b[?2004l\r"]
[52.576271, "o", "\u001b[?2004h> "]
[52.57639, "o", "    with open(manifest_path) as f:\r\n\u001b[?2004l\r=\u001b[?2004h> "]
[52.576454, "o", "        config = yaml.safe_load(f)\r\n\u001b[?2004l\ritical_\u001b[?2004h> "]
[52.576644, "o", "    return config[\"deployment\"][\"services\"]\r\n\u001b[?2004l\rl_ok\r\n \u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.576894, "o", "# ┌─ 2. Health check ────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.577057, "o", "def check_health(service: dict) -> dict:\r\n\u001b[?2004l\r─\u001b[?2004h> "]
[52.577163, "o", "    \"\"\"\r\n\u001b[?2004l\r��─"]
[52.577265, "o", "�\u001b[?2004h>     Probe a single service and return its health record.\r\n\u001b[?2004l\r���\u001b[?2004h> \r\n\u001b[?2004l\r�\u001b[?2004h> "]
[52.577333, "o", "    A service is healthy when:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.577353, "o", "    - HTTP response status is 200, AND\r\n\u001b[?2004l\r───\r\n\r\ndef m\u001b[?2004h> "]
[52.577536, "o", "    - For JSON responses: the body's 'status' field is an accepted value.\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.577762, "o", "    - For non-JSON responses (e.g. plain text): HTTP 200 alone is sufficient.\r\n\u001b[?2004l\r"]
[52.577797, "o", "\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r"]
[52.577813, "o", "\u001b[?2004h> "]
[52.577923, "o", "    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.578007, "o", "    try:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.578037, "o", "        resp = requests.get(url, timeout=5)\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.578044, "o", "> "]
[52.578202, "o", "        if resp.status_code != 200:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.578218, "o", "            return {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.578317, "o", "                \"status\": \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.578442, "o", "                \"http_status\": resp.status_code,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.578554, "o", "                \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.578593, "o", "            }\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.578715, "o", "        # For JSON responses, also verify the status field in the body.\r\n\u001b[?2004l\r\u001b[?2004h>         try:\r\n\u001b[?2004l\r\r\n\r\n"]
[52.578731, "o", "\u001b[?2004h> "]
[52.578815, "o", "            body = resp.json()\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.579032, "o", "            status_ok = body.get(\"status\", \"ok\") in (\"ok\", \"up\", \"healthy\")\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.579049, "o", "> "]
[52.57914, "o", "        except ValueError:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.579315, "o", "            status_ok = True  # Non-JSON body (e.g. \"pong\") — HTTP 200 is enough.\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.579331, "o", "        return {\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.579377, "o", "> "]
[52.579513, "o", "            \"status\": \"healthy\" if status_ok else \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.579613, "o", "            \"http_status\": resp.status_code,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.579774, "o", "            \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r \u001b[?2004h> "]
[52.579827, "o", "        }\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.579914, "o", ">     except requests.exceptions.RequestException:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.579978, "o", "        return {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.580059, "o", "            \"status\": \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.580198, "o", "            \"http_status\": 0,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.580251, "o", "            \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h>         }\r\n"]
[52.580325, "o", "\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.580603, "o", "# ┌─ 3. Startup ordering ────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.580739, "o", "def compute_startup_order(services: list) -> list:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r)\r\nEOF\r\n"]
[52.580794, "o", "\u001b[?2004h> "]
[52.580819, "o", "    Return a topologically sorted startup order using Kahn's algorithm.\r\n\u001b[?2004l\r"]
[52.580884, "o", "\u001b[?2004h> "]
[52.580938, "o", "    Dependencies must start before the services that depend on them.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.581011, "o", "    names = [s[\"name\"] for s in services]\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.581077, "o", "    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.581113, "o", "    graph = {n: [] for n in names}\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.581192, "o", "    in_degree = {n: 0 for n in names}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.581242, "o", "    # Build the graph: if A depends on B, then B must come before A\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.581298, "o", "    for svc_name, deps in deps_map.items():\r\n\u001b[?2004l\r\u001b[?2004h>         for dep in deps:\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.581358, "o", "> "]
[52.581415, "o", "            graph[dep].append(svc_name)  # dep -> svc_name (dep must come before svc_name)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.581476, "o", "            in_degree[svc_name] += 1\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.581515, "o", "    queue = deque(n for n in names if in_degree[n] == 0)\r\n\u001b[?2004l\r"]
[52.58169, "o", "\u001b[?2004h>     order = []\r\n\u001b[?2004l\r\u001b[?2004h>     while queue:\r\n\u001b[?2004l\r\u001b[?2004h>         node = queue.popleft()\r\n\u001b[?2004l\r\u001b[?2004h>         order.append(node)\r\n\u001b[?2004l\r"]
[52.581704, "o", "\u001b[?2004h>         for neighbor in graph[node]:\r\n\u001b[?2004l\r"]
[52.581747, "o", "\u001b[?2004h> "]
[52.58182, "o", "            in_degree[neighbor] -= 1\r\n\u001b[?2004l\r\u001b[?2004h>             if in_degree[neighbor] == 0:\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.581838, "o", "> "]
[52.581935, "o", "                queue.append(neighbor)\r\n\u001b[?2004l\r\u001b[?2004h>     return order\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[52.581979, "o", "> "]
[52.582123, "o", "# ┌─ 4. Readiness score ──────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.582179, "o", "def compute_readiness_score(services: list, statuses: dict) -> float:\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.582192, "o", "> "]
[52.582205, "o", "    \"\"\"\r\n"]
[52.582361, "o", "\u001b[?2004l\r\u001b[?2004h>     Compute the weighted fraction of healthy services.\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.582471, "o", "    Criticality weights: high=3, medium=2, low=1.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r"]
[52.582613, "o", "\u001b[?2004h>     weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.58264, "o", "    total = sum(weight_map[s[\"criticality\"]] for s in services)\r\n\u001b[?2004l\r\u001b[?2004h>     healthy = sum(\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.582702, "o", "        weight_map[s[\"criticality\"]]\r\n\u001b[?2004l\r\u001b[?2004h>         for s in services\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.582745, "o", "        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>     )\r\n\u001b[?2004l\r"]
[52.582787, "o", "\u001b[?2004h> "]
[52.582883, "o", "    return round(healthy / total, 4) if total else 0.0\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.582996, "o", "# ┌─ 5. Overall status ──────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.583059, "o", "def determine_status(services: list, statuses: dict, score: float):\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.583096, "o", "> "]
[52.583153, "o", "    Returns (overall_status, critical_services_healthy).\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     Status rules:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.583267, "o", "      'healthy'   -- critical_services_healthy AND score >= 0.95\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.583339, "o", "      'degraded'  -- critical_services_healthy AND score < 0.95\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.583356, "o", "> "]
[52.583451, "o", "      'critical'  -- any high-criticality service is unhealthy\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.583519, "o", "      'not_ready' -- score < 0.70\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.583674, "o", "    \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     critical_ok = all(\r\n\u001b[?2004l\r\u001b[?2004h>         statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>         for s in services\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.583706, "o", ">         if s[\"criticality\"] == \"high\"\r\n\u001b[?2004l\r\u001b[?2004h>     )\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.583744, "o", "    if not critical_ok:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.583788, "o", "        return \"critical\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.583857, "o", "    if score >= 0.95:\r\n\u001b[?2004l\r\u001b[?2004h>         return \"healthy\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.583918, "o", "    if score >= 0.70:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.584008, "o", "        return \"degraded\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     return \"not_ready\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.584189, "o", "# ┌─ main ─────────────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[52.584207, "o", "> "]
[52.584266, "o", "def main():\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.584343, "o", "    manifest_path = \"/app/deployment_manifest.yaml\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.584385, "o", "    output_path = \"/app/deployment_report.json\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[52.584437, "o", "\u001b[?2004h> "]
[52.584486, "o", "    print(\"Loading deployment manifest ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.584607, "o", "    services = load_services(manifest_path)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[52.584666, "o", "\u001b[?2004h>     print(\"Checking service health ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.584738, "o", "    statuses = {}\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.584753, "o", "    for svc in services:\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.584848, "o", ">         result = check_health(svc)\r\n\u001b[?2004l\r\u001b[?2004h>         statuses[svc[\"name\"]] = result\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.584946, "o", "        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585027, "o", "    print(\"Computing startup order ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585063, "o", "    startup_order = compute_startup_order(services)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585119, "o", "    print(f\"  {' -> '.join(startup_order)}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585162, "o", "    print(\"Computing readiness score ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585215, "o", "    score = compute_readiness_score(services, statuses)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585279, "o", "    print(f\"  score = {score:.4f}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585391, "o", "    overall_status, critical_ok = determine_status(services, statuses, score)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585435, "o", "    report = {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585471, "o", "        \"deployment_name\": \"production-stack\",\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585567, "o", "        \"overall_status\": overall_status,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585628, "o", "        \"readiness_score\": score,\r\n\u001b[?2004l\r\u001b[?2004h>         \"service_statuses\": statuses,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.585682, "o", "        \"startup_order\": startup_order,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.5857, "o", "        \"critical_services_healthy\": critical_ok,\r\n\u001b[?2004l\r\u001b[?2004h"]
[52.585777, "o", "> "]
[52.585849, "o", "        \"timestamp\": datetime.now(timezone.utc).isoformat(),\r\n\u001b[?2004l\r\u001b[?2004h>     }\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[52.585866, "o", ">     with open(output_path, \"w\") as f:\r\n\u001b[?2004l\r"]
[52.585928, "o", "\u001b[?2004h> "]
[52.585958, "o", "        json.dump(report, f, indent=2)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[52.586009, "o", "> "]
[52.586053, "o", "    print(f\"\\nReport written to {output_path}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.586151, "o", "    print(f\"Overall status : {overall_status}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.586208, "o", "    print(f\"Readiness score: {score}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.586257, "o", "\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[52.586345, "o", "\u001b[?2004h> if __name__ == \"__main__\":\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.586404, "o", "    main()\r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[52.587165, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[54.089683, "i", "mv validator_fix.py validator.py\n"]
[54.089875, "o", "mv validator_fix.py validator.py\r\n\u001b[?2004l\r"]
[54.090794, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[55.319712, "i", "python3 validator.py\n"]
[55.320109, "o", "python3 validator.py\r\n\u001b[?2004l\r"]
[55.383851, "o", "Loading deployment manifest ...\r\n"]
[55.385032, "o", "Checking service health ...\r\n"]
[55.386887, "o", "  auth-service              healthy    (HTTP 200)\r\n"]
[55.387712, "o", "  api-gateway               healthy    (HTTP 200)\r\n"]
[55.388405, "o", "  cache-service             healthy    (HTTP 200)\r\n"]
[55.389178, "o", "  worker-service            unhealthy  (HTTP 503)\r\n"]
[55.389852, "o", "  notification-service      healthy    (HTTP 200)\r\nComputing startup order ...\r\n  auth-service -> cache-service -> api-gateway -> worker-service -> notification-service\r\nComputing readiness score ...\r\n"]
[55.389926, "o", "  score = 0.9000\r\n"]
[55.390013, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : degraded\r\nReadiness score: 0.9\r\n"]
[55.398919, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[60.574257, "i", "cat /app/deployment_report.json\n"]
[60.574621, "o", "cat /app/deployment_report.json\r\n\u001b[?2004l\r"]
[60.575379, "o", "{\r\n  \"deployment_name\": \"production-stack\",\r\n  \"overall_status\": \"degraded\",\r\n  \"readiness_score\": 0.9,\r\n  \"service_statuses\": {\r\n    \"auth-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"api-gateway\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"cache-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"medium\"\r\n    },\r\n    \"worker-service\": {\r\n      \"status\": \"unhealthy\",\r\n      \"http_status\": 503,\r\n      \"criticality\": \"low\"\r\n    },\r\n    \"notification-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"low\"\r\n    }\r\n  },\r\n  \"startup_order\": [\r\n    \"auth-service\",\r\n    \"cache-service\",\r\n    \"api-gateway\",\r\n    \"worker-service\",\r\n    \"notification-service\"\r\n  ],\r\n  \"critical_services_healthy\": true,\r\n  \"timestamp\": \"2026-02-27T20:05:06.758746+00:00\"\r\n}"]
[60.575649, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[63.710715, "i", "echo 'Healthy services: auth-service(high=3), api-gateway(high=3), cache-service(medium=2)'\necho 'Total weights: 3+3+2+1+1 = 10'\necho 'Healthy weights: 3+3+2 = 8'\necho 'Score: 8/10 = 0.8'\necho 'But we got 0.9, let me check...'\n"]
[63.711321, "o", "echo 'Healthy services: auth-service(high=3), api-gateway(high=3), cache-service(medium=2)'\r\n\u001b[?2004l\rHealthy services: auth-service(high=3), api-gateway(high=3), cache-service(medium=2)\r\n\u001b[?2004hroot@f07828e7747d:/app# echo 'Total weights: 3+3+2+1+1 = 10'\r\n\u001b[?2004l\rTotal weights: 3+3+2+1+1 = 10\r\n\u001b[?2004hroot@f07828e7747d:/app# echo 'Healthy weights: 3+3+2 = 8'\r\n\u001b[?2004l\rHealthy weights: 3+3+2 = 8\r\n\u001b[?2004hroot@f07828e7747d:/app# echo 'Score: 8/10 = 0.8'\r\n\u001b[?2004l\rScore: 8/10 = 0.8\r\n\u001b[?2004hroot@f07828e7747d:/app# echo 'But we got 0.9, let me check...'\r\n\u001b[?2004l\rBut we got 0.9, let me check...\r\n\u001b[?2004hroot@f07828e7747d:/app# "]
[65.461441, "i", "curl -v http://localhost:8084/status\n"]
[65.461689, "o", "curl -v http://localhost:8084/status\r\n\u001b[?2004l\r"]
[65.469546, "o", "* Host localhost:8084 was resolved.\r\n* IPv6: ::1\r\n* IPv4: 127.0.0.1\r\n*   Trying [::1]:8084...\r\n"]
[65.469686, "o", "* connect to ::1 port 8084 from ::1 port 33176 failed: Connection refused\r\n*   Trying 127.0.0.1:8084...\r\n"]
[65.46977, "o", "* Connected to localhost (127.0.0.1) port 8084\r\n* using HTTP/1.x\r\n> GET /status HTTP/1.1\r\r\n> Host: localhost:8084\r\r\n> User-Agent: curl/8.14.1\r\r\n> Accept: */*\r\r\n> \r\r\n* Request completely sent off\r\n"]
[65.471215, "o", "< HTTP/1.1 503 SERVICE UNAVAILABLE\r\r\n< Server: Werkzeug/3.1.6 Python/3.12.12\r\r\n< Date: Fri, 27 Feb 2026 20:05:16 GMT\r\r\n< Content-Type: application/json\r\r\n< Content-Length: 41\r\r\n< Connection: close\r\r\n< \r\r\n{\"queue_depth\":1482,\"status\":\"degraded\"}\r\n* shutting down connection #0\r\n"]
[65.471804, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[68.592717, "i", "python3 -c \"\nservices = [\n    {'name': 'auth-service', 'criticality': 'high'},\n    {'name': 'api-gateway', 'criticality': 'high'},\n    {'name': 'cache-service', 'criticality': 'medium'},\n    {'name': 'worker-service', 'criticality': 'low'},\n    {'name': 'notification-service', 'criticality': 'low'}\n]\nstatuses = {\n    'auth-service': {'status': 'healthy'},\n    'api-gateway': {'status': 'healthy'},\n    'cache-service': {'status': 'healthy'},\n    'worker-service': {'status': 'unhealthy'},\n    'notification-service': {'status': 'healthy'}\n}\n\nweight_map = {'high': 3, 'medium': 2, 'low': 1}\ntotal = sum(weight_map[s['criticality']] for s in services)\nhealthy = sum(weight_map[s['criticality']] for s in services if statuses[s['name']]['status'] == 'healthy')\nprint(f'Total weights: {total}')\nprint(f'Healthy weights: {healthy}')\nprint(f'Score: {healthy/total}')\n\"\n"]
[68.592974, "o", "python3 -c \"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[68.593013, "o", "services = [\r\n\u001b[?2004l\r\u001b[?2004h> "]
[68.593194, "o", "    {'name': 'auth-service', 'criticality': 'high'},\r\n\u001b[?2004l\r\u001b[?2004h> "]
[68.593339, "o", "    {'name': 'api-gateway', 'criticality': 'high'},\r\n\u001b[?2004l\r\u001b[?2004h> "]
[68.593804, "o", "    {'name': 'cache-service', 'criticality': 'medium'},\r\n\u001b[?2004l\r\u001b[?2004h>     {'name': 'worker-service', 'criticality': 'low'},\r\n\u001b[?2004l\r\u001b[?2004h>     {'name': 'notification-service', 'criticality': 'low'}\r\n\u001b[?2004l\r\u001b[?2004h> ]\r\n\u001b[?2004l\r\u001b[?2004h> statuses = {\r\n\u001b[?2004l\r\u001b[?2004h"]
[68.593904, "o", "> "]
[68.594024, "o", "    'auth-service': {'status': 'healthy'},\r\n\u001b[?2004l\r\u001b[?2004h> "]
[68.594555, "o", "    'api-gateway': {'status': 'healthy'},\r\n\u001b[?2004l\r\u001b[?2004h>     'cache-service': {'status': 'healthy'},\r\n\u001b[?2004l\r\u001b[?2004h>     'worker-service': {'status': 'unhealthy'},\r\n\u001b[?2004l\r\u001b[?2004h>     'notification-service': {'status': 'healthy'}\r\n\u001b[?2004l\r\u001b[?2004h> }\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> weight_map = {'high': 3, 'medium': 2, 'low': 1}\r\n\u001b[?2004l\r\u001b[?2004h> total = sum(weight_map[s['criticality']] for s in services)\r\n\u001b[?2004l\r\u001b[?2004h> healthy = sum(weight_map[s['criticality']] for s in services if statuses[s['name']]['status'] == 'healthy')\r\n\u001b[?2004l\r\u001b[?2004h> print(f'Total weights: {total}')\r\n\u001b[?2004l\r\u001b[?2004h> "]
[68.594985, "o", "print(f'Healthy weights: {healthy}')\r\n\u001b[?2004l\r\u001b[?2004h> print(f'Score: {healthy/total}')\r\n\u001b[?2004l\r\u001b[?2004h> \"\r\n\u001b[?2004l\r"]
[68.601734, "o", "Total weights: 10\r\nHealthy weights: 9\r\nScore: 0.9\r\n"]
[68.603142, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[71.178239, "i", "echo 'The validator is working correctly!'\necho 'Final verification:'\necho '- All 5 services detected'\necho '- Correct health status for each service'\necho '- Correct startup order (topological sort)'\necho '- Correct readiness score (0.9)'\necho '- Correct overall_status (degraded)'\necho '- Correct critical_services_healthy (true)'\n"]
[71.178405, "o", "echo 'The validator is working correctly!'\r\n\u001b[?2004l\r"]
[71.178434, "o", "The validator is working correctly!\r\n\u001b[?2004hroot@f07828e7747d:/app# "]
[71.178769, "o", "echo 'Final verification:'\r\n\u001b[?2004l\rFinal verification:\r\n\u001b[?2004hroot@f07828e7747d:/app# echo '- All 5 services detected'\r\n\u001b[?2004l\r- All 5 services detected\r\n\u001b[?2004hroot@f07828e7747d:/app# "]
[71.178813, "o", "echo '- Correct health status for each service'\r\n\u001b[?2004l\r- Correct health status for each service\r\n"]
[71.178891, "o", "\u001b[?2004hroot@f07828e7747d:/app# "]
[71.179241, "o", "echo '- Correct startup order (topological sort)'\r\n\u001b[?2004l\r- Correct startup order (topological sort)\r\n\u001b[?2004hroot@f07828e7747d:/app# echo '- Correct readiness score (0.9)'\r\n\u001b[?2004l\r- Correct readiness score (0.9)\r\n\u001b[?2004hroot@f07828e7747d:/app# echo '- Correct overall_status (degraded)'\r\n"]
[71.179584, "o", "\u001b[?2004l\r- Correct overall_status (degraded)\r\n\u001b[?2004hroot@f07828e7747d:/app# echo '- Correct critical_services_healthy (true)'\r\n\u001b[?2004l\r- Correct critical_services_healthy (true)\r\n\u001b[?2004hroot@f07828e7747d:/app# "]
