{"version": 2, "width": 160, "height": 40, "timestamp": 1772224247, "env": {"SHELL": "/bin/bash", "TERM": "tmux-256color"}}
[0.002743, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[0.980947, "i", "clear\r"]
[0.981188, "o", "clear\r\n\u001b[?2004l\r"]
[0.981647, "o", "\u001b[H\u001b[J\u001b[3J"]
[0.982336, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[2.391537, "i", "ls -la\n"]
[2.39196, "o", "ls -la\r\n\u001b[?2004l\r"]
[2.392934, "o", "total 32\r\ndrwxr-xr-x 1 root root 4096 Feb 27 20:15 .\r\ndrwxr-xr-x 1 root root 4096 Feb 27 20:30 ..\r\n-rw-r--r-- 1 root root  698 Feb 27 19:10 Dockerfile\r\n-rw-r--r-- 1 root root 2068 Feb 27 19:22 deployment_manifest.yaml\r\n-rw-r--r-- 1 root root 3183 Feb 27 20:15 mock_services.py\r\n-rw-r--r-- 1 root root   44 Feb 27 18:53 requirements.txt\r\n-rw-r--r-- 1 root root 6119 Feb 27 20:15 validator.py\r\n"]
[2.393151, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[3.368458, "i", "cat deployment_manifest.yaml\n"]
[3.368872, "o", "cat deployment_manifest.yaml\r\n\u001b[?2004l\r"]
[3.369242, "o", "# ─────────────────────────────────────────────────────────────────────────────\r\n# deployment_manifest.yaml\r\n#\r\n# Deployment descriptor for the production stack.\r\n#\r\n# Schema notes:\r\n#   • The top-level 'services' block is a legacy v1 monitoring registry read\r\n#     by the external health-dashboard and alert-manager sidecar.  It is NOT\r\n#     the authoritative list for deployment ordering or health validation.\r\n#   • The authoritative service definitions live under 'deployment.services'.\r\n# ─────────────────────────────────────────────────────────────────────────────\r\n\r\n# Legacy monitoring-registry endpoint  (consumed by alert-manager, not by the validator)\r\nservices:\r\n  - name: \"metrics-collector\"\r\n    port: 9091\r\n    health_endpoint: \"/metrics\"\r\n    dependencies: []\r\n    criticality: \"low\"\r\n\r\n# ── Authoritative deployment configuration ────────────────────────────────────\r\ndeployment:\r\n  name: \"production-stack\"\r\n\r\n  services:\r\n    - name: \"auth-service\"\r\n      port: 8081\r\n      health_endpoint: \"/health\"\r\n      dependencies: []\r\n      criticality: \"high\"\r\n\r\n    - name: \"api-gateway\"\r\n      port: 8082\r\n      health_endpoint: \"/health\"\r\n      dependencies:\r\n        - \"auth-service\"\r\n        - \"cache-service\"\r\n      criticality: \"high\"\r\n\r\n    - name: \"cache-service\"\r\n      port: 8083\r\n      health_endpoint: \"/ping\"\r\n      dependencies: []\r\n      criticality: \"medium\"\r\n\r\n    - name: \"worker-service\"\r\n      port: 8084\r\n      health_endpoint: \"/status\"\r\n      dependencies:\r\n        - \"api-gateway\"\r\n        - \"cache-service\"\r\n      criticality: \"low\"\r\n\r\n    - name: \"notification-service\"\r\n      port: 8085\r\n      health_endpoint: \"/health\"\r\n      dependencies:\r\n        - \"worker-service\"\r\n      criticality: \"low\"\r\n"]
[3.369612, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[4.497083, "i", "cat validator.py\n"]
[4.497437, "o", "cat validator.py\r\n\u001b[?2004l\r"]
[4.498189, "o", "#!/usr/bin/env python3\r\n\"\"\"\r\nDeployment Health Validator\r\n===========================\r\nReads deployment_manifest.yaml, probes each service's health endpoint,\r\ncomputes a weighted readiness score, determines a valid startup ordering,\r\nand writes a deployment readiness report to /app/deployment_report.json.\r\n\"\"\"\r\n\r\nimport json\r\nimport yaml\r\nimport requests\r\nfrom datetime import datetime, timezone\r\nfrom collections import deque\r\n\r\n\r\n# ── 1. Load manifest ──────────────────────────────────────────────────────────\r\n\r\ndef load_services(manifest_path: str) -> list:\r\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n    with open(manifest_path) as f:\r\n        config = yaml.safe_load(f)\r\n    # Returns the top-level 'services' list from the manifest.\r\n    return config[\"services\"]\r\n\r\n\r\n# ── 2. Health check ───────────────────────────────────────────────────────────\r\n\r\ndef check_health(service: dict) -> dict:\r\n    \"\"\"Probe a single service and return its health record.\"\"\"\r\n    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\r\n    try:\r\n        resp = requests.get(url, timeout=5)\r\n        healthy = resp.status_code == 200\r\n        return {\r\n            \"status\": \"healthy\" if healthy else \"unhealthy\",\r\n            \"http_status\": resp.status_code,\r\n            \"criticality\": service[\"criticality\"],\r\n        }\r\n    except requests.exceptions.RequestException:\r\n        return {\r\n            \"status\": \"unhealthy\",\r\n            \"http_status\": 0,\r\n            \"criticality\": service[\"criticality\"],\r\n        }\r\n\r\n\r\n# ── 3. Startup ordering ───────────────────────────────────────────────────────\r\n\r\ndef compute_startup_order(services: list) -> list:\r\n    \"\"\"\r\n    Return a topologically sorted startup order using Kahn's algorithm.\r\n    Dependencies must start before the services that depend on them.\r\n    \"\"\"\r\n    names = [s[\"name\"] for s in services]\r\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\r\n    graph     = {n: [] for n in names}\r\n    in_degree = {n: 0 for n in names}\r\n\r\n    for svc, deps in deps_map.items():\r\n        for dep in deps:\r\n            graph[svc].append(dep)\r\n            in_degree[dep] += 1\r\n\r\n    queue = deque(n for n in names if in_degree[n] == 0)\r\n    order = []\r\n    while queue:\r\n        node = queue.popleft()\r\n        order.append(node)\r\n        for neighbor in graph[node]:\r\n            in_degree[neighbor] -= 1\r\n            if in_degree[neighbor] == 0:\r\n                queue.append(neighbor)\r\n    return order\r\n\r\n\r\n# ── 4. Readiness score ────────────────────────────────────────────────────────\r\n\r\ndef compute_readiness_score(services: list, statuses: dict) -> float:\r\n    \"\"\"\r\n    Compute the weighted fraction of healthy services.\r\n    Criticality weights: high=3, medium=2, low=1.\r\n    \"\"\"\r\n    weight_map = {\"high\": 1, \"medium\": 1, \"low\": 1}\r\n\r\n    total   = sum(weight_map[s[\"criticality\"]] for s in services)\r\n    healthy = sum(\r\n        weight_map[s[\"criticality\"]]\r\n        for s in services\r\n        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n    )\r\n    return round(healthy / total, 4) if total else 0.0\r\n\r\n\r\n# ── 5. Overall status ─────────────────────────────────────────────────────────\r\n\r\ndef determine_status(services: list, statuses: dict, score: float):\r\n    \"\"\"\r\n    Returns (overall_status, critical_services_healthy).\r\n\r\n    Status rules:\r\n      'healthy'   -- critical_services_healthy AND score >= 0.95\r\n      'degraded'  -- critical_services_healthy AND score < 0.9"]
[4.498227, "o", "5\r\n      'critical'  -- any high-criticality service is unhealthy\r\n      'not_ready' -- score < 0.70\r\n    \"\"\"\r\n    critical_ok = all(\r\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n        for s in services\r\n    )\r\n\r\n    if not critical_ok:\r\n        return \"critical\", critical_ok\r\n    if score >= 0.95:\r\n        return \"healthy\", critical_ok\r\n    if score >= 0.70:\r\n        return \"degraded\", critical_ok\r\n    return \"not_ready\", critical_ok\r\n\r\n\r\n# ── main ──────────────────────────────────────────────────────────────────────\r\n\r\ndef main():\r\n    manifest_path = \"/app/deployment_manifest.yaml\"\r\n    output_path   = \"/app/deployment_report.json\"\r\n\r\n    print(\"Loading deployment manifest ...\")\r\n    services = load_services(manifest_path)\r\n\r\n    print(\"Checking service health ...\")\r\n    statuses = {}\r\n    for svc in services:\r\n        result = check_health(svc)\r\n        statuses[svc[\"name\"]] = result\r\n        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\r\n\r\n    print(\"Computing startup order ...\")\r\n    startup_order = compute_startup_order(services)\r\n    print(f\"  {' -> '.join(startup_order)}\")\r\n\r\n    print(\"Computing readiness score ...\")\r\n    score = compute_readiness_score(services, statuses)\r\n    print(f\"  score = {score:.4f}\")\r\n\r\n    overall_status, critical_ok = determine_status(services, statuses, score)\r\n\r\n    report = {\r\n        \"deployment_name\":           \"production-stack\",\r\n        \"overall_status\":            overall_status,\r\n        \"readiness_score\":           score,\r\n        \"service_statuses\":          statuses,\r\n        \"startup_order\":             startup_order,\r\n        \"critical_services_healthy\": critical_ok,\r\n        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\r\n    }\r\n\r\n    with open(output_path, \"w\") as f:\r\n        json.dump(report, f, indent=2)\r\n\r\n    print(f\"\\nReport written to {output_path}\")\r\n    print(f\"Overall status : {overall_status}\")\r\n    print(f\"Readiness score: {score}\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    main()\r\n"]
[4.498263, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[5.991284, "i", "curl -s http://localhost:8081/health\n"]
[5.991482, "o", "curl -s http://localhost:8081/health\r\n\u001b[?2004l\r"]
[5.998828, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[8.054495, "i", "curl -s http://localhost:8081/health || echo \"Service 8081 not responding\"\n"]
[8.055487, "o", "curl -s http://localhost:8081/health || echo \"Service 8081 not responding\"\r\n\u001b[?2004l\r"]
[8.062563, "o", "Service 8081 not responding\r\n\u001b[?2004hroot@c08cc3f8e638:/app# "]
[11.170182, "i", "ps aux | grep mock\n"]
[11.170494, "o", "ps aux | grep mock"]
[11.170682, "o", "\r\n\u001b[?2004l\r"]
[11.171791, "o", "bash: ps: command not found\r\n"]
[11.172101, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[12.2106, "i", "python /app/validator.py\n"]
[12.210756, "o", "python /app/validator.py\r\n\u001b[?2004l\r"]
[12.278358, "o", "Loading deployment manifest ...\r\n"]
[12.279692, "o", "Checking service health ...\r\n"]
[12.280476, "o", "  metrics-collector         unhealthy  (HTTP 0)\r\nComputing startup order ...\r\n  metrics-collector\r\nComputing readiness score ...\r\n  score = 0.0000\r\n"]
[12.281277, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : critical\r\nReadiness score: 0.0\r\n"]
[12.290581, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[16.217509, "i", "cat /app/deployment_report.json\n"]
[16.217791, "o", "cat /app/deployment_report.json\r\n\u001b[?2004l\r"]
[16.218627, "o", "{\r\n  \"deployment_name\": \"production-stack\",\r\n  \"overall_status\": \"critical\",\r\n  \"readiness_score\": 0.0,\r\n  \"service_statuses\": {\r\n    \"metrics-collector\": {\r\n      \"status\": \"unhealthy\",\r\n      \"http_status\": 0,\r\n      \"criticality\": \"low\"\r\n    }\r\n  },\r\n  \"startup_order\": [\r\n    \"metrics-collector\"\r\n  ],\r\n  \"critical_services_healthy\": false,\r\n  \"timestamp\": \"2026-02-27T20:30:59.422881+00:00\"\r\n}"]
[16.218672, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[17.319659, "i", "cp /app/validator.py /app/validator.py.backup\n"]
[17.319928, "o", "cp /app/validator.py /app/validator.py.backup\r\n\u001b[?2004l\r"]
[17.321397, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[19.548616, "i", "cat > /app/validator.py << 'EOF'\n#!/usr/bin/env python3\n\"\"\"\nDeployment Health Validator\n===========================\nReads deployment_manifest.yaml, probes each service's health endpoint,\ncomputes a weighted readiness score, determines a valid startup ordering,\nand writes a deployment readiness report to /app/deployment_report.json.\n\"\"\"\n\nimport json\nimport yaml\nimport requests\nfrom datetime import datetime, timezone\nfrom collections import deque\n\n\n# ── 1. Load manifest ──────────────────────────────────────────────────────────\n\ndef load_services(manifest_path: str) -> list:\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\n    with open(manifest_path) as f:\n        config = yaml.safe_load(f)\n    # Returns the deployment services list from the manifest.\n    return config[\"deployment\"][\"services\"]\n\n\n# ── 2. Health check ───────────────────────────────────────────────────────────\n\ndef check_health(service: dict) -> dict:\n    \"\"\"Probe a single service and return its health record.\"\"\"\n    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\n    try:\n        resp = requests.get(url, timeout=5)\n        healthy = False\n        if resp.status_code == 200:\n            # Check if it's JSON and has status field\n            try:\n                json_data = resp.json()\n                # Check for accepted operational values\n                if 'status' in json_data and json_data['status'] in ['ok', 'up', 'healthy']:\n                    healthy = True\n            except ValueError:\n                # Not JSON, so just check HTTP status\n                healthy = True\n        return {\n            \"status\": \"healthy\" if healthy else \"unhealthy\",\n            \"http_status\": resp.status_code,\n            \"criticality\": service[\"criticality\"],\n        }\n    except requests.exceptions.RequestException:\n        return {\n            \"status\": \"unhealthy\",\n            \"http_status\": 0,\n            \"criticality\": service[\"criticality\"],\n        }\nEOF\n"]
[19.549014, "o", "cat > /app/validator.py << 'EOF'\r\n\u001b[?2004l\r"]
[19.549155, "o", "\u001b[?2004h> #!/usr/bin/env python3\r\n\u001b[?2004l\r\u001b[?2004h"]
[19.549168, "o", "> \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h"]
[19.549228, "o", "> Deployment Health Validator\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.549341, "o", "===========================\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.549409, "o", "Reads deployment_manifest.yaml, probes each service's health endpoint,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.549542, "o", "computes a weighted readiness score, determines a valid startup ordering,\r\n\u001b[?2004l\r\u001b[?2004h"]
[19.55099, "o", "> and writes a deployment readiness report to /app/deployment_report.json.\r\n\u001b[?2004l\r\u001b[?2004h> \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> import json\r\n\u001b[?2004l\r\u001b[?2004h> import yaml\r\n\u001b[?2004l\r\u001b[?2004h> import requests\r\n\u001b[?2004l\r\u001b[?2004h> from datetime import datetime, timezone\r\n\u001b[?2004l\r\u001b[?2004h> from collections import deque\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> # ── 1. Load manifest ──────────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def load_services(manifest_path: str) -> list:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     with open(manifest_path) as f:\r\n\u001b[?2004l\r\u001b[?2004h>         config = yaml.safe_load(f)\r\n\u001b[?2004l\r\u001b[?2004h>     # Returns the deployment services list from the manifest.\r\n\u001b[?2004l\r\u001b[?2004h>     return config[\"deployment\"][\"services\"]\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> # ── 2. Health check ───────────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def check_health(service: dict) -> dict:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"Probe a single service and return its health record.\"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\r\n\u001b[?2004l\r\u001b[?2004h>     try:\r\n\u001b[?2004l\r\u001b[?2004h>         resp = requests.get(url, timeout=5)\r\n\u001b[?2004l\r\u001b[?2004h>         healthy = False\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.551188, "o", "        if resp.status_code == 200:"]
[19.551214, "o", "\r\n\u001b[?2004l\r"]
[19.551463, "o", "\u001b[?2004h>             # Check if it's JSON and has status field\r\n\u001b[?2004l\r\u001b[?2004h>             try:\r\n\u001b[?2004l\r\u001b[?2004h>                 json_data = resp.json()\r\n\u001b[?2004l\r\u001b[?2004h>                 # Check for accepted operational values\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.551577, "o", "                if 'status' in json_data and json_data['status'] in ['ok', 'up', 'healthy']:\r\n\u001b[?2004l\r\u001b[?2004h>                     healthy = True\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.551715, "o", "            except ValueError:\r\n\u001b[?2004l\r\u001b[?2004h>                 # Not JSON, so just check HTTP status\r\n\u001b[?2004l\r\u001b[?2004h>                 healthy = True\r\n\u001b[?2004l\r\u001b[?2004h"]
[19.551795, "o", "> "]
[19.552012, "o", "        return {\r\n\u001b[?2004l\r\u001b[?2004h>             \"status\": \"healthy\" if healthy else \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h>             \"http_status\": resp.status_code,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.552037, "o", "            \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.552139, "o", "        }\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.552163, "o", "    except requests.exceptions.RequestException:\r\n\u001b[?2004l\r\u001b[?2004h>         return {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.552334, "o", "            \"status\": \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h>             \"http_status\": 0,\r\n\u001b[?2004l\r\u001b[?2004h>             \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h>         }\r\n\u001b[?2004l\r\u001b[?2004h> "]
[19.552437, "o", "EOF\r\n\u001b[?2004l\r"]
[19.553927, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[22.703229, "i", "cat >> /app/validator.py << 'EOF'\n\n\n# ── 3. Startup ordering ───────────────────────────────────────────────────────\n\ndef compute_startup_order(services: list) -> list:\n    \"\"\"\n    Return a topologically sorted startup order using Kahn's algorithm.\n    Dependencies must start before the services that depend on them.\n    \"\"\"\n    names = [s[\"name\"] for s in services]\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\n\n    graph     = {n: [] for n in names}\n    in_degree = {n: 0 for n in names}\n\n    for svc, deps in deps_map.items():\n        for dep in deps:\n            graph[svc].append(dep)\n            in_degree[dep] += 1\n\n    queue = deque(n for n in names if in_degree[n] == 0)\n    order = []\n    while queue:\n        node = queue.popleft()\n        order.append(node)\n        for neighbor in graph[node]:\n            in_degree[neighbor] -= 1\n            if in_degree[neighbor] == 0:\n                queue.append(neighbor)\n    return order\n\n\n# ── 4. Readiness score ────────────────────────────────────────────────────────\n\ndef compute_readiness_score(services: list, statuses: dict) -> float:\n    \"\"\"\n    Compute the weighted fraction of healthy services.\n    Criticality weights: high=3, medium=2, low=1.\n    \"\"\"\n    weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\n\n    total   = sum(weight_map[s[\"criticality\"]] for s in services)\n    healthy = sum(\n        weight_map[s[\"criticality\"]]\n        for s in services\n        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\n    )\n    return round(healthy / total, 4) if total else 0.0\n\n\n# ── 5. Overall status ─────────────────────────────────────────────────────────\n\ndef determine_status(services: list, statuses: dict, score: float):\n    \"\"\"\n    Returns (overall_status, critical_services_healthy).\n\n    Status rules:\n      'healthy'   -- critical_services_healthy AND score >= 0.95\n      'degraded'  -- critical_services_healthy AND score < 0.95\n      'critical'  -- any high-criticality service is unhealthy\n      'not_ready' -- score < 0.70\n    \"\"\"\n    critical_ok = all(\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\n        for s in services\n        if s[\"criticality\"] == \"high\"\n    )\n\n    if not critical_ok:\n        return \"critical\", critical_ok\n    if score >= 0.95:\n        return \"healthy\", critical_ok\n    if score >= 0.70:\n        return \"degraded\", critical_ok\n    return \"not_ready\", critical_ok\n\nEOF\n"]
[22.704086, "o", "cat >> /app/validator.py << 'EOF'\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> # ── 3. Startup ordering ───────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def compute_startup_order(services: list) -> list:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     Return a topologically sorted startup order using Kahn's algorithm.\r\n\u001b[?2004l\r\u001b[?2004h>     Dependencies must start before the services that depend on them.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h"]
[22.7049, "o", ">     names = [s[\"name\"] for s in services]\r\n\u001b[?2004l\r\u001b[?2004h>     deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     graph     = {n: [] for n in names}\r\n\u001b[?2004l\r\u001b[?2004h>     in_degree = {n: 0 for n in names}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[22.706852, "o", ">     for svc, deps in deps_map.items():\r\n\u001b[?2004l\r\u001b[?2004h> "]
[22.706872, "o", "        for dep in deps:\r\n\u001b[?2004l\r\u001b[?2004h>             graph[svc].append(dep)\r\n\u001b[?2004l\r\u001b[?2004h>             in_degree[dep] += 1\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     queue = deque(n for n in names if in_degree[n] == 0)\r\n\u001b[?2004l\r\u001b[?2004h>     order = []\r\n\u001b[?2004l\r\u001b[?2004h>     while queue:\r\n\u001b[?2004l\r\u001b[?2004h>         node = queue.popleft()\r\n\u001b[?2004l\r\u001b[?2004h>         order.append(node)\r\n\u001b[?2004l\r\u001b[?2004h>         for neighbor in graph[node]:\r\n\u001b[?2004l\r\u001b[?2004h>             in_degree[neighbor] -= 1\r\n\u001b[?2004l\r\u001b[?2004h>             if in_degree[neighbor] == 0:\r\n\u001b[?2004l\r\u001b[?2004h>                 queue.append(neighbor)\r\n\u001b[?2004l\r\u001b[?2004h>     return order\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> # ── 4. Readiness score ────────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def compute_readiness_score(services: list, statuses: dict) -> float:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     Compute the weighted fraction of healthy services.\r\n\u001b[?2004l\r\u001b[?2004h>     Criticality weights: high=3, medium=2, low=1.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     total   = sum(weight_map[s[\"criticality\"]] for s in services)\r\n\u001b[?2004l\r\u001b[?2004h>     healthy = sum(\r\n\u001b[?2004l\r\u001b[?2004h>         weight_map[s[\"criticality\"]]\r\n\u001b[?2004l\r\u001b[?2004h>         for s in services\r\n\u001b[?2004l\r\u001b[?2004h>         if statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>     )\r\n\u001b[?2004l\r\u001b[?2004h>     return round(healthy / total, 4) if total else 0.0\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[22.706983, "o", "# ── 5. Overall status ─────────────────────────────────────────────────────────"]
[22.707114, "o", "\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[22.707208, "o", "def determine_status(services: list, statuses: dict, score: float):\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h"]
[22.707321, "o", ">     Returns (overall_status, critical_services_healthy).\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[22.707343, "o", "\u001b[?2004h> "]
[22.707391, "o", "    Status rules:\r\n\u001b[?2004l\r"]
[22.707411, "o", "\u001b[?2004h> "]
[22.707586, "o", "      'healthy'   -- critical_services_healthy AND score >= 0.95\r\n\u001b[?2004l\r\u001b[?2004h> "]
[22.707707, "o", "      'degraded'  -- critical_services_healthy AND score < 0.95\r\n\u001b[?2004l\r\u001b[?2004h> "]
[22.707771, "o", "      'critical'  -- any high-criticality service is unhealthy\r\n\u001b[?2004l\r\u001b[?2004h> "]
[22.708437, "o", "      'not_ready' -- score < 0.70\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     critical_ok = all(\r\n\u001b[?2004l\r\u001b[?2004h>         statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>         for s in services\r\n\u001b[?2004l\r\u001b[?2004h>         if s[\"criticality\"] == \"high\"\r\n\u001b[?2004l\r\u001b[?2004h>     )\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     if not critical_ok:\r\n\u001b[?2004l\r\u001b[?2004h>         return \"critical\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     if score >= 0.95:\r\n\u001b[?2004l\r\u001b[?2004h>         return \"healthy\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     if score >= 0.70:\r\n\u001b[?2004l\r\u001b[?2004h>         return \"degraded\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     return \"not_ready\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[22.709973, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[25.175314, "i", "cat >> /app/validator.py << 'EOF'\n\n# ── main ──────────────────────────────────────────────────────────────────────\n\ndef main():\n    manifest_path = \"/app/deployment_manifest.yaml\"\n    output_path   = \"/app/deployment_report.json\"\n\n    print(\"Loading deployment manifest ...\")\n    services = load_services(manifest_path)\n\n    print(\"Checking service health ...\")\n    statuses = {}\n    for svc in services:\n        result = check_health(svc)\n        statuses[svc[\"name\"]] = result\n        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\n\n    print(\"Computing startup order ...\")\n    startup_order = compute_startup_order(services)\n    print(f\"  {' -> '.join(startup_order)}\")\n\n    print(\"Computing readiness score ...\")\n    score = compute_readiness_score(services, statuses)\n    print(f\"  score = {score:.4f}\")\n\n    overall_status, critical_ok = determine_status(services, statuses, score)\n\n    report = {\n        \"deployment_name\":           \"production-stack\",\n        \"overall_status\":            overall_status,\n        \"readiness_score\":           score,\n        \"service_statuses\":          statuses,\n        \"startup_order\":             startup_order,\n        \"critical_services_healthy\": critical_ok,\n        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\n    }\n\n    with open(output_path, \"w\") as f:\n        json.dump(report, f, indent=2)\n\n    print(f\"\\nReport written to {output_path}\")\n    print(f\"Overall status : {overall_status}\")\n    print(f\"Readiness score: {score}\")\n\n\nif __name__ == \"__main__\":\n    main()\nEOF\n"]
[25.176645, "o", "cat >> /app/validator.py << 'EOF'\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> # ── main ──────────────────────────────────────────────────────────────────────\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def main():\r\n\u001b[?2004l\r\u001b[?2004h>     manifest_path = \"/app/deployment_manifest.yaml\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[25.177929, "o", "    output_path   = \"/app/deployment_report.json\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     print(\"Loading deployment manifest ...\")\r\n\u001b[?2004l\r\u001b[?2004h>     services = load_services(manifest_path)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     print(\"Checking service health ...\")\r\n\u001b[?2004l\r\u001b[?2004h>     statuses = {}\r\n\u001b[?2004l\r\u001b[?2004h>     for svc in services:\r\n\u001b[?2004l\r\u001b[?2004h>         result = check_health(svc)\r\n\u001b[?2004l\r\u001b[?2004h>         statuses[svc[\"name\"]] = result\r\n\u001b[?2004l\r\u001b[?2004h>         print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     print(\"Computing startup order ...\")\r\n\u001b[?2004l\r\u001b[?2004h>     startup_order = compute_startup_order(services)\r\n\u001b[?2004l\r\u001b[?2004h>     print(f\"  {' -> '.join(startup_order)}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     print(\"Computing readiness score ...\")\r\n\u001b[?2004l\r\u001b[?2004h>     score = compute_readiness_score(services, statuses)\r\n\u001b[?2004l\r\u001b[?2004h>     print(f\"  score = {score:.4f}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     overall_status, critical_ok = determine_status(services, statuses, score)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     report = {\r\n\u001b[?2004l\r\u001b[?2004h>         \"deployment_name\":           \"production-stack\",\r\n\u001b[?2004l\r\u001b[?2004h>         \"overall_status\":            overall_status,\r\n\u001b[?2004l\r\u001b[?2004h>         \"readiness_score\":           score,\r\n\u001b[?2004l\r\u001b[?2004h>         \"service_statuses\":          statuses,\r\n\u001b[?2004l\r\u001b[?2004h>         \"startup_order\":             startup_order,\r\n\u001b[?2004l\r\u001b[?2004h>         \"critical_services_healthy\": critical_ok,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[25.177975, "o", "        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\r\n\u001b[?2004l\r\u001b[?2004h>     }"]
[25.178105, "o", "\r\n\u001b[?2004l\r\u001b[?2004h> "]
[25.17818, "o", "\r\n\u001b[?2004l\r\u001b[?2004h>     with open(output_path, \"w\") as f:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[25.178206, "o", "        json.dump(report, f, indent=2)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[25.178286, "o", "    print(f\"\\nReport written to {output_path}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[25.178325, "o", "    print(f\"Overall status : {overall_status}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[25.178433, "o", "    print(f\"Readiness score: {score}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[25.17857, "o", "if __name__ == \"__main__\":\r\n\u001b[?2004l\r\u001b[?2004h>     main()\r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[25.179363, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[26.384712, "i", "python /app/validator.py\n"]
[26.385031, "o", "python /app/validator.py\r\n\u001b[?2004l\r"]
[26.453793, "o", "Loading deployment manifest ...\r\n"]
[26.45501, "o", "Checking service health ...\r\n"]
[26.455686, "o", "  auth-service              unhealthy  (HTTP 0)\r\n"]
[26.45599, "o", "  api-gateway               unhealthy  (HTTP 0)\r\n"]
[26.456218, "o", "  cache-service             unhealthy  (HTTP 0)\r\n"]
[26.456525, "o", "  worker-service            unhealthy  (HTTP 0)\r\n"]
[26.456723, "o", "  notification-service      unhealthy  (HTTP 0)\r\nComputing startup order ...\r\n  notification-service -> worker-service -> api-gateway -> auth-service -> cache-service\r\nComputing readiness score ...\r\n"]
[26.456779, "o", "  score = 0.0000\r\n"]
[26.456961, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : critical\r\nReadiness score: 0.0\r\n"]
[26.466445, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[32.670884, "i", "python /app/mock_services.py &\n"]
[32.671389, "o", "python /app/mock_services.py &\r\n\u001b[?2004l\r"]
[32.671432, "o", "[1] 783\r\n"]
[32.671529, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[32.765109, "o", "  started  auth-service         /health  -> http://0.0.0.0:8081\r\n"]
[32.765254, "o", " * Serving Flask app 'auth-service'\r\n * Debug mode: off\r\n"]
[32.765443, "o", "  started  api-gateway          /health  -> http://0.0.0.0:8082\r\n"]
[32.765803, "o", " * Serving Flask app 'api-gateway'\r\n * Debug mode: off\r\n"]
[32.766195, "o", "  started  cache-service        /ping    -> http://0.0.0.0:8083\r\n"]
[32.7663, "o", " * Serving Flask app 'cache-service'\r\n * Debug mode: off\r\n"]
[32.767039, "o", "  started  worker-service       /status  -> http://0.0.0.0:8084\r\n"]
[32.767268, "o", " * Serving Flask app 'worker-service'\r\n * Debug mode: off\r\n"]
[32.767571, "o", " * Serving Flask app 'notification-service'\r\n * Debug mode: off\r\n"]
[32.767659, "o", "  started  notification-service /health  -> http://0.0.0.0:8085\r\nAll mock services running. Ctrl-C to stop.\r\n"]
[35.622714, "i", "python /app/validator.py\n"]
[35.623464, "o", "python /app/validator.py\r\n\u001b[?2004l\r"]
[35.687393, "o", "Loading deployment manifest ...\r\n"]
[35.688625, "o", "Checking service health ...\r\n"]
[35.69034, "o", "  auth-service              healthy    (HTTP 200)\r\n"]
[35.691335, "o", "  api-gateway               healthy    (HTTP 200)\r\n"]
[35.692143, "o", "  cache-service             healthy    (HTTP 200)\r\n"]
[35.692857, "o", "  worker-service            unhealthy  (HTTP 200)\r\n"]
[35.693524, "o", "  notification-service      healthy    (HTTP 200)\r\nComputing startup order ...\r\n  notification-service -> worker-service -> api-gateway -> auth-service -> cache-service\r\n"]
[35.693542, "o", "Computing readiness score ...\r\n"]
[35.693586, "o", "  score = 0.9000\r\n"]
[35.693731, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : degraded\r\nReadiness score: 0.9\r\n"]
[35.702693, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[41.949511, "i", "cat /app/deployment_report.json\n"]
[41.949944, "o", "cat /app/deployment_report.json\r\n\u001b[?2004l\r"]
[41.951208, "o", "{\r\n  \"deployment_name\": \"production-stack\",\r\n  \"overall_status\": \"degraded\",\r\n  \"readiness_score\": 0.9,\r\n  \"service_statuses\": {\r\n    \"auth-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"api-gateway\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"cache-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"medium\"\r\n    },\r\n    \"worker-service\": {\r\n      \"status\": \"unhealthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"low\"\r\n    },\r\n    \"notification-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"low\"\r\n    }\r\n  },\r\n  \"startup_order\": [\r\n    \"notification-service\",\r\n    \"worker-service\",\r\n    \"api-gateway\",\r\n    \"auth-service\",\r\n    \"cache-service\"\r\n  ],\r\n  \"critical_services_healthy\": true,\r\n  \"timestamp\": \"2026-02-27T20:31:22.838711+00:00\"\r\n}"]
[41.951358, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[43.183197, "i", "curl -s http://localhost:8084/status\n"]
[43.183515, "o", "curl -s http://localhost:8084/status\r\n\u001b[?2004l\r"]
[43.189944, "o", "{\"queue_depth\":1482,\"status\":\"degraded\"}\r\n"]
[43.190436, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[45.52916, "i", "echo \"Let's check the dependencies from the manifest:\"\n"]
[45.532235, "o", "echo \"Let's check the dependencies from the manifest:\"\r\n\u001b[?2004l\rLet's check the dependencies from the manifest:\r\n\u001b[?2004hroot@c08cc3f8e638:/app# "]
[47.752925, "i", "cat > /tmp/test_toposort.py << 'EOF'\n# Let's test the current logic\nservices = [\n    {\"name\": \"auth-service\", \"dependencies\": []},\n    {\"name\": \"api-gateway\", \"dependencies\": [\"auth-service\", \"cache-service\"]},\n    {\"name\": \"cache-service\", \"dependencies\": []},\n    {\"name\": \"worker-service\", \"dependencies\": [\"api-gateway\", \"cache-service\"]},\n    {\"name\": \"notification-service\", \"dependencies\": [\"worker-service\"]},\n]\n\nnames = [s[\"name\"] for s in services]\ndeps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\n\nprint(\"Dependencies:\")\nfor name, deps in deps_map.items():\n    print(f\"  {name} depends on: {deps}\")\nEOF\npython /tmp/test_toposort.py\n"]
[47.753928, "o", "cat > /tmp/test_toposort.py << 'EOF'\r\n\u001b[?2004l\r\u001b[?2004h> # Let's test the current logic\r\n\u001b[?2004l\r\u001b[?2004h> services = [\r\n\u001b[?2004l\r\u001b[?2004h>     {\"name\": \"auth-service\", \"dependencies\": []},\r\n\u001b[?2004l\r\u001b[?2004h>     {\"name\": \"api-gateway\", \"dependencies\": [\"auth-service\", \"cache-service\"]},\r\n\u001b[?2004l\r\u001b[?2004h>     {\"name\": \"cache-service\", \"dependencies\": []},\r\n\u001b[?2004l\r\u001b[?2004h>     {\"name\": \"worker-service\", \"dependencies\": [\"api-gateway\", \"cache-service\"]},\r\n\u001b[?2004l\r\u001b[?2004h>     {\"name\": \"notification-service\", \"dependencies\": [\"worker-service\"]},\r\n\u001b[?2004l\r\u001b[?2004h> ]\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[47.754034, "o", "names = [s[\"name\"] for s in services]\r\n\u001b[?2004l\r\u001b[?2004h> "]
[47.754153, "o", "deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[47.754198, "o", "print(\"Dependencies:\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[47.754285, "o", "for name, deps in deps_map.items():\r\n\u001b[?2004l\r\u001b[?2004h"]
[47.754365, "o", ">     print(f\"  {name} depends on: {deps}\")"]
[47.754509, "o", "\r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[47.755413, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[47.755556, "o", "python /tmp/test_toposort.py\r\n\u001b[?2004l\r"]
[47.762734, "o", "Dependencies:\r\n  auth-service depends on: []\r\n  api-gateway depends on: ['auth-service', 'cache-service']\r\n  cache-service depends on: []\r\n  worker-service depends on: ['api-gateway', 'cache-service']\r\n  notification-service depends on: ['worker-service']\r\n"]
[47.764347, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[52.264234, "i", "cat > /app/fix_toposort.py << 'EOF'\n#!/usr/bin/env python3\nfrom collections import deque\n\ndef compute_startup_order_fixed(services: list) -> list:\n    \"\"\"\n    Return a topologically sorted startup order using Kahn's algorithm.\n    Dependencies must start before the services that depend on them.\n    \"\"\"\n    names = [s[\"name\"] for s in services]\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\n\n    graph     = {n: [] for n in names}\n    in_degree = {n: 0 for n in names}\n\n    # If A depends on B, then B must come before A\n    # So we add edge B -> A and increment A's in-degree\n    for svc, deps in deps_map.items():\n        for dep in deps:\n            graph[dep].append(svc)  # Edge from dependency to service\n            in_degree[svc] += 1   # Service depends on something\n\n    queue = deque(n for n in names if in_degree[n] == 0)\n    order = []\n    while queue:\n        node = queue.popleft()\n        order.append(node)\n        for neighbor in graph[node]:\n            in_degree[neighbor] -= 1\n            if in_degree[neighbor] == 0:\n                queue.append(neighbor)\n    return order\n\n# Test with the same data\nservices = [\n    {\"name\": \"auth-service\", \"dependencies\": []},\n    {\"name\": \"api-gateway\", \"dependencies\": [\"auth-service\", \"cache-service\"]},\n    {\"name\": \"cache-service\", \"dependencies\": []},\n    {\"name\": \"worker-service\", \"dependencies\": [\"api-gateway\", \"cache-service\"]},\n    {\"name\": \"notification-service\", \"dependencies\": [\"worker-service\"]},\n]\n\nresult = compute_startup_order_fixed(services)\nprint(\"Correct startup order:\", \" -> \".join(result))\nEOF\npython /app/fix_toposort.py\n"]
[52.269307, "o", "cat > /app/fix_toposort.py << 'EOF'\r\n\u001b[?2004l\r\u001b[?2004h> #!/usr/bin/env python3\r\n\u001b[?2004l\r\u001b[?2004h> from collections import deque\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def compute_startup_order_fixed(services: list) -> list:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     Return a topologically sorted startup order using Kahn's algorithm.\r\n\u001b[?2004l\r\u001b[?2004h>     Dependencies must start before the services that depend on them.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     names = [s[\"name\"] for s in services]\r\n\u001b[?2004l\r\u001b[?2004h>     deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     graph     = {n: [] for n in names}\r\n\u001b[?2004l\r\u001b[?2004h>     in_degree = {n: 0 for n in names}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     # If A depends on B, then B must come before A\r\n\u001b[?2004l\r\u001b[?2004h>     # So we add edge B -> A and increment A's in-degree\r\n\u001b[?2004l\r\u001b[?2004h>     for svc, deps in deps_map.items():\r\n\u001b[?2004l\r\u001b[?2004h>         for dep in deps:\r\n\u001b[?2004l\r\u001b[?2004h>             graph[dep].append(svc)  # Edge from dependency to service\r\n\u001b[?2004l\r\u001b[?2004h>             in_degree[svc] += 1   # Service depends on something\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     queue = deque(n for n in names if in_degree[n] == 0)\r\n\u001b[?2004l\r\u001b[?2004h>     order = []\r\n\u001b[?2004l\r\u001b[?2004h>     while queue:\r\n\u001b[?2004l\r\u001b[?2004h>         node = queue.popleft()\r\n\u001b[?2004l\r\u001b[?2004h>         order.append(node)\r\n\u001b[?2004l\r\u001b[?2004h>         for neighbor in graph[node]:\r\n\u001b[?2004l\r\u001b[?2004h>             in_degree[neighbor] -= 1\r\n\u001b[?2004l\r\u001b[?2004h>             if in_degree[neighbor] == 0:\r\n\u001b[?2004l\r\u001b[?2004h>                 queue.append(neighbor)\r\n\u001b[?2004l\r\u001b[?2004h>     return order\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> # Test with the same data\r\n\u001b[?2004l\r\u001b[?2004h> services = [\r\n\u001b[?2004l\r\u001b[?2004h>     {\"name\": \"auth-service\", \"dependencies\": []},\r\n\u001b[?2004l\r\u001b[?2004h>     {\"name\": \"api-gateway\", \"dependencies\": [\"auth-service\", \"cache-service\"]},\r\n\u001b[?2004l\r\u001b[?2004h>     {\"name\": \"cache-service\", \"dependencies\": []},\r\n\u001b[?2004l\r\u001b[?2004h>     {\"name\": \"worker-service\", \"dependencies\": [\"api-gateway\", \"cache-service\"]},\r\n\u001b[?2004l\r\u001b[?2004h>     {\"name\": \"notification-service\", \"dependencies\": [\"worker-service\"]},\r\n\u001b[?2004l\r\u001b[?2004h> ]\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.269365, "o", "result = compute_startup_order_fixed(services)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[52.269816, "o", "print(\"Correct startup order:\", \" -> \".join(result))\r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[52.271245, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[52.27134, "o", "python /app/fix_toposort.py\r\n\u001b[?2004l\r"]
[52.287884, "o", "Correct startup order: auth-service -> cache-service -> api-gateway -> worker-service -> notification-service\r\n"]
[52.291586, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[54.732999, "i", "sed -i '/def compute_startup_order/,/^def /{/def compute_startup_order/,/^def /{s/.*/REPLACEME/;}}' /app/validator.py && sed -i '/REPLACEME/d' /app/validator.py\n"]
[54.733405, "o", "sed -i '/def compute_startup_order/,/^def /{/def compute_startup_order/,/^def /{s/.*/REPLACEME/;}}' /app/validator.py && sed -i '/REPLACEME/d' /app/validator.py\r\n\u001b[?2004l\r"]
[54.736451, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[55.985142, "i", "head -20 /app/validator.py\n"]
[55.985325, "o", "head -20 /app/validator.py\r\n\u001b[?2004l\r"]
[55.986213, "o", "#!/usr/bin/env python3\r\n\"\"\"\r\nDeployment Health Validator\r\n===========================\r\nReads deployment_manifest.yaml, probes each service's health endpoint,\r\ncomputes a weighted readiness score, determines a valid startup ordering,\r\nand writes a deployment readiness report to /app/deployment_report.json.\r\n\"\"\"\r\n\r\nimport json\r\nimport yaml\r\nimport requests\r\nfrom datetime import datetime, timezone\r\nfrom collections import deque\r\n\r\n\r\n# ── 1. Load manifest ──────────────────────────────────────────────────────────\r\n\r\ndef load_services(manifest_path: str) -> list:\r\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n"]
[55.986621, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[57.244303, "i", "grep -A 30 \"def compute_startup_order\" /app/validator.py\n"]
[57.244542, "o", "grep -A 30 \"def compute_startup_order\" /app/validator.py\r\n\u001b[?2004l\r"]
[57.24571, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[58.510576, "i", "cp /app/validator.py.backup /app/validator.py\n"]
[58.510799, "o", "cp /app/validator.py.backup /app/validator.py\r\n\u001b[?2004l\r"]
[58.511879, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[60.200998, "i", "sed -i 's/return config\\[\"services\"\\]/return config[\"deployment\"][\"services\"]/' /app/validator.py\n"]
[60.201319, "o", "sed -i 's/return config\\[\"services\"\\]/return config[\"deployment\"][\"services\"]/' /app/validator.py\r\n\u001b[?2004l\r"]
[60.202563, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[63.430351, "i", "cat > /tmp/new_check_health.py << 'EOF'\ndef check_health(service: dict) -> dict:\n    \"\"\"Probe a single service and return its health record.\"\"\"\n    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\n    try:\n        resp = requests.get(url, timeout=5)\n        healthy = False\n        if resp.status_code == 200:\n            # Check if it's JSON and has status field\n            try:\n                json_data = resp.json()\n                # Check for accepted operational values\n                if 'status' in json_data and json_data['status'] in ['ok', 'up', 'healthy']:\n                    healthy = True\n            except ValueError:\n                # Not JSON, so just check HTTP status\n                healthy = True\n        return {\n            \"status\": \"healthy\" if healthy else \"unhealthy\",\n            \"http_status\": resp.status_code,\n            \"criticality\": service[\"criticality\"],\n        }\n    except requests.exceptions.RequestException:\n        return {\n            \"status\": \"unhealthy\",\n            \"http_status\": 0,\n            \"criticality\": service[\"criticality\"],\n        }\nEOF\n"]
[63.430631, "o", "cat > /tmp/new_check_health.py << 'EOF'\r\n\u001b[?2004l\r\u001b[?2004h> def check_health(service: dict) -> dict:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[63.430805, "o", "    \"\"\"Probe a single service and return its health record.\"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\r\n\u001b[?2004l\r\u001b[?2004h>     try:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[63.43154, "o", "        resp = requests.get(url, timeout=5)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[63.432178, "o", "        healthy = False\r\n\u001b[?2004l\r\u001b[?2004h>         if resp.status_code == 200:\r\n\u001b[?2004l\r\u001b[?2004h>             # Check if it's JSON and has status field\r\n\u001b[?2004l\r\u001b[?2004h>             try:\r\n\u001b[?2004l\r\u001b[?2004h>                 json_data = resp.json()\r\n\u001b[?2004l\r\u001b[?2004h>                 # Check for accepted operational values\r\n\u001b[?2004l\r\u001b[?2004h>                 if 'status' in json_data and json_data['status'] in ['ok', 'up', 'healthy']:\r\n\u001b[?2004l\r\u001b[?2004h>                     healthy = True\r\n\u001b[?2004l\r\u001b[?2004h>             except ValueError:\r\n\u001b[?2004l\r\u001b[?2004h>                 # Not JSON, so just check HTTP status\r\n\u001b[?2004l\r\u001b[?2004h>                 healthy = True\r\n\u001b[?2004l\r\u001b[?2004h>         return {\r\n\u001b[?2004l\r\u001b[?2004h>             \"status\": \"healthy\" if healthy else \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h>             \"http_status\": resp.status_code,\r\n\u001b[?2004l\r\u001b[?2004h>             \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h>         }\r\n\u001b[?2004l\r\u001b[?2004h>     except requests.exceptions.RequestException:\r\n\u001b[?2004l\r\u001b[?2004h>         return {\r\n\u001b[?2004l\r\u001b[?2004h>             \"status\": \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h>             \"http_status\": 0,\r\n\u001b[?2004l\r\u001b[?2004h>             \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h>         }\r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[63.432783, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[64.952523, "i", "sed -i '/def check_health/,/^def /{/def check_health/{r /tmp/new_check_health.py\nd;};}' /app/validator.py\n"]
[64.952736, "o", "sed -i '/def check_health/,/^def /{/def check_health/{r /tmp/new_check_health.py"]
[64.952815, "o", "\r\n\u001b[?2004l\r"]
[64.952919, "o", "\u001b[?2004h"]
[64.953062, "o", "> d;};}' /app/validator.py"]
[64.953446, "o", "\r\n\u001b[?2004l\r"]
[64.954445, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[66.477257, "i", "grep -n \"healthy = resp.status_code == 200\" /app/validator.py\n"]
[66.477668, "o", "grep -n \"healthy = resp.status_code == 200\" /app/validator.py\r\n\u001b[?2004l\r"]
[66.47846, "o", "60:        healthy = resp.status_code == 200\r\n"]
[66.478612, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[68.748418, "i", "sed -i '60s/.*/        healthy = False\\n        if resp.status_code == 200:\\n            # Check if it\\'s JSON and has status field\\n            try:\\n                json_data = resp.json()\\n                # Check for accepted operational values\\n                if \\'status\\' in json_data and json_data[\\'status\\'] in [\\'ok\\', \\'up\\', \\'healthy\\']:\\n                    healthy = True\\n            except ValueError:\\n                # Not JSON, so just check HTTP status\\n                healthy = True/' /app/validator.py\n"]
[68.750009, "o", "sed -i '60s/.*/        healthy = False\\n        if resp.status_code == 200:\\n            # Check if it\\'s JSON and has status field\\n            try:\\n                json_data = resp.json()\\n                # Check for accepted operational values\\n                if \\'status\\' in json_data and json_data[\\'status\\'] in [\\'ok\\', \\'up\\', \\'healthy\\']:\\n                    healthy = True\\n            except ValueError:\\n                # Not JSON, so just check HTTP status\\n                healthy = True/' /app/validator.py\r\n\u001b[?2004l\rbash: syntax error near unexpected token `('\r\n\u001b[?2004hroot@c08cc3f8e638:/app# "]
[70.710513, "i", "sed -i 's/weight_map = {\"high\": 1, \"medium\": 1, \"low\": 1}/weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}/' /app/validator.py\n"]
[70.710794, "o", "sed -i 's/weight_map = {\"high\": 1, \"medium\": 1, \"low\": 1}/weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}/' /app/validator.py\r\n\u001b[?2004l\r"]
[70.713271, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[72.268678, "i", "sed -i '/critical_ok = all(/,/)/{/for s in services,/if s\\[\"criticality\"\\] == \"high\"/}' /app/validator.py\n"]
[72.269245, "o", "sed -i '/critical_ok = all(/,/)/{/for s in services,/if s\\[\"criticality\"\\] == \"high\"/}' /app/validator.py\r\n\u001b[?2004l\r"]
[72.269723, "o", "sed: -e expression #1, char 0: unmatched `{'\r\n\u001b[?2004hroot@c08cc3f8e638:/app# "]
[76.215623, "i", "cat > /app/validator_fixed.py << 'EOF'\n#!/usr/bin/env python3\n\"\"\"\nDeployment Health Validator\n===========================\nReads deployment_manifest.yaml, probes each service's health endpoint,\ncomputes a weighted readiness score, determines a valid startup ordering,\nand writes a deployment readiness report to /app/deployment_report.json.\n\"\"\"\n\nimport json\nimport yaml\nimport requests\nfrom datetime import datetime, timezone\nfrom collections import deque\n\n\ndef load_services(manifest_path: str) -> list:\n    \"\"\"Return the list of service definitions from the manifest.\"\"\"\n    with open(manifest_path) as f:\n        config = yaml.safe_load(f)\n    return config[\"deployment\"][\"services\"]\n\n\ndef check_health(service: dict) -> dict:\n    \"\"\"Probe a single service and return its health record.\"\"\"\n    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\n    try:\n        resp = requests.get(url, timeout=5)\n        healthy = False\n        if resp.status_code == 200:\n            # Check if it's JSON and has status field\n            try:\n                json_data = resp.json()\n                # Check for accepted operational values\n                if 'status' in json_data and json_data['status'] in ['ok', 'up', 'healthy']:\n                    healthy = True\n            except ValueError:\n                # Not JSON, so just check HTTP status\n                healthy = True\n        return {\n            \"status\": \"healthy\" if healthy else \"unhealthy\",\n            \"http_status\": resp.status_code,\n            \"criticality\": service[\"criticality\"],\n        }\n    except requests.exceptions.RequestException:\n        return {\n            \"status\": \"unhealthy\",\n            \"http_status\": 0,\n            \"criticality\": service[\"criticality\"],\n        }\n\nEOF\n"]
[76.215909, "o", "cat > /app/validator_fixed.py << 'EOF'\r\n\u001b[?2004l\r"]
[76.215952, "o", "\u001b[?2004h> #!/usr/bin/env python3\r\n\u001b[?2004l\r\u001b[?2004h> \"\"\"\r\n\u001b[?2004l\r"]
[76.215965, "o", "\u001b[?2004h> "]
[76.216095, "o", "Deployment Health Validator\r\n\u001b[?2004l\r\u001b[?2004h> ===========================\r\n\u001b[?2004l\r\u001b[?2004h> "]
[76.216304, "o", "Reads deployment_manifest.yaml, probes each service's health endpoint,\r\n\u001b[?2004l\r\u001b[?2004h> computes a weighted readiness score, determines a valid startup ordering,\r\n\u001b[?2004l\r\u001b[?2004h> and writes a deployment readiness report to /app/deployment_report.json.\r\n\u001b[?2004l\r\u001b[?2004h> "]
[76.216364, "o", "\"\"\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n"]
[76.216554, "o", "\u001b[?2004l\r\u001b[?2004h> import json\r\n\u001b[?2004l\r\u001b[?2004h> import yaml\r\n\u001b[?2004l\r\u001b[?2004h> import requests\r\n\u001b[?2004l\r\u001b[?2004h> from datetime import datetime, timezone\r\n\u001b[?2004l\r\u001b[?2004h> from collections import deque\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[76.216594, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r"]
[76.216669, "o", "\u001b[?2004h> "]
[76.21683, "o", "def load_services(manifest_path: str) -> list:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"Return the list of service definitions from the manifest.\"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     with open(manifest_path) as f:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[76.216985, "o", "        config = yaml.safe_load(f)\r\n\u001b[?2004l\r\u001b[?2004h>     return config[\"deployment\"][\"services\"]\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[76.217094, "o", "def check_health(service: dict) -> dict:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"Probe a single service and return its health record.\"\"\"\r\n\u001b[?2004l\r"]
[76.21713, "o", "\u001b[?2004h> "]
[76.217273, "o", "    url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"\r\n\u001b[?2004l\r\u001b[?2004h>     try:\r\n\u001b[?2004l\r\u001b[?2004h>         resp = requests.get(url, timeout=5)\r\n\u001b[?2004l\r\u001b[?2004h"]
[76.217381, "o", "> "]
[76.21746, "o", "        healthy = False\r\n\u001b[?2004l\r\u001b[?2004h>         if resp.status_code == 200:\r\n\u001b[?2004l\r\u001b[?2004h>             # Check if it's JSON and has status field\r\n\u001b[?2004l\r\u001b[?2004h>             try:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[76.217523, "o", "                json_data = resp.json()\r\n\u001b[?2004l\r\u001b[?2004h> "]
[76.217629, "o", "                # Check for accepted operational values\r\n\u001b[?2004l\r\u001b[?2004h> "]
[76.217739, "o", "                if 'status' in json_data and json_data['status'] in ['ok', 'up', 'healthy']:\r\n\u001b[?2004l\r"]
[76.217762, "o", "\u001b[?2004h> "]
[76.218072, "o", "                    healthy = True"]
[76.218093, "o", "\r\n\u001b[?2004l\r\u001b[?2004h>             except ValueError:\r\n\u001b[?2004l\r\u001b[?2004h>                 # Not JSON, so just check HTTP status\r\n\u001b[?2004l\r\u001b[?2004h>                 healthy = True\r\n\u001b[?2004l\r\u001b[?2004h>         return {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[76.218231, "o", "            \"status\": \"healthy\" if healthy else \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h>             \"http_status\": resp.status_code,\r\n\u001b[?2004l\r\u001b[?2004h>             \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h>         }\r\n\u001b[?2004l\r\u001b[?2004h"]
[76.21825, "o", "> "]
[76.218344, "o", "    except requests.exceptions.RequestException:\r\n\u001b[?2004l\r\u001b[?2004h>         return {\r\n\u001b[?2004l\r\u001b[?2004h> "]
[76.218431, "o", "            \"status\": \"unhealthy\",\r\n\u001b[?2004l\r\u001b[?2004h> "]
[76.218726, "o", "            \"http_status\": 0,\r\n\u001b[?2004l\r\u001b[?2004h>             \"criticality\": service[\"criticality\"],\r\n\u001b[?2004l\r\u001b[?2004h>         }\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[76.219503, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[79.597262, "i", "cat >> /app/validator_fixed.py << 'EOF'\n\ndef compute_startup_order(services: list) -> list:\n    \"\"\"\n    Return a topologically sorted startup order using Kahn's algorithm.\n    Dependencies must start before the services that depend on them.\n    \"\"\"\n    names = [s[\"name\"] for s in services]\n    deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\n\n    graph     = {n: [] for n in names}\n    in_degree = {n: 0 for n in names}\n\n    # If A depends on B, then B must come before A\n    # So we add edge B -> A and increment A's in-degree\n    for svc, deps in deps_map.items():\n        for dep in deps:\n            graph[dep].append(svc)  # Edge from dependency to service\n            in_degree[svc] += 1   # Service depends on something\n\n    queue = deque(n for n in names if in_degree[n] == 0)\n    order = []\n    while queue:\n        node = queue.popleft()\n        order.append(node)\n        for neighbor in graph[node]:\n            in_degree[neighbor] -= 1\n            if in_degree[neighbor] == 0:\n                queue.append(neighbor)\n    return order\n\nEOF\n"]
[79.597438, "o", "cat >> /app/validator_fixed.py << 'EOF'\r\n\u001b[?2004l\r"]
[79.597462, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[79.597771, "o", "def compute_startup_order(services: list) -> list:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     Return a topologically sorted startup order using Kahn's algorithm.\r\n\u001b[?2004l\r"]
[79.597874, "o", "\u001b[?2004h>     Dependencies must start before the services that depend on them.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     names = [s[\"name\"] for s in services]\r\n\u001b[?2004l\r\u001b[?2004h>     deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[79.597898, "o", ">     graph     = {n: [] for n in names}\r\n\u001b[?2004l\r\u001b[?2004h> "]
[79.598173, "o", "    in_degree = {n: 0 for n in names}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     # If A depends on B, then B must come before A\r\n\u001b[?2004l\r\u001b[?2004h>     # So we add edge B -> A and increment A's in-degree\r\n\u001b[?2004l\r\u001b[?2004h>     for svc, deps in deps_map.items():\r\n\u001b[?2004l\r\u001b[?2004h>         for dep in deps:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[79.598294, "o", "            graph[dep].append(svc)  # Edge from dependency to service\r\n\u001b[?2004l\r\u001b[?2004h>             in_degree[svc] += 1   # Service depends on something\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[79.598351, "o", "    queue = deque(n for n in names if in_degree[n] == 0)\r\n\u001b[?2004l\r\u001b[?2004h>     order = []\r\n\u001b[?2004l\r\u001b[?2004h"]
[79.598379, "o", ">     while queue:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[79.59842, "o", "        node = queue.popleft()\r\n\u001b[?2004l\r\u001b[?2004h> "]
[79.598519, "o", "        order.append(node)\r\n\u001b[?2004l\r"]
[79.59854, "o", "\u001b[?2004h>         for neighbor in graph[node]:\r\n\u001b[?2004l\r\u001b[?2004h>             in_degree[neighbor] -= 1\r\n\u001b[?2004l\r\u001b[?2004h> "]
[79.598601, "o", "            if in_degree[neighbor] == 0:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[79.598669, "o", "                queue.append(neighbor)\r\n\u001b[?2004l\r\u001b[?2004h>     return order\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r"]
[79.598715, "o", "\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[79.599496, "o", "\u001b[?2004h"]
[79.599524, "o", "root@c08cc3f8e638:/app# "]
[83.638794, "i", "cat >> /app/validator_fixed.py << 'EOF'\n\ndef compute_readiness_score(services: list, statuses: dict) -> float:\n    \"\"\"\n    Compute the weighted fraction of healthy services.\n    Criticality weights: high=3, medium=2, low=1.\n    \"\"\"\n    weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\n\n    total   = sum(weight_map[s[\"criticality\"]] for s in services)\n    healthy = sum(\n        weight_map[s[\"criticality\"]]\n        for s in services\n        if statuses[s[\"name\"]][\"status\"] == \"healthy\"\n    )\n    return round(healthy / total, 4) if total else 0.0\n\n\ndef determine_status(services: list, statuses: dict, score: float):\n    \"\"\"\n    Returns (overall_status, critical_services_healthy).\n\n    Status rules:\n      'healthy'   -- critical_services_healthy AND score >= 0.95\n      'degraded'  -- critical_services_healthy AND score < 0.95\n      'critical'  -- any high-criticality service is unhealthy\n      'not_ready' -- score < 0.70\n    \"\"\"\n    critical_ok = all(\n        statuses[s[\"name\"]][\"status\"] == \"healthy\"\n        for s in services\n        if s[\"criticality\"] == \"high\"\n    )\n\n    if not critical_ok:\n        return \"critical\", critical_ok\n    if score >= 0.95:\n        return \"healthy\", critical_ok\n    if score >= 0.70:\n        return \"degraded\", critical_ok\n    return \"not_ready\", critical_ok\n\nEOF\n"]
[83.640136, "o", "cat >> /app/validator_fixed.py << 'EOF'\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def compute_readiness_score(services: list, statuses: dict) -> float:\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     Compute the weighted fraction of healthy services.\r\n\u001b[?2004l\r\u001b[?2004h>     Criticality weights: high=3, medium=2, low=1.\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     total   = sum(weight_map[s[\"criticality\"]] for s in services)\r\n\u001b[?2004l\r\u001b[?2004h>     healthy = sum(\r\n\u001b[?2004l\r\u001b[?2004h>         weight_map[s[\"criticality\"]]\r\n\u001b[?2004l\r\u001b[?2004h>         for s in services\r\n\u001b[?2004l\r\u001b[?2004h>         if statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>     )\r\n\u001b[?2004l\r\u001b[?2004h>     return round(healthy / total, 4) if total else 0.0\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> def determine_status(services: list, statuses: dict, score: float):\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     Returns (overall_status, critical_services_healthy).\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     Status rules:\r\n\u001b[?2004l\r\u001b[?2004h>       'healthy'   -- critical_services_healthy AND score >= 0.95\r\n\u001b[?2004l\r\u001b[?2004h>       'degraded'  -- critical_services_healthy AND score < 0.95\r\n\u001b[?2004l\r\u001b[?2004h>       'critical'  -- any high-criticality service is unhealthy\r\n\u001b[?2004l\r\u001b[?2004h>       'not_ready' -- score < 0.70\r\n\u001b[?2004l\r\u001b[?2004h>     \"\"\"\r\n\u001b[?2004l\r\u001b[?2004h>     critical_ok = all(\r\n\u001b[?2004l\r\u001b[?2004h>         statuses[s[\"name\"]][\"status\"] == \"healthy\"\r\n\u001b[?2004l\r\u001b[?2004h>         for s in services\r\n\u001b[?2004l\r\u001b[?2004h>         if s[\"criticality\"] == \"high\"\r\n\u001b[?2004l\r\u001b[?2004h>     )\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     if not critical_ok:\r\n\u001b[?2004l\r\u001b[?2004h>         return \"critical\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> "]
[83.640225, "o", "    if score >= 0.95:\r\n\u001b[?2004l\r\u001b[?2004h> "]
[83.64031, "o", "        return \"healthy\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h>     if score >= 0.70:\r\n\u001b[?2004l\r"]
[83.640342, "o", "\u001b[?2004h>         return \"degraded\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> "]
[83.640419, "o", "    return \"not_ready\", critical_ok\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[83.641196, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[87.56631, "i", "cat >> /app/validator_fixed.py << 'EOF'\n\ndef main():\n    manifest_path = \"/app/deployment_manifest.yaml\"\n    output_path   = \"/app/deployment_report.json\"\n\n    print(\"Loading deployment manifest ...\")\n    services = load_services(manifest_path)\n\n    print(\"Checking service health ...\")\n    statuses = {}\n    for svc in services:\n        result = check_health(svc)\n        statuses[svc[\"name\"]] = result\n        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\n\n    print(\"Computing startup order ...\")\n    startup_order = compute_startup_order(services)\n    print(f\"  {' -> '.join(startup_order)}\")\n\n    print(\"Computing readiness score ...\")\n    score = compute_readiness_score(services, statuses)\n    print(f\"  score = {score:.4f}\")\n\n    overall_status, critical_ok = determine_status(services, statuses, score)\n\n    report = {\n        \"deployment_name\":           \"production-stack\",\n        \"overall_status\":            overall_status,\n        \"readiness_score\":           score,\n        \"service_statuses\":          statuses,\n        \"startup_order\":             startup_order,\n        \"critical_services_healthy\": critical_ok,\n        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\n    }\n\n    with open(output_path, \"w\") as f:\n        json.dump(report, f, indent=2)\n\n    print(f\"\\nReport written to {output_path}\")\n    print(f\"Overall status : {overall_status}\")\n    print(f\"Readiness score: {score}\")\n\n\nif __name__ == \"__main__\":\n    main()\nEOF\n"]
[87.56647, "o", "cat >> /app/validator_fixed.py << 'EOF'\r\n\u001b[?2004l\r"]
[87.566498, "o", "\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.566544, "o", "def main():\r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.566624, "o", "    manifest_path = \"/app/deployment_manifest.yaml\"\r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.566676, "o", "    output_path   = \"/app/deployment_report.json\"\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.566734, "o", "    print(\"Loading deployment manifest ...\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.566828, "o", "    services = load_services(manifest_path)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.566876, "o", "    print(\"Checking service health ...\")\r\n\u001b[?2004l\r"]
[87.566933, "o", "\u001b[?2004h> "]
[87.566969, "o", "    statuses = {}\r\n\u001b[?2004l\r\u001b[?2004h"]
[87.566999, "o", "> "]
[87.567103, "o", "    for svc in services:\r\n\u001b[?2004l\r\u001b[?2004h>         result = check_health(svc)\r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.567246, "o", "        statuses[svc[\"name\"]] = result\r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.567267, "o", "        print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.567671, "o", "    print(\"Computing startup order ...\")\r\n\u001b[?2004l\r\u001b[?2004h>     startup_order = compute_startup_order(services)\r\n\u001b[?2004l\r\u001b[?2004h>     print(f\"  {' -> '.join(startup_order)}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     print(\"Computing readiness score ...\")\r\n\u001b[?2004l\r\u001b[?2004h>     score = compute_readiness_score(services, statuses)\r\n\u001b[?2004l\r\u001b[?2004h>     print(f\"  score = {score:.4f}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     overall_status, critical_ok = determine_status(services, statuses, score)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.568012, "o", "    report = {\r\n\u001b[?2004l\r\u001b[?2004h>         \"deployment_name\":           \"production-stack\",\r\n\u001b[?2004l\r\u001b[?2004h"]
[87.568147, "o", ">         \"overall_status\":            overall_status,\r\n\u001b[?2004l\r\u001b[?2004h>         \"readiness_score\":           score,\r\n\u001b[?2004l\r\u001b[?2004h>         \"service_statuses\":          statuses,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.568282, "o", "        \"startup_order\":             startup_order,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.568387, "o", "        \"critical_services_healthy\": critical_ok,\r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.568546, "o", "        \"timestamp\":                 datetime.now(timezone.utc).isoformat(),\r\n\u001b[?2004l\r\u001b[?2004h>     }\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h>     with open(output_path, \"w\") as f:\r\n\u001b[?2004l\r\u001b[?2004h>         json.dump(report, f, indent=2)\r\n\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.56862, "o", "    print(f\"\\nReport written to {output_path}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.568662, "o", "    print(f\"Overall status : {overall_status}\")\r\n\u001b[?2004l\r\u001b[?2004h> "]
[87.568763, "o", "    print(f\"Readiness score: {score}\")\r\n\u001b[?2004l\r\u001b[?2004h> \r\n"]
[87.568824, "o", "\u001b[?2004l\r\u001b[?2004h> \r\n\u001b[?2004l\r\u001b[?2004h"]
[87.56891, "o", "> "]
[87.568937, "o", "if __name__ == \"__main__\":\r\n\u001b[?2004l\r\u001b[?2004h>     main()\r\n\u001b[?2004l\r\u001b[?2004h> EOF\r\n\u001b[?2004l\r"]
[87.569561, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[88.92047, "i", "mv /app/validator_fixed.py /app/validator.py\n"]
[88.920951, "o", "mv /app/validator_fixed.py /app/validator.py\r\n\u001b[?2004l\r"]
[88.922293, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[90.338208, "i", "python /app/validator.py\n"]
[90.338508, "o", "python /app/validator.py\r\n\u001b[?2004l\r"]
[90.40751, "o", "Loading deployment manifest ...\r\n"]
[90.408684, "o", "Checking service health ...\r\n"]
[90.412606, "o", "  auth-service              healthy    (HTTP 200)\r\n"]
[90.413442, "o", "  api-gateway               healthy    (HTTP 200)\r\n"]
[90.414161, "o", "  cache-service             healthy    (HTTP 200)\r\n"]
[90.414795, "o", "  worker-service            unhealthy  (HTTP 200)\r\n"]
[90.415399, "o", "  notification-service      healthy    (HTTP 200)\r\nComputing startup order ...\r\n  auth-service -> cache-service -> api-gateway -> worker-service -> notification-service\r\nComputing readiness score ...\r\n  score = 0.9000\r\n"]
[90.415588, "o", "\r\nReport written to /app/deployment_report.json\r\nOverall status : degraded\r\nReadiness score: 0.9\r\n"]
[90.424238, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
[96.973597, "i", "cat /app/deployment_report.json\n"]
[96.97404, "o", "cat /app/deployment_report.json\r\n\u001b[?2004l\r"]
[96.974794, "o", "{\r\n  \"deployment_name\": \"production-stack\",\r\n  \"overall_status\": \"degraded\",\r\n  \"readiness_score\": 0.9,\r\n  \"service_statuses\": {\r\n    \"auth-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"api-gateway\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"high\"\r\n    },\r\n    \"cache-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"medium\"\r\n    },\r\n    \"worker-service\": {\r\n      \"status\": \"unhealthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"low\"\r\n    },\r\n    \"notification-service\": {\r\n      \"status\": \"healthy\",\r\n      \"http_status\": 200,\r\n      \"criticality\": \"low\"\r\n    }\r\n  },\r\n  \"startup_order\": [\r\n    \"auth-service\",\r\n    \"cache-service\",\r\n    \"api-gateway\",\r\n    \"worker-service\",\r\n    \"notification-service\"\r\n  ],\r\n  \"critical_services_healthy\": true,\r\n  \"timestamp\": \"2026-02-27T20:32:17.560493+00:00\"\r\n}"]
[96.975004, "o", "\u001b[?2004hroot@c08cc3f8e638:/app# "]
