[?2004hroot@b64f4c940325:/app# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@b64f4c940325:/app# clear
[?2004l[H[J[3J[?2004hroot@b64f4c940325:/app# ls -la /app
[?2004ltotal 32
drwxr-xr-x 1 root root 4096 Feb 27 20:15 .
drwxr-xr-x 1 root root 4096 Feb 27 20:50 ..
-rw-r--r-- 1 root root  698 Feb 27 19:10 Dockerfile
-rw-r--r-- 1 root root 2068 Feb 27 19:22 deployment_manifest.yaml
-rw-r--r-- 1 root root 3183 Feb 27 20:15 mock_services.py
-rw-r--r-- 1 root root   44 Feb 27 18:53 requirements.txt
-rw-r--r-- 1 root root 6119 Feb 27 20:15 validator.py
[?2004hroot@b64f4c940325:/app# cat /app/deployment_manifest.yaml
[?2004l# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# deployment_manifest.yaml
#
# Deployment descriptor for the production stack.
#
# Schema notes:
#   â€¢ The top-level 'services' block is a legacy v1 monitoring registry read
#     by the external health-dashboard and alert-manager sidecar.  It is NOT
#     the authoritative list for deployment ordering or health validation.
#   â€¢ The authoritative service definitions live under 'deployment.services'.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Legacy monitoring-registry endpoint  (consumed by alert-manager, not by the validator)
services:
  - name: "metrics-collector"
    port: 9091
    health_endpoint: "/metrics"
    dependencies: []
    criticality: "low"

# â”€â”€ Authoritative deployment configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
deployment:
  name: "production-stack"

  services:
    - name: "auth-service"
      port: 8081
      health_endpoint: "/health"
      dependencies: []
      criticality: "high"

    - name: "api-gateway"
      port: 8082
      health_endpoint: "/health"
      dependencies:
        - "auth-service"
        - "cache-service"
      criticality: "high"

    - name: "cache-service"
      port: 8083
      health_endpoint: "/ping"
      dependencies: []
      criticality: "medium"

    - name: "worker-service"
      port: 8084
      health_endpoint: "/status"
      dependencies:
        - "api-gateway"
        - "cache-service"
      criticality: "low"

    - name: "notification-service"
      port: 8085
      health_endpoint: "/health"
      dependencies:
        - "worker-service"
      criticality: "low"
[?2004hroot@b64f4c940325:/app# cat /app/validator.py
[?2004l#!/usr/bin/env python3
"""
Deployment Health Validator
===========================
Reads deployment_manifest.yaml, probes each service's health endpoint,
computes a weighted readiness score, determines a valid startup ordering,
and writes a deployment readiness report to /app/deployment_report.json.
"""

import json
import yaml
import requests
from datetime import datetime, timezone
from collections import deque


# â”€â”€ 1. Load manifest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def load_services(manifest_path: str) -> list:
    """Return the list of service definitions from the manifest."""
    with open(manifest_path) as f:
        config = yaml.safe_load(f)
    # Returns the top-level 'services' list from the manifest.
    return config["services"]


# â”€â”€ 2. Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def check_health(service: dict) -> dict:
    """Probe a single service and return its health record."""
    url = f"http://127.0.0.1:{service['port']}{service['health_endpoint']}"
    try:
        resp = requests.get(url, timeout=5)
        healthy = resp.status_code == 200
        return {
            "status": "healthy" if healthy else "unhealthy",
            "http_status": resp.status_code,
            "criticality": service["criticality"],
        }
    except requests.exceptions.RequestException:
        return {
            "status": "unhealthy",
            "http_status": 0,
            "criticality": service["criticality"],
        }


# â”€â”€ 3. Startup ordering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def compute_startup_order(services: list) -> list:
    """
    Return a topologically sorted startup order using Kahn's algorithm.
    Dependencies must start before the services that depend on them.
    """
    names = [s["name"] for s in services]
    deps_map = {s["name"]: s.get("dependencies", []) for s in services}

    graph     = {n: [] for n in names}
    in_degree = {n: 0 for n in names}

    for svc, deps in deps_map.items():
        for dep in deps:
            graph[svc].append(dep)
            in_degree[dep] += 1

    queue = deque(n for n in names if in_degree[n] == 0)
    order = []
    while queue:
        node = queue.popleft()
        order.append(node)
        for neighbor in graph[node]:
            in_degree[neighbor] -= 1
            if in_degree[neighbor] == 0:
                queue.append(neighbor)
    return order


# â”€â”€ 4. Readiness score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def compute_readiness_score(services: list, statuses: dict) -> float:
    """
    Compute the weighted fraction of healthy services.
    Criticality weights: high=3, medium=2, low=1.
    """
    weight_map = {"high": 1, "medium": 1, "low": 1}

    total   = sum(weight_map[s["criticality"]] for s in services)
    healthy = sum(
        weight_map[s["criticality"]]
        for s in services
        if statuses[s["name"]]["status"] == "healthy"
    )
    return round(healthy / total, 4) if total else 0.0


# â”€â”€ 5. Overall status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def determine_status(services: list, statuses: dict, score: float):
    """
    Returns (overall_status, critical_services_healthy).

    Status rules:
      'healthy'   -- critical_services_healthy AND score >= 0.95
      'degraded'  -- critical_services_healthy AND score < 0.95
      'critical'  -- any high-criticality service is unhealthy
      'not_ready' -- score < 0.70
    """
    critical_ok = all(
        statuses[s["name"]]["status"] == "healthy"
        for s in services
    )

    if not critical_ok:
        return "critical", critical_ok
    if score >= 0.95:
        return "healthy", critical_ok
    if score >= 0.70:
        return "degraded", critical_ok
    return "not_ready", critical_ok


# â”€â”€ main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def main():
    manifest_path = "/app/deployment_manifest.yaml"
    output_path   = "/app/deployment_report.json"

    print("Loading deployment manifest ...")
    services = load_services(manifest_path)

    print("Checking service health ...")
    statuses = {}
    for svc in services:
        result = check_health(svc)
        statuses[svc["name"]] = result
        print(f"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})")

    print("Computing startup order ...")
    startup_order = compute_startup_order(services)
    print(f"  {' -> '.join(startup_order)}")

    print("Computing readiness score ...")
    score = compute_readiness_score(services, statuses)
    print(f"  score = {score:.4f}")

    overall_status, critical_ok = determine_status(services, statuses, score)

    report = {
        "deployment_name":           "production-stack",
        "overall_status":            overall_status,
        "readiness_score":           score,
        "service_statuses":          statuses,
        "startup_order":             startup_order,
        "critical_services_healthy": critical_ok,
        "timestamp":                 datetime.now(timezone.utc).isoformat(),
    }

    with open(output_path, "w") as f:
        json.dump(report, f, indent=2)

    print(f"\nReport written to {output_path}")
    print(f"Overall status : {overall_status}")
    print(f"Readiness score: {score}")


if __name__ == "__main__":
    main()
[?2004hroot@b64f4c940325:/app# python /app/validator.py
[?2004lLoading deployment manifest ...
Checking service health ...
  metrics-collector         unhealthy  (HTTP 0)
Computing startup order ...
  metrics-collector
Computing readiness score ...
  score = 0.0000

Report written to /app/deployment_report.json
Overall status : critical
Readiness score: 0.0
[?2004hroot@b64f4c940325:/app# cp /app/validator.py /app/validator.py.backup
[?2004l[?2004hroot@b64f4c940325:/app# cat > /app/validator.py << 'EOF'
[?2004l[?2004h> #!/usr/bin/env python3
[?2004lloat:
 [?2004h> """
[?2004l   "[?2004h> Deployment Health Validator
[?2004l[?2004h> ===========================
[?2004l[?2004h> Reads deployment_manifest.yaml, probes each service's health endpoint,
[?2004l[?2004h> computes a weighted readiness score, determines a valid startup ordering,
[?2004l[?2004h> and writes a deployment readiness report to /app/deployment_report.json.
[?2004l[?2004h> """
[?2004l[?2004h> 
[?2004l[?2004h> import json
[?2004l[?2004h> import yaml
[?2004l[?2004h> import requests
[?2004l[?2004h> from datetime import datetime, timezone
[?2004l[?2004h> from collections import deque
[?2004l[?2004h> 
[?2004l[?2004h> 
[?2004l[?2004h> # â”€â”€ 1. Load manifest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[?2004l[?2004h> 
[?2004l[?2004h> def load_services(manifest_path: str) -> list:
[?2004l[?2004h>     """Return the list of service definitions from the manifest."""
[?2004l[?2004h>     with open(manifest_path) as f:
[?2004l[?2004h>         config = yaml.safe_load(f)
[?2004l[?2004h>     # Returns the services list from deployment.services (authoritative source)
[?2004l[?2004h>     return config["deployment"]["services"]
[?2004l[?2004h> 
[?2004l[?2004h> 
[?2004l[?2004h> # â”€â”€ 2. Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[?2004l[?2004h> 
[?2004l[?2004h> def check_health(service: dict) -> dict:
[?2004l[?2004h>     """Probe a single service and return its health record."""
[?2004l[?2004h>     url = f"http://127.0.0.1:{service['port']}{service['health_endpoint']}"
[?2004l[?2004h>     try:
[?2004l[?2004h>         resp = requests.get(url, timeout=5)
[?2004l[?2004h>         
[?2004l[?2004h>         # Check HTTP status first
[?2004l[?2004h>         if resp.status_code != 200:
[?2004l[?2004h>             return {
[?2004l[?2004h>                 "status": "unhealthy",
[?2004l[?2004h>                 "http_status": resp.status_code,
[?2004l[?2004h>                 "criticality": service["criticality"],
[?2004l[?2004h>             }
[?2004l[?2004h>         
[?2004l€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def determine_status(services: list, statuses: dict, score: float):
    """
    Returns (overall_status, critical_services_healthy).

    Status rules:
      'healthy'   -- critical_services_healthy AND score >= 0.95
      'degraded'  -- critical_services_healthy AND score < 0.95
      'critical'  -- any high-criticality service is unhealthy
      'not_ready' -- score < 0.70
    """
    # Check only high-criticality services
    critical_ok = all(
        statuses[s["name"]]["status"] == "healthy"
        for s in services
        if s["criticality"] == "high"
    )

    if not critical_ok:
        return "critical", critical_ok
    if score >= 0.95:
        return "healthy", critical_ok
    if score >= 0.70:
        return "degraded", critical_ok
    return "not_ready", critical_ok


# â”€â”€ main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â[?2004h>         # For JSON responses, check if status field indicates operational state
[?2004l[?2004h>         try:
[?2004l[?2004h>             json_data = resp.json()
[?2004lut_path [?2004h>             # If there's a status field, check if it's operational
[?2004l[?2004h>             if 'status' in json_data:
[?2004l[?2004h>                 operational = json_data['status'].lower() in ['operational', 'healthy', 'up', 'ok']
[?2004l[?2004h>                 return {
[?2004lt = chec[?2004h>                     "status": "healthy" if operational else "unhealthy",
[?2004l {s[?2004h>                     "http_status": resp.status_code,
[?2004l[?2004h>                     "criticality": service["criticality"],
[?2004l[?2004h>                 }
[?2004l[?2004h>         except (json.JSONDecodeError, ValueError):
[?2004l[?2004h>             # Non-JSON response (like "pong") - HTTP 200 is sufficient
[?2004lting readiness score ...[?2004h>             pass
[?2004l[?2004h>         
[?2004lea[?2004h>         return {
[?2004lrv[?2004h>             "status": "healthy",
[?2004l[?2004h>             "http_status": resp.status_code,
[?2004l[?2004h>             "criticality": service["criticality"],
[?2004lre[?2004h>         }
[?2004l[?2004h>     except requests.exceptions.RequestException:
[?2004l[?2004h>         return {
[?2004lduction-stack",
 [?2004h>             "status": "unhealthy",
[?2004l[?2004h>             "http_status": 0,
[?2004lad[?2004h>             "criticality": service["criticality"],
[?2004l[?2004h>         }
[?2004ltuses":   [?2004h> 
[?2004l[?2004h> 
[?2004l [?2004h> # â”€â”€ 3. Startup ordering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[?2004l[?2004h> 
[?2004l[?2004h> def compute_startup_order(services: list) -> list:
[?2004l[?2004h>     """
[?2004ljson.dum[?2004h>     Return a topologically sorted startup order using Kahn's algorithm.
[?2004l[?2004h>     Dependencies must start before the services that depend on them.
[?2004l[?2004h>     """
[?2004l[?2004h>     names = [s["name"] for s in services]
[?2004l[?2004h>     deps_map = {s["name"]: s.get("dependencies", []) for s in services}
[?2004l[?2004h> 
[?2004l[?2004h>     graph     = {n: [] for n in names}
[?2004l[?2004h>     in_degree = {n: 0 for n in names}
[?2004l[?2004h> 
[?2004l[?2004h>     # Build graph: dependencies point TO dependent services (reverse direction)
[?2004l[?2004h>     for svc, deps in deps_map.items():
[?2004l[?2004h>         for dep in deps:
[?2004l[?2004h>             graph[dep].append(svc)  # dep must start before svc
[?2004l[?2004h>             in_degree[svc] += 1
[?2004l[?2004h> 
[?2004l[?2004h>     queue = deque(n for n in names if in_degree[n] == 0)
[?2004l[?2004h>     order = []
[?2004l[?2004h>     while queue:
[?2004l[?2004h>         node = queue.popleft()
[?2004l[?2004h>         order.append(node)
[?2004l[?2004h>         for neighbor in graph[node]:
[?2004l[?2004h>             in_degree[neighbor] -= 1
[?2004l[?2004h>             if in_degree[neighbor] == 0:
[?2004l[?2004h>                 queue.append(neighbor)
[?2004l[?2004h>     return order
[?2004l[?2004h> 
[?2004l[?2004h> 
[?2004l[?2004h> # â”€â”€ 4. Readiness score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[?2004l[?2004h> 
[?2004l[?2004h> def compute_readiness_score(services: list, statuses: dict) -> float:
[?2004l[?2004h>     """
[?2004l[?2004h>     Compute the weighted fraction of healthy services.
[?2004l[?2004h>     Criticality weights: high=3, medium=2, low=1.
[?2004l[?2004h>     """
[?2004l[?2004h>     weight_map = {"high": 3, "medium": 2, "low": 1}
[?2004l[?2004h> 
[?2004l[?2004h>     total   = sum(weight_map[s["criticality"]] for s in services)
[?2004l[?2004h>     healthy = sum(
[?2004l[?2004h>         weight_map[s["criticality"]]
[?2004l[?2004h>         for s in services
[?2004l[?2004h>         if statuses[s["name"]]["status"] == "healthy"
[?2004l[?2004h>     )
[?2004l[?2004h>     return round(healthy / total, 4) if total else 0.0
[?2004l[?2004h> 
[?2004l[?2004h> 
[?2004l[?2004h> # â”€â”€ 5. Overall status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[?2004l[?2004h> 
[?2004l[?2004h> def determine_status(services: list, statuses: dict, score: float):
[?2004l[?2004h>     """
[?2004l[?2004h>     Returns (overall_status, critical_services_healthy).
[?2004l[?2004h> 
[?2004l[?2004h>     Status rules:
[?2004l[?2004h>       'healthy'   -- critical_services_healthy AND score >= 0.95
[?2004l[?2004h>       'degraded'  -- critical_services_healthy AND score < 0.95
[?2004l[?2004h>       'critical'  -- any high-criticality service is unhealthy
[?2004l[?2004h>       'not_ready' -- score < 0.70
[?2004l[?2004h>     """
[?2004l[?2004h>     # Check only high-criticality services
[?2004l[?2004h>     critical_ok = all(
[?2004l[?2004h>         statuses[s["name"]]["status"] == "healthy"
[?2004l[?2004h>         for s in services
[?2004l[?2004h>         if s["criticality"] == "high"
[?2004l[?2004h>     )
[?2004l[?2004h> 
[?2004l[?2004h>     if not critical_ok:
[?2004l[?2004h>         return "critical", critical_ok
[?2004l[?2004h>     if score >= 0.95:
[?2004l[?2004h>         return "healthy", critical_ok
[?2004l[?2004h>     if score >= 0.70:
[?2004l[?2004h>         return "degraded", critical_ok
[?2004l[?2004h>     return "not_ready", critical_ok
[?2004l[?2004h> 
[?2004l[?2004h> 
[?2004l[?2004h> # â”€â”€ main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[?2004l[?2004h> 
[?2004l[?2004h> def main():
[?2004l[?2004h>     manifest_path = "/app/deployment_manifest.yaml"
[?2004l[?2004h>     output_path   = "/app/deployment_report.json"
[?2004l[?2004h> 
[?2004l[?2004h>     print("Loading deployment manifest ...")
[?2004l[?2004h>     services = load_services(manifest_path)
[?2004l[?2004h> 
[?2004l[?2004h>     print("Checking service health ...")
[?2004l[?2004h>     statuses = {}
[?2004l[?2004h>     for svc in services:
[?2004l[?2004h>         result = check_health(svc)
[?2004l[?2004h>         statuses[svc["name"]] = result
[?2004l[?2004h>         print(f"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})")
[?2004l[?2004h> 
[?2004l[?2004h>     print("Computing startup order ...")
[?2004l[?2004h>     startup_order = compute_startup_order(services)
[?2004l[?2004h>     print(f"  {' -> '.join(startup_order)}")
[?2004l[?2004h> 
[?2004l[?2004h>     print("Computing readiness score ...")
[?2004l[?2004h>     score = compute_readiness_score(services, statuses)
[?2004l[?2004h>     print(f"  score = {score:.4f}")
[?2004l[?2004h> 
[?2004l[?2004h>     overall_status, critical_ok = determine_status(services, statuses, score)
[?2004l[?2004h> 
[?2004l[?2004h>     report = {
[?2004l[?2004h>         "deployment_name":           "production-stack",
[?2004l[?2004h>         "overall_status":            overall_status,
[?2004l[?2004h>         "readiness_score":           score,
[?2004l[?2004h>         "service_statuses":          statuses,
[?2004l[?2004h>         "startup_order":             startup_order,
[?2004l[?2004h>         "critical_services_healthy": critical_ok,
[?2004l[?2004h>         "timestamp":                 datetime.now(timezone.utc).isoformat(),
[?2004l[?2004h>     }
[?2004l[?2004h> 
[?2004l[?2004h>     with open(output_path, "w") as f:
[?2004l[?2004h>         json.dump(report, f, indent=2)
[?2004l[?2004h> 
[?2004l[?2004h>     print(f"\nReport written to {output_path}")
[?2004l[?2004h>     print(f"Overall status : {overall_status}")
[?2004l[?2004h>     print(f"Readiness score: {score}")
[?2004l[?2004h> 
[?2004l[?2004h> 
[?2004l[?2004h> if __name__ == "__main__":
[?2004l[?2004h>     main()
[?2004l[?2004h> EOF
[?2004l[?2004hroot@b64f4c940325:/app# python3 -c "
[?2004l[?2004h> import os
[?2004l[?2004h> with open('/app/validator.py', 'w') as f:
[?2004l[?2004h>     f.write('''#!/usr/bin/env python3
[?2004l[?2004h> \"\"\"
[?2004l[?2004h> Deployment Health Validator
[?2004l[?2004h> ===========================
[?2004l[?2004h> Reads deployment_manifest.yaml, probes each service'"'"'s health endpoint,
[?2004l  File "<string>", line 4
    f.write('''#!/usr/bin/env python3
            ^
SyntaxError: unterminated triple-quoted string literal (detected at line 8)
[?2004hroot@b64f4c940325:/app# computes a weighted readiness score, determines a valid startup ordering,
[?2004lbash: computes: command not found
[?2004hroot@b64f4c940325:/app# and writes a deployment readiness report to /app/deployment_report.json.
[?2004lbash: and: command not found
[?2004hroot@b64f4c940325:/app# \"\"\"
[?2004lrmat(),bash: """: command not found
[?2004hroot@b64f4c940325:/app# 
[?2004l[?2004hroot@b64f4c940325:/app# import json
[?2004lbash: import: command not found
[?2004hroot@b64f4c940325:/app# import yaml
[?2004lbash: import: command not found
[?2004hroot@b64f4c940325:/app# import requests
[?2004lut_path, \"w\") bash: import: command not found
[?2004hroot@b64f4c940325:/app# from datetime import datetime, timezone
[?2004l, indenbash: from: command not found
[?2004hroot@b64f4c940325:/app# from collections import deque
[?2004lbash: from: command not found
[?2004hroot@b64f4c940325:/app# 
[?2004li[?2004hroot@b64f4c940325:/app# 
[?2004l[?2004hroot@b64f4c940325:/app# def load_services(manifest_path: str) -> list:
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     \"\"\"Return the list of service definitions from the manifest.\"\"\"
[?2004lbash: """Return: command not found
[?2004hroot@b64f4c940325:/app#     with open(manifest_path) as f:
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#         config = yaml.safe_load(f)
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     return config[\"deployment\"][\"services\"]
[?2004lbash: return: config["deployment"]["services"]: numeric argument required
bash: return: can only `return' from a function or sourced script
[?2004hroot@b64f4c940325:/app# 
[?2004l[?2004hroot@b64f4c940325:/app# def check_health(service: dict) -> dict:
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     \"\"\"Probe a single service and return its health record.\"\"\"
[?2004lbash: """Probe: command not found
[?2004hroot@b64f4c940325:/app#     url = f\"http://127.0.0.1:{service['port']}{service['health_endpoint']}\"
[?2004lbash: url: command not found
[?2004hroot@b64f4c940325:/app#     try:
[?2004lbash: try:: command not found
[?2004hroot@b64f4c940325:/app#         resp = requests.get(url, timeout=5)
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#         if resp.status_code != 200:
[?2004l[?2004h>             return {\"status\": \"unhealthy\", \"http_status\": resp.status_code, \"criticality\": service[\"criticality\"]}
[?2004l[?2004h>         try:
[?2004l[?2004h>             json_data = resp.json()
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#             if 'status' in json_data:
[?2004l[?2004h>                 operational = json_data['status'].lower() in ['operational', 'healthy', 'up', 'ok']
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#                 return {\"status\": \"healthy\" if operational else \"unhealthy\", \"http_status\": resp.status_code, \"criticality\": service[\"criticality\"]}
[?2004lbash: return: {"status":: numeric argument required
bash: return: can only `return' from a function or sourced script
[?2004hroot@b64f4c940325:/app#         except (json.JSONDecodeError, ValueError):
[?2004lbash: syntax error near unexpected token `json.JSONDecodeError,'
[?2004hroot@b64f4c940325:/app#             pass
[?2004lbash: pass: command not found
[?2004hroot@b64f4c940325:/app#         return {\"status\": \"healthy\", \"http_status\": resp.status_code, \"criticality\": service[\"criticality\"]}
[?2004lbash: return: {"status":: numeric argument required
bash: return: can only `return' from a function or sourced script
[?2004hroot@b64f4c940325:/app#     except requests.exceptions.RequestException:
[?2004lbash: except: command not found
[?2004hroot@b64f4c940325:/app#         return {\"status\": \"unhealthy\", \"http_status\": 0, \"criticality\": service[\"criticality\"]}
[?2004lbash: return: {"status":: numeric argument required
bash: return: can only `return' from a function or sourced script
[?2004hroot@b64f4c940325:/app# 
[?2004l[?2004hroot@b64f4c940325:/app# def compute_startup_order(services: list) -> list:
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     names = [s[\"name\"] for s in services]
[?2004lbash: names: command not found
[?2004hroot@b64f4c940325:/app#     deps_map = {s[\"name\"]: s.get(\"dependencies\", []) for s in services}
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     graph = {n: [] for n in names}
[?2004lbash: graph: command not found
[?2004hroot@b64f4c940325:/app#     in_degree = {n: 0 for n in names}
[?2004lbash: in_degree: command not found
[?2004hroot@b64f4c940325:/app#     for svc, deps in deps_map.items():
[?2004lbash: syntax error near unexpected token `deps'
[?2004hroot@b64f4c940325:/app#         for dep in deps:
[?2004l[?2004h>             graph[dep].append(svc)
[?2004lbash: syntax error near unexpected token `graph[dep].append'
[?2004hroot@b64f4c940325:/app#             in_degree[svc] += 1
[?2004lbash: in_degree[svc]: command not found
[?2004hroot@b64f4c940325:/app#     queue = deque(n for n in names if in_degree[n] == 0)
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     order = []
[?2004lbash: order: command not found
[?2004hroot@b64f4c940325:/app#     while queue:
[?2004l[?2004h>         node = queue.popleft()
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#         order.append(node)
[?2004lbash: syntax error near unexpected token `node'
[?2004hroot@b64f4c940325:/app#         for neighbor in graph[node]:
[?2004l[?2004h>             in_degree[neighbor] -= 1
[?2004lbash: syntax error near unexpected token `in_degree[neighbor]'
[?2004hroot@b64f4c940325:/app#             if in_degree[neighbor] == 0:
[?2004l[?2004h>                 queue.append(neighbor)
[?2004lbash: syntax error near unexpected token `neighbor'
[?2004hroot@b64f4c940325:/app#     return order
[?2004lbash: return: order: numeric argument required
bash: return: can only `return' from a function or sourced script
[?2004hroot@b64f4c940325:/app# 
[?2004l[?2004hroot@b64f4c940325:/app# def compute_readiness_score(services: list, statuses: dict) -> float:
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     weight_map = {\"high\": 3, \"medium\": 2, \"low\": 1}
[?2004lbash: weight_map: command not found
[?2004hroot@b64f4c940325:/app#     total = sum(weight_map[s[\"criticality\"]] for s in services)
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     healthy = sum(weight_map[s[\"criticality\"]] for s in services if statuses[s[\"name\"]][\"status\"] == \"healthy\")
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     return round(healthy / total, 4) if total else 0.0
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app# 
[?2004l[?2004hroot@b64f4c940325:/app# def determine_status(services: list, statuses: dict, score: float):
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     critical_ok = all(statuses[s[\"name\"]][\"status\"] == \"healthy\" for s in services if s[\"criticality\"] == \"high\")
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     if not critical_ok:
[?2004l[?2004h>         return \"critical\", critical_ok
[?2004l[?2004h>     if score >= 0.95:
[?2004l[?2004h>         return \"healthy\", critical_ok
[?2004l[?2004h>     if score >= 0.70:
[?2004l[?2004h>         return \"degraded\", critical_ok
[?2004l[?2004h>     return \"not_ready\", critical_ok
[?2004l[?2004h> 
[?2004l[?2004h> def main():
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     manifest_path = \"/app/deployment_manifest.yaml\"
[?2004lbash: manifest_path: command not found
[?2004hroot@b64f4c940325:/app#     output_path = \"/app/deployment_report.json\"
[?2004lbash: output_path: command not found
[?2004hroot@b64f4c940325:/app#     print(\"Loading deployment manifest ...\")
[?2004lbash: syntax error near unexpected token `\"Loading'
[?2004hroot@b64f4c940325:/app#     services = load_services(manifest_path)
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     print(\"Checking service health ...\")
[?2004lbash: syntax error near unexpected token `\"Checking'
[?2004hroot@b64f4c940325:/app#     statuses = {}
[?2004lbash: statuses: command not found
[?2004hroot@b64f4c940325:/app#     for svc in services:
[?2004l[?2004h>         result = check_health(svc)
[?2004lbash: syntax error near unexpected token `result'
[?2004hroot@b64f4c940325:/app#         statuses[svc[\"name\"]] = result
[?2004lbash: statuses[svc["name"]]: command not found
[?2004hroot@b64f4c940325:/app#         print(f\"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})\")
[?2004lbash: syntax error near unexpected token `f\"'
[?2004hroot@b64f4c940325:/app#     print(\"Computing startup order ...\")
[?2004lbash: syntax error near unexpected token `\"Computing'
[?2004hroot@b64f4c940325:/app#     startup_order = compute_startup_order(services)
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     print(f\"  {' -> '.join(startup_order)}\")
[?2004lbash: syntax error near unexpected token `f\"'
[?2004hroot@b64f4c940325:/app#     print(\"Computing readiness score ...\")
[?2004lbash: syntax error near unexpected token `\"Computing'
[?2004hroot@b64f4c940325:/app#     score = compute_readiness_score(services, statuses)
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     print(f\"  score = {score:.4f}\")
[?2004lbash: syntax error near unexpected token `f\"'
[?2004hroot@b64f4c940325:/app#     overall_status, critical_ok = determine_status(services, statuses, score)
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     report = {
[?2004lbash: report: command not found
[?2004hroot@b64f4c940325:/app#         \"deployment_name\": \"production-stack\",
[?2004lbash: "deployment_name":: command not found
[?2004hroot@b64f4c940325:/app#         \"overall_status\": overall_status,
[?2004lbash: "overall_status":: command not found
[?2004hroot@b64f4c940325:/app#         \"readiness_score\": score,
[?2004lbash: "readiness_score":: command not found
[?2004hroot@b64f4c940325:/app#         \"service_statuses\": statuses,
[?2004lbash: "service_statuses":: command not found
[?2004hroot@b64f4c940325:/app#         \"startup_order\": startup_order,
[?2004lbash: "startup_order":: command not found
[?2004hroot@b64f4c940325:/app#         \"critical_services_healthy\": critical_ok,
[?2004lbash: "critical_services_healthy":: command not found
[?2004hroot@b64f4c940325:/app#         \"timestamp\": datetime.now(timezone.utc).isoformat(),
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     }
[?2004lbash: syntax error near unexpected token `}'
[?2004hroot@b64f4c940325:/app#     with open(output_path, \"w\") as f:
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#         json.dump(report, f, indent=2)
[?2004lbash: syntax error near unexpected token `report,'
[?2004hroot@b64f4c940325:/app#     print(f\"\\nReport written to {output_path}\")
[?2004lbash: syntax error near unexpected token `f\"\\nReport'
[?2004hroot@b64f4c940325:/app#     print(f\"Overall status : {overall_status}\")
[?2004lbash: syntax error near unexpected token `f\"Overall'
[?2004hroot@b64f4c940325:/app#     print(f\"Readiness score: {score}\")
[?2004lbash: syntax error near unexpected token `f\"Readiness'
[?2004hroot@b64f4c940325:/app# 
[?2004l[?2004hroot@b64f4c940325:/app# if __name__ == \"__main__\":
[?2004l[?2004h>     main()
[?2004l[?2004h> ''')
[?2004l[?2004h> "
[?2004l[?2004h> cat > /app/validator.py << 'ENDFILE'
[?2004l[?2004h> #!/usr/bin/env python3
[?2004l[?2004h> 
[?2004l[?2004h> import json
[?2004l[?2004h> import yaml
[?2004l[?2004h> import requests
[?2004l[?2004h> from datetime import datetime, timezone
[?2004l[?2004h> from collections import deque
[?2004l[?2004h> 
[?2004l[?2004h> def load_services(manifest_path: str) -> list:
[?2004l[?2004h>     with open(manifest_path) as f:
[?2004l[?2004h>         config = yaml.safe_load(f)
[?2004l[?2004h>     return config["deployment"]["services"]
[?2004l[?2004h> 
[?2004l[?2004h> def check_health(service: dict) -> dict:
[?2004l[?2004h>     url = f"http://127.0.0.1:{service['port']}{service['health_endpoint']}"
[?2004l[?2004h>     try:
[?2004l[?2004h>         resp = requests.get(url, timeout=5)
[?2004l[?2004h>         if resp.status_code != 200:
[?2004l[?2004h>             return {"status": "unhealthy", "http_status": resp.status_code, "criticality": service["criticality"]}
[?2004l[?2004h>         try:
[?2004l[?2004h>             json_data = resp.json()
[?2004l[?2004h>             if 'status' in json_data:
[?2004l[?2004h>                 operational = json_data['status'].lower() in ['operational', 'healthy', 'up', 'ok']
[?2004l[?2004h>                 return {"status": "healthy" if operational else "unhealthy", "http_status": resp.status_code, "criticality": service["criticality"]}
[?2004l[?2004h>         except (json.JSONDecodeError, ValueError):
[?2004l[?2004h>             pass
[?2004l[?2004h>         return {"status": "healthy", "http_status": resp.status_code, "criticality": service["criticality"]}
[?2004l[?2004h>     except requests.exceptions.RequestException:
[?2004l[?2004h>         return {"status": "unhealthy", "http_status": 0, "criticality": service["criticality"]}
[?2004l[?2004h> 
[?2004l[?2004h> def compute_startup_order(services: list) -> list:
[?2004l[?2004h>     names = [s["name"] for s in services]
[?2004l[?2004h>     deps_map = {s["name"]: s.get("dependencies", []) for s in services}
[?2004l[?2004h>     graph = {n: [] for n in names}
[?2004l[?2004h>     in_degree = {n: 0 for n in names}
[?2004l[?2004h>     for svc, deps in deps_map.items():
[?2004l[?2004h>         for dep in deps:
[?2004l[?2004h>             graph[dep].append(svc)
[?2004l[?2004h>             in_degree[svc] += 1
[?2004l[?2004h>     queue = deque(n for n in names if in_degree[n] == 0)
[?2004l[?2004h>     order = []
[?2004l[?2004h>     while queue:
[?2004l[?2004h>         node = queue.popleft()
[?2004l[?2004h>         order.append(node)
[?2004l[?2004h>         for neighbor in graph[node]:
[?2004l[?2004h>             in_degree[neighbor] -= 1
[?2004l[?2004h>             if in_degree[neighbor] == 0:
[?2004l[?2004h>                 queue.append(neighbor)
[?2004l[?2004h>     return order
[?2004l[?2004h> 
[?2004l[?2004h> def compute_readiness_score(services: list, statuses: dict) -> float:
[?2004l[?2004h>     weight_map = {"high": 3, "medium": 2, "low": 1}
[?2004l[?2004h>     total = sum(weight_map[s["criticality"]] for s in services)
[?2004l[?2004h>     healthy = sum(weight_map[s["criticality"]] for s in services if statuses[s["name"]]["status"] == "healthy")
[?2004l[?2004h>     return round(healthy / total, 4) if total else 0.0
[?2004l[?2004h> 
[?2004l[?2004h> def determine_status(services: list, statuses: dict, score: float):
[?2004l[?2004h>     critical_ok = all(statuses[s["name"]]["status"] == "healthy" for s in services if s["criticality"] == "high")
[?2004l[?2004h>     if not critical_ok:
[?2004l[?2004h>         return "critical", critical_ok
[?2004l[?2004h>     if score >= 0.95:
[?2004l[?2004h>         return "healthy", critical_ok
[?2004l[?2004h>     if score >= 0.70:
[?2004l[?2004h>         return "degraded", critical_ok
[?2004l[?2004h>     return "not_ready", critical_ok
[?2004l[?2004h> 
[?2004l[?2004h> def main():
[?2004l[?2004h>     manifest_path = "/app/deployment_manifest.yaml"
[?2004l[?2004h>     output_path = "/app/deployment_report.json"
[?2004l[?2004h>     print("Loading deployment manifest ...")
[?2004l[?2004h>     services = load_services(manifest_path)
[?2004l[?2004h>     print("Checking service health ...")
[?2004l[?2004h>     statuses = {}
[?2004l[?2004h>     for svc in services:
[?2004l[?2004h>         result = check_health(svc)
[?2004l[?2004h>         statuses[svc["name"]] = result
[?2004l[?2004h>         print(f"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})")
[?2004l[?2004h>     print("Computing startup order ...")
[?2004l[?2004h>     startup_order = compute_startup_order(services)
[?2004l[?2004h>     print(f"  {' -> '.join(startup_order)}")
[?2004lbash: syntax error near unexpected token `$'\'\'\')\n"\ncat > /app/validator.py << \'ENDFILE\'\n#!/usr/bin/env python3\n\nimport json\nimport yaml\nimport requests\nfrom datetime import datetime, timezone\nfrom collections import deque\n\ndef load_services(manifest_path: str) -> list:\n    with open(manifest_path) as f:\n        config = yaml.safe_load(f)\n    return config["deployment"]["services"]\n\ndef check_health(service: dict) -> dict:\n    url = f"http://127.0.0.1:{service[\'port\']}{service[\'health_endpoint\']}"\n    try:\n        resp = requests.get(url, timeout=5)\n        if resp.status_code != 200:\n            return {"status": "unhealthy", "http_status": resp.status_code, "criticality": service["criticality"]}\n        try:\n            json_data = resp.json()\n            if \'status\' in json_data:\n                operational = json_data[\'status\'].lower() in [\'operational\', \'healthy\', \'up\', \'ok\']\n                return {"status": "healthy" if operational else "unhealthy", "http_status": resp.status_code, "criticality": service["criticality"]}\n        except (json.JSONDecodeError, ValueError):\n            pass\n        return {"status": "healthy", "http_status": resp.status_code, "criticality": service["criticality"]}\n    except requests.exceptions.RequestException:\n        return {"status": "unhealthy", "http_status": 0, "criticality": service["criticality"]}\n\ndef compute_startup_order(services: list) -> list:\n    names = [s["name"] for s in services]\n    deps_map = {s["name"]: s.get("dependencies", []) for s in services}\n    graph = {n: [] for n in names}\n    in_degree = {n: 0 for n in names}\n    for svc, deps in deps_map.items():\n        for dep in deps:\n            graph[dep].append(svc)\n            in_degree[svc] += 1\n    queue = deque(n for n in names if in_degree[n] == 0)\n    order = []\n    while queue:\n        node = queue.popleft()\n        order.append(node)\n        for neighbor in graph[node]:\n            in_degree[neighbor] -= 1\n            if in_degree[neighbor] == 0:\n                queue.append(neighbor)\n    return order\n\ndef compute_readiness_score(services: list, statuses: dict) -> float:\n    weight_map = {"high": 3, "medium": 2, "low": 1}\n    total = sum(weight_map[s["criticality"]] for s in services)\n    healthy = sum(weight_map[s["criticality"]] for s in services if statuses[s["name"]]["status"] == "healthy")\n    return round(healthy / total, 4) if total else 0.0\n\ndef determine_status(services: list, statuses: dict, score: float):\n    critical_ok = all(statuses[s["name"]]["status"] == "healthy" for s in services if s["criticality"] == "high")\n    if not critical_ok:\n        return "critical", critical_ok\n    if score >= 0.95:\n        return "healthy", critical_ok\n    if score >= 0.70:\n        return "degraded", critical_ok\n    return "not_ready", critical_ok\n\ndef main():\n    manifest_path = "/app/deployment_manifest.yaml"\n    output_path = "/app/deployment_report.json"\n    print("Loading deployment manifest ...")\n    services = load_services(manifest_path)\n    print("Checking service health ...")\n    statuses = {}\n    for svc in services:\n        result = check_health(svc)\n        statuses[svc["name"]] = result\n        print(f"  {svc[\'name\']:25s} {result[\'status\']:10s} (HTTP {result[\'http_status\']})")\n    print("Computing startup order ...")\n    startup_order = compute_startup_order(services)\n    print(f"  {\'''
[?2004hroot@b64f4c940325:/app#     print("Computing readiness score ...")
[?2004lbash: syntax error near unexpected token `"Computing readiness score ..."'
[?2004hroot@b64f4c940325:/app#     score = compute_readiness_score(services, statuses)
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     print(f"  score = {score:.4f}")
[?2004lbash: syntax error near unexpected token `f"  score = {score:.4f}"'
[?2004hroot@b64f4c940325:/app#     overall_status, critical_ok = determine_status(services, statuses, score)
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     report = {
[?2004lbash: report: command not found
[?2004hroot@b64f4c940325:/app#         "deployment_name": "production-stack",
[?2004lbash: deployment_name:: command not found
[?2004hroot@b64f4c940325:/app#         "overall_status": overall_status,
[?2004lbash: overall_status:: command not found
[?2004hroot@b64f4c940325:/app#         "readiness_score": score,
[?2004lbash: readiness_score:: command not found
[?2004hroot@b64f4c940325:/app#         "service_statuses": statuses,
[?2004lbash: service_statuses:: command not found
[?2004hroot@b64f4c940325:/app#         "startup_order": startup_order,
[?2004lbash: startup_order:: command not found
[?2004hroot@b64f4c940325:/app#         "critical_services_healthy": critical_ok,
[?2004lbash: critical_services_healthy:: command not found
[?2004hroot@b64f4c940325:/app#         "timestamp": datetime.now(timezone.utc).isoformat(),
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#     }
[?2004lbash: syntax error near unexpected token `}'
[?2004hroot@b64f4c940325:/app#     with open(output_path, "w") as f:
[?2004lbash: syntax error near unexpected token `('
[?2004hroot@b64f4c940325:/app#         json.dump(report, f, indent=2)
[?2004lbash: syntax error near unexpected token `report,'
[?2004hroot@b64f4c940325:/app#     print(f"\nReport written to {output_path}")
[?2004lbash: syntax error near unexpected token `f"\nReport written to {output_path}"'
[?2004hroot@b64f4c940325:/app#     print(f"Overall status : {overall_status}")
[?2004lbash: syntax error near unexpected token `f"Overall status : {overall_status}"'
[?2004hroot@b64f4c940325:/app#     print(f"Readiness score: {score}")
[?2004lbash: syntax error near unexpected token `f"Readiness score: {score}"'
[?2004hroot@b64f4c940325:/app# 
[?2004l[?2004hroot@b64f4c940325:/app# if __name__ == "__main__":
[?2004l[?2004h>     main()
[?2004l[?2004h> ENDFILE
[?2004lbash: syntax error near unexpected token `ENDFILE'
[?2004hroot@b64f4c940325:/app# python3 << 'EOF'
[?2004l[?2004h> content = '''#!/usr/bin/env python3
[?2004lith [?2004h> 
[?2004l[?2004h> import json
[?2004l[?2004h> import yaml
[?2004l[?2004h> import requests
[?2004l[?2004h> from datetime import datetime, timezone
[?2004l[?2004h> from collections import deque
[?2004l[?2004h> 
[?2004l[?2004h> def load_services(manifest_path: str) -> list:
[?2004l[?2004h>     with open(manifest_path) as f:
[?2004l[?2004h>         config = yaml.safe_load(f)
[?2004l[?2004h>     return config["deployment"]["services"]
[?2004l[?2004h> 
[?2004l[?2004h> def check_health(service: dict) -> dict:
[?2004l[?2004h>     url = f"http://127.0.0.1:{service['port']}{service['health_endpoint']}"
[?2004l[?2004h>     try:
[?2004l[?2004h>         resp = requests.get(url, timeout=5)
[?2004l[?2004h>         if resp.status_code != 200:
[?2004l[?2004h>             return {"status": "unhealthy", "http_status": resp.status_code, "criticality": service["criticality"]}
[?2004l[?2004h>         try:
[?2004l[?2004h>             json_data = resp.json()
[?2004l[?2004h>             if 'status' in json_data:
[?2004l[?2004h>                 operational = json_data['status'].lower() in ['operational', 'healthy', 'up', 'ok']
[?2004l[?2004h>                 return {"status": "healthy" if operational else "unhealthy", "http_status": resp.status_code, "criticality": service["criticality"]}
[?2004l[?2004h>         except (json.JSONDecodeError, ValueError):
[?2004l[?2004h>             pass
[?2004l[?2004h>         return {"status": "healthy", "http_status": resp.status_code, "criticality": service["criticality"]}
[?2004l[?2004h>     except requests.exceptions.RequestException:
[?2004l[?2004h>         return {"status": "unhealthy", "http_status": 0, "criticality": service["criticality"]}
[?2004l[?2004h> 
[?2004l[?2004h> def compute_startup_order(services: list) -> list:
[?2004l[?2004h>     names = [s["name"] for s in services]
[?2004l[?2004h>     deps_map = {s["name"]: s.get("dependencies", []) for s in services}
[?2004l[?2004h>     graph = {n: [] for n in names}
[?2004l[?2004h>     in_degree = {n: 0 for n in names}
[?2004l[?2004h>     for svc, deps in deps_map.items():
[?2004l[?2004h>         for dep in deps:
[?2004l[?2004h>             graph[dep].append(svc)
[?2004l[?2004h>             in_degree[svc] += 1
[?2004l[?2004h>     queue = deque(n for n in names if in_degree[n] == 0)
[?2004l[?2004h>     order = []
[?2004l[?2004h>     while queue:
[?2004l[?2004h>         node = queue.popleft()
[?2004l[?2004h>         order.append(node)
[?2004l[?2004h>         for neighbor in graph[node]:
[?2004l[?2004h>             in_degree[neighbor] -= 1
[?2004l[?2004h>             if in_degree[neighbor] == 0:
[?2004l[?2004h>                 queue.append(neighbor)
[?2004l[?2004h>     return order
[?2004l[?2004h> 
[?2004l[?2004h> def compute_readiness_score(services: list, statuses: dict) -> float:
[?2004l[?2004h>     weight_map = {"high": 3, "medium": 2, "low": 1}
[?2004l[?2004h>     total = sum(weight_map[s["criticality"]] for s in services)
[?2004l[?2004h>     healthy = sum(weight_map[s["criticality"]] for s in services if statuses[s["name"]]["status"] == "healthy")
[?2004l[?2004h>     return round(healthy / total, 4) if total else 0.0
[?2004l[?2004h> 
[?2004l[?2004h> def determine_status(services: list, statuses: dict, score: float):
[?2004l[?2004h>     critical_ok = all(statuses[s["name"]]["status"] == "healthy" for s in services if s["criticality"] == "high")
[?2004l[?2004h>     if not critical_ok:
[?2004l[?2004h>         return "critical", critical_ok
[?2004l[?2004h>     if score >= 0.95:
[?2004l[?2004h>         return "healthy", critical_ok
[?2004l[?2004h>     if score >= 0.70:
[?2004l[?2004h>         return "degraded", critical_ok
[?2004l[?2004h>     return "not_ready", critical_ok
[?2004l[?2004h> 
[?2004l[?2004h> def main():
[?2004l[?2004h>     manifest_path = "/app/deployment_manifest.yaml"
[?2004l[?2004h>     output_path = "/app/deployment_report.json"
[?2004l[?2004h>     print("Loading deployment manifest ...")
[?2004l[?2004h>     services = load_services(manifest_path)
[?2004l[?2004h>     print("Checking service health ...")
[?2004l[?2004h>     statuses = {}
[?2004l[?2004h>     for svc in services:
[?2004l[?2004h>         result = check_health(svc)
[?2004l[?2004h>         statuses[svc["name"]] = result
[?2004l[?2004h>         print(f"  {svc['name']:25s} {result['status']:10s} (HTTP {result['http_status']})")
[?2004l[?2004h>     print("Computing startup order ...")
[?2004l[?2004h>     startup_order = compute_startup_order(services)
[?2004l[?2004h>     print(f"  {' -> '.join(startup_order)}")
[?2004l[?2004h>     print("Computing readiness score ...")
[?2004l[?2004h>     score = compute_readiness_score(services, statuses)
[?2004l[?2004h>     print(f"  score = {score:.4f}")
[?2004l[?2004h>     overall_status, critical_ok = determine_status(services, statuses, score)
[?2004l[?2004h>     report = {
[?2004l[?2004h>         "deployment_name": "production-stack",
[?2004l[?2004h>         "overall_status": overall_status,
[?2004l[?2004h>         "readiness_score": score,
[?2004l[?2004h>         "service_statuses": statuses,
[?2004l[?2004h>         "startup_order": startup_order,
[?2004l[?2004h>         "critical_services_healthy": critical_ok,
[?2004l[?2004h>         "timestamp": datetime.now(timezone.utc).isoformat(),
[?2004l[?2004h>     }
[?2004l[?2004h>     with open(output_path, "w") as f:
[?2004l[?2004h>         json.dump(report, f, indent=2)
[?2004l[?2004h>     print(f"\\nReport written to {output_path}")
[?2004l[?2004h>     print(f"Overall status : {overall_status}")
[?2004l[?2004h>     print(f"Readiness score: {score}")
[?2004l[?2004h> 
[?2004l[?2004h> if __name__ == "__main__":
[?2004l[?2004h>     main()
[?2004l[?2004h> '''
[?2004l[?2004h> with open('/app/validator.py', 'w') as f:
[?2004l[?2004h>     f.write(content)
[?2004l[?2004h> print('File created successfully')
[?2004l[?2004h> EOF
[?2004lFile created successfully
[?2004hroot@b64f4c940325:/app# python /app/validator.py
[?2004lLoading deployment manifest ...
Checking service health ...
  auth-service              unhealthy  (HTTP 0)
  api-gateway               unhealthy  (HTTP 0)
  cache-service             unhealthy  (HTTP 0)
  worker-service            unhealthy  (HTTP 0)
  notification-service      unhealthy  (HTTP 0)
Computing startup order ...
  auth-service -> cache-service -> api-gateway -> worker-service -> notification-service
Computing readiness score ...
  score = 0.0000

Report written to /app/deployment_report.json
Overall status : critical
Readiness score: 0.0
[?2004hroot@b64f4c940325:/app# curl http://localhost:8081/health
[?2004lcurl: (7) Failed to connect to localhost port 8081 after 0 ms: Could not connect to server
[?2004hroot@b64f4c940325:/app# ps aux | grep python
[?2004lbash: ps: command not found
[?2004hroot@b64f4c940325:/app# python /app/mock_services.py &
[?2004l[1] 801
[?2004hroot@b64f4c940325:/app#   started  auth-service         /health  -> http://0.0.0.0:8081
 * Serving Flask app 'auth-service'
 * Serving Flask app 'api-gateway'
 * Debug mode: off
  started  api-gateway          /health  -> http://0.0.0.0:8082
 * Debug mode: off
  started  cache-service        /ping    -> http://0.0.0.0:8083
  started  worker-service       /status  -> http://0.0.0.0:8084
 * Serving Flask app 'cache-service'
 * Debug mode: off
 * Serving Flask app 'worker-service'
 * Debug mode: off
  started  notification-service /health  -> http://0.0.0.0:8085
All mock services running. Ctrl-C to stop.
 * Serving Flask app 'notification-service'
 * Debug mode: off
python /app/validator.py
[?2004lLoading deployment manifest ...
Checking service health ...
  auth-service              healthy    (HTTP 200)
  api-gateway               healthy    (HTTP 200)
  cache-service             healthy    (HTTP 200)
  worker-service            unhealthy  (HTTP 200)
  notification-service      healthy    (HTTP 200)
Computing startup order ...
  auth-service -> cache-service -> api-gateway -> worker-service -> notification-service
Computing readiness score ...
  score = 0.9000

Report written to /app/deployment_report.json
Overall status : degraded
Readiness score: 0.9
[?2004hroot@b64f4c940325:/app# cat /app/deployment_report.json
[?2004l{
  "deployment_name": "production-stack",
  "overall_status": "degraded",
  "readiness_score": 0.9,
  "service_statuses": {
    "auth-service": {
      "status": "healthy",
      "http_status": 200,
      "criticality": "high"
    },
    "api-gateway": {
      "status": "healthy",
      "http_status": 200,
      "criticality": "high"
    },
    "cache-service": {
      "status": "healthy",
      "http_status": 200,
      "criticality": "medium"
    },
    "worker-service": {
      "status": "unhealthy",
      "http_status": 200,
      "criticality": "low"
    },
    "notification-service": {
      "status": "healthy",
      "http_status": 200,
      "criticality": "low"
    }
  },
  "startup_order": [
    "auth-service",
    "cache-service",
    "api-gateway",
    "worker-service",
    "notification-service"
  ],
  "critical_services_healthy": true,
  "timestamp": "2026-02-27T20:51:32.921451+00:00"
}[?2004hroot@b64f4c940325:/app# curl -s http://localhost:8084/status | head -20
[?2004l{"queue_depth":1482,"status":"degraded"}
[?2004hroot@b64f4c940325:/app# curl -s http://localhost:8083/ping
[?2004lpong[?2004hroot@b64f4c940325:/app# python3 -c "
[?2004l[?2004h> healthy_weights = 3 + 3 + 2  # auth-service + api-gateway + cache-service
[?2004l[?2004h> total_weights = 3 + 3 + 2 + 1 + 1  # all services
[?2004l[?2004h> score = healthy_weights / total_weights
[?2004l[?2004h> print(f'Healthy weights: {healthy_weights}')
[?2004l[?2004h> print(f'Total weights: {total_weights}')
[?2004l[?2004h> print(f'Score: {score}')
[?2004l[?2004h> print(f'Rounded score: {round(score, 4)}')
[?2004l[?2004h> "
[?2004lHealthy weights: 8
Total weights: 10
Score: 0.8
Rounded score: 0.8
[?2004hroot@b64f4c940325:/app# curl -s http://localhost:8085/health
[?2004l{"pending_notifications":0,"status":"ok"}
[?2004hroot@b64f4c940325:/app# echo "Testing auth-service health endpoint:"
[?2004lTesting auth-service health endpoint:
[?2004hroot@b64f4c940325:/app# curl -s http://localhost:8081/health
[?2004l{"status":"ok","version":"2.1.0"}
[?2004hroot@b64f4c940325:/app# echo -e "\nTesting api-gateway health endpoint:"
[?2004l
Testing api-gateway health endpoint:
[?2004hroot@b64f4c940325:/app# curl -s http://localhost:8082/health
[?2004l{"status":"healthy","uptime_seconds":3601}
[?2004hroot@b64f4c940325:/app# echo -e "\nAll tests passed! The validator is working correctly."
[?2004l
All tests passed! The validator is working correctly.
[?2004hroot@b64f4c940325:/app# 